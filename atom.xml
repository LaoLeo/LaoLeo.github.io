<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Unity游戏开发</title>
  <subtitle>“Work Smarter”</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://laoleo.github.io/"/>
  <updated>2022-12-17T14:04:08.684Z</updated>
  <id>https://laoleo.github.io/</id>
  
  <author>
    <name>Walking 劳翼</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SQLite替换lua配置表方案实现</title>
    <link href="https://laoleo.github.io/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/"/>
    <id>https://laoleo.github.io/2022/09/30/SQLite替换lua配置表方案实现/</id>
    <published>2022-09-29T16:00:00.000Z</published>
    <updated>2022-12-17T14:04:08.684Z</updated>
    
    <content type="html"><![CDATA[<!-- # SQLite替换lua配置表方案实现 -->
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前游戏中的配置数据实在启动时一次性全部加载进内存，这种方式会造成一定的浪费。而SQLite是一个轻量级的、动态连接的数据库引擎。</p>
<p>下文探索使用SQLite替换Lua配置表解决内存浪费方案的实现。</p>
<span id="more"></span>
<h2 id="splite库的编译与引入"><a href="#splite库的编译与引入" class="headerlink" title="splite库的编译与引入"></a>splite库的编译与引入</h2><p>两个方向：</p>
<p>1.C#层引入sqlite3.dll，写好接口，暴露给lua层调用。</p>
<p>sqlite3.dll引入：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/314242" title="https://cloud.tencent.com/developer/news/314242">https://cloud.tencent.com/developer/news/314242</a></p>
<p>2.lua层使用第三方库lsqlite3，将lsqlite3库编译进tolua.dll，在lua层直接链接并操作数据库。</p>
<p>如何将三方库编译进tolua：<a target="_blank" rel="noopener" href="https://blog.csdn.net/linxinfa/article/details/90046840。" title="https://blog.csdn.net/linxinfa/article/details/90046840。">https://blog.csdn.net/linxinfa/article/details/90046840。</a></p>
<p>这个方案代价是需要将各个平台的tolua动态库文件都编译一遍，将lsqlite3库包含进来。</p>
<p>有两个三方库文件可以使用：</p>
<p>1.lsqlite3：动态链接sqlite3（所以需要将sqlite3也编译进tolua）。</p>
<p>2.lsqlite3complete：包含sqlite3在内，静态链接sqlite3（不用再将sqlite3编译进tolua）。</p>
<h2 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h2><p>unity：2020.3.2f</p>
<p>真机：联想 拯救者2 pro/CPU晓龙888/内存8GB/Android 11</p>
<h3 id="1-堆内存对比"><a href="#1-堆内存对比" class="headerlink" title="1.堆内存对比"></a>1.堆内存对比</h3><table>
<thead>
<tr>
<th></th>
<th><strong>首次进入主界面</strong></th>
<th><strong>播放剧情</strong></th>
<th><strong>过一遍各个系统</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>lua配置表全加载</td>
<td>11.2MB</td>
<td>11.54MB</td>
<td>16.4MB</td>
</tr>
<tr>
<td>sqlite按需加载</td>
<td>9.2MB</td>
<td>9.45MB</td>
<td>15.69MB</td>
</tr>
</tbody>
</table>
<p>由于2020unity打的包真机上连不上profiler，所以以上数据在<strong>Editor</strong>用工具测试lua内存。</p>
<p>简单对比，sqlite按需加载配置方案在内存上比全加载lua配置表要<strong>节省内存。</strong> 理由可想而知，不必要的配置不用加载进内存。</p>
<h3 id="2-执行时间对比"><a href="#2-执行时间对比" class="headerlink" title="2.执行时间对比"></a>2.执行时间对比</h3><p>a.启动方式耗时对比</p>
<table>
<thead>
<tr>
<th><strong>启动时配置的加载方式</strong></th>
<th><strong>Editor-时间(s)</strong></th>
<th><strong>Android-时间(s)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>lua配置表全加载</td>
<td>0.035</td>
<td>0.030</td>
</tr>
<tr>
<td>sqlite连接db，加载所有表并解析</td>
<td>2.694</td>
<td>1.242</td>
</tr>
<tr>
<td>sqlite只链接db，按需加载表</td>
<td>0.004</td>
<td>0.016</td>
</tr>
</tbody>
</table>
<p>对比来看，启动时使用sqlite连接db按需加载表的方式快一点，但是比较是毫秒级别，原来的lua配置表全加载方式也不是很慢。</p>
<p>b.查找时间对比</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>查1次</strong></th>
<th><strong>查100次</strong></th>
<th><strong>查10000次</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>lua配置表</td>
<td>4.3e-05</td>
<td>0.0005</td>
<td>0.0025</td>
</tr>
<tr>
<td>sqlite</td>
<td>5.4e-05</td>
<td>0.0285</td>
<td>2.580</td>
</tr>
</tbody>
</table>
<p>配置表一般是只读，不会新增、修改、删除。从查找速度来看，肯定是lua配置表块，字典结构而且直接从内存中读，读取db就相对慢很多。单独看，单独一句查询id的sql执行效率也非常快。</p>
<h3 id="3-热更新方式对比"><a href="#3-热更新方式对比" class="headerlink" title="3.热更新方式对比"></a>3.热更新方式对比</h3><p>数据量：</p>
<ul>
<li><p>小量数据：对标周更后的hotfix，一般只会修改一两处配置，修改数据量在个位数。</p>
</li>
<li><p>一般数据：对标周更，使用git命令统计食物语周更lua配置文件修改情况，大约会有20个左右文件被修改。</p>
</li>
<li><p>大量数据：对标月更，统计得出大约有150个lua配置文件被修改。</p>
</li>
</ul>
<p>假设平均一个文件10行数据被修改，那么周更大约200条修改，月更大约1500条修改，一条修改对应一条sql语句。</p>
<p>对于替换db的热更方式，不管数据量都是整个db替换。</p>
<p>以下是测试数据，多次测量取平均的结果：</p>
<table>
<thead>
<tr>
<th><strong>【时间ms】</strong></th>
<th><strong>小量数据(9)</strong></th>
<th><strong>一般数据(200)</strong></th>
<th><strong>一般数据(800)</strong></th>
<th><strong>大量数据(1500)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>热更sql （一个sql文件作为一条命令）</td>
<td>12.9</td>
<td>51.2</td>
<td>892.3</td>
<td>2717</td>
</tr>
</tbody>
</table>
<p>以下是热更不同大小db文件的统计情况：</p>
<table>
<thead>
<tr>
<th><strong>db大小</strong></th>
<th><strong>1576kb（1.53MB）</strong></th>
<th><strong>33.4MB</strong></th>
<th><strong>60.6MB</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>压缩后</td>
<td>284kb</td>
<td>7.58MB</td>
<td>15.7MB</td>
</tr>
<tr>
<td>压缩率</td>
<td>82%</td>
<td>77%</td>
<td>74%</td>
</tr>
<tr>
<td>热更耗时ms (解压+替换+连接)</td>
<td>81.6</td>
<td>1000.5</td>
<td>1778.7</td>
</tr>
</tbody>
</table>
<img src="/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/image_gp3VMdO0Er.png" class="">
<p>将两种方式放在一起对比，可以直观得出结论：<strong>hotfix、周更比较适合选sql方式，月更选替换db方式</strong>。</p>
<p><strong>上面sql执行是一次性执行整个sql文件字符串，所以sql命令解析时间比较长。后面优化以行为单位执行sql文件，5000行左右的sql执行效率在0.5s左右，效率比替换30M DB还高。</strong></p>
<h2 id="工作量设计"><a href="#工作量设计" class="headerlink" title="工作量设计"></a>工作量设计</h2><p>流程图：</p>
<img src="/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/image_iqXG1maoM7.png" class="">
<h3 id="1-导表工具改造，cvs表格导入db"><a href="#1-导表工具改造，cvs表格导入db" class="headerlink" title="1.导表工具改造，cvs表格导入db"></a>1.导表工具改造，cvs表格导入db</h3><p>a.类型转换</p>
<p>C#方法获取的数值类型在lua中属于userdata，发现的影响是不能直接和string直接拼接，稳妥起见，最好使用tonumber(tostring(userdata))转换为lua的数值类型。</p>
<p>配置表中常见的类型需要对应db的存储类型：</p>
<table>
<thead>
<tr>
<th><strong>配置表中的类型</strong></th>
<th><strong>number</strong></th>
<th><strong>string&amp;mlstring</strong></th>
<th><strong>float</strong></th>
<th><strong>boolean</strong></th>
<th><strong>datetime</strong></th>
<th>[type] ([number]&amp;[string])</th>
</tr>
</thead>
<tbody>
<tr>
<td>对应的db存储的类型</td>
<td>int64</td>
<td>string</td>
<td>float</td>
<td>boolean</td>
<td>string</td>
<td>string</td>
</tr>
</tbody>
</table>
<p>说明：[type]表示数组类型，元素类型多为number或者string，db中存储为string类型即可，lua中取出来时再解析为table。存为string时候，开头添加标识符<code>[type]:</code>，表示需要被解析。</p>
<p>lua中获取各类型转换方式如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> fieldName, value = reader:GetName(i), <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">local</span> <span class="built_in">type</span> = reader:GetFieldType(i);</span><br><span class="line"><span class="built_in">type</span> = <span class="built_in">tostring</span>(<span class="built_in">type</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&quot;System.Int64&quot;</span> <span class="keyword">or</span> <span class="built_in">type</span> == <span class="string">&quot;System.Int32&quot;</span> <span class="keyword">or</span> <span class="built_in">type</span> == <span class="string">&quot;System.Int16&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:get_Item(fieldName)))</span><br><span class="line"><span class="keyword">elseif</span> <span class="built_in">type</span> == <span class="string">&quot;System.Float&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetFloat(i)))</span><br><span class="line"><span class="keyword">elseif</span> <span class="built_in">type</span> == <span class="string">&quot;System.Double&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetDouble(i)))</span><br><span class="line"><span class="keyword">elseif</span> <span class="built_in">type</span> == <span class="string">&quot;System.Decimal&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetDecimal(i)))</span><br><span class="line"><span class="keyword">elseif</span> <span class="built_in">type</span> == <span class="string">&quot;System.Boolean&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tostring</span>(reader:GetBoolean(i))==<span class="string">&quot;true&quot;</span> <span class="keyword">and</span> <span class="literal">true</span> <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">elseif</span> <span class="built_in">type</span> == <span class="string">&quot;System.String&quot;</span> <span class="keyword">then</span></span><br><span class="line">    value = <span class="built_in">tostring</span>(reader:get_Item(fieldName)</span><br><span class="line">   <span class="keyword">if</span> <span class="string">&quot;[type]:&quot;</span> == <span class="built_in">string</span>.<span class="built_in">sub</span>(value, <span class="number">1</span>, <span class="number">7</span>) <span class="keyword">then</span></span><br><span class="line">        value = GameUtils.json.decode(<span class="built_in">string</span>.<span class="built_in">sub</span>(value, <span class="number">8</span>))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>b.cvs2db数据解析导入工具</p>
<p>sqlite清空表不支持TRUNCATE TABLE语句，需用DELETE FROM TableName。</p>
<p>sqlite语句和传统的sql语句不太一样，比如不支持多行插入数据，只支持单行插入。</p>
<p>推荐<a target="_blank" rel="noopener" href="http://sqlite.jsrun.net/" title="在线sqlite运行工具">在线sqlite运行工具</a>测试语句，或者在<a target="_blank" rel="noopener" href="https://www.navicat.com.cn/download/navicat-for-sqlite" title="Navicat for SQLite">Navicat for SQLite</a>软件上新建查询执行sql语句。</p>
<h3 id="2-config类接口适配"><a href="#2-config类接口适配" class="headerlink" title="2.config类接口适配"></a>2.config类接口适配</h3><p>需要在lua层链接数据库，查询表读出数据，然后将数据格式化成相同结构的lua配置表类（t_xxx.lua），这样就可以低成本适配config类接口。</p>
<p>这里关键点在于处理db数据类型转换lua数据类型，也就是上述的lua中获取各类型转换方式。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">&quot;SqliteMonoMgr&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">local</span> TInt64 = <span class="string">&quot;Int64&quot;</span></span><br><span class="line"><span class="keyword">local</span> TInt32 = <span class="string">&quot;Int32&quot;</span></span><br><span class="line"><span class="keyword">local</span> TInt16 = <span class="string">&quot;Int16&quot;</span></span><br><span class="line"><span class="keyword">local</span> TFloat = <span class="string">&quot;Float&quot;</span></span><br><span class="line"><span class="keyword">local</span> TDouble = <span class="string">&quot;Double&quot;</span></span><br><span class="line"><span class="keyword">local</span> TDecimal = <span class="string">&quot;Decimal&quot;</span></span><br><span class="line"><span class="keyword">local</span> TBoolean = <span class="string">&quot;Boolean&quot;</span></span><br><span class="line"><span class="keyword">local</span> TString = <span class="string">&quot;String&quot;</span></span><br><span class="line"><span class="keyword">local</span> TArrayPrefix = <span class="string">&quot;[type]:&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:loadConfigTable</span><span class="params">(tableName)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret,reader = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">xpcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">local</span> pks = <span class="built_in">self</span>:_getPrimaryKeys(tableName)</span><br><span class="line">        reader = <span class="built_in">self</span>._sqliteManager:SQLSelect(tableName)</span><br><span class="line">        <span class="keyword">if</span> reader <span class="keyword">and</span> <span class="keyword">not</span> reader.IsClosed <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>._cache[tableName] = <span class="built_in">self</span>:_readConfigTable(reader, pks)</span><br><span class="line">            <span class="built_in">self</span>._loadedTable[tableName] = <span class="literal">true</span></span><br><span class="line">            reader:Close()</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ret = <span class="literal">false</span></span><br><span class="line">            printWarn(<span class="string">&quot;not such table &quot;</span>..tableName)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span></span></span><br><span class="line">        ret = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> reader <span class="keyword">then</span></span><br><span class="line">            reader:Close()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        printError(err)</span><br><span class="line">        <span class="comment">-- self:close()</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">     </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:_readConfigTable</span><span class="params">(reader, pks)</span></span></span><br><span class="line">    <span class="keyword">local</span> configTable = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> reader.HasRows <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> configTable</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">local</span> dataList, title = <span class="built_in">self</span>:_readDataListAndTitle(reader)</span><br><span class="line">    configTable.dataList = dataList</span><br><span class="line">    <span class="comment">-- 按索引构造字典</span></span><br><span class="line">    <span class="keyword">local</span> pkCount,temp = #pks,<span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> pkCount&gt;<span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(dataList) <span class="keyword">do</span></span><br><span class="line">            temp = configTable</span><br><span class="line">            <span class="keyword">for</span> i=<span class="number">1</span>,pkCount,<span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">local</span> pk = pks[i]</span><br><span class="line">                <span class="keyword">local</span> pv = v[pk]</span><br><span class="line">                <span class="keyword">if</span> i==pkCount <span class="keyword">then</span></span><br><span class="line">                    temp[pv] = v</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> temp[pv] <span class="keyword">then</span></span><br><span class="line">                    temp[pv] = &#123;&#125;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                temp = temp[pv]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">         </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> configTable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:_readDataListAndTitle</span><span class="params">(reader)</span></span></span><br><span class="line">    <span class="keyword">local</span> title = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> dataList = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> reader:Read() <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> visibleFieldCount, row = reader.VisibleFieldCount, &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i = <span class="number">0</span>, visibleFieldCount - <span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> fieldName, value = reader:GetName(i), <span class="literal">nil</span>;</span><br><span class="line">            title[fieldName] = i+<span class="number">1</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">type</span> = reader:GetFieldType(i);</span><br><span class="line">            <span class="built_in">type</span> = <span class="built_in">string</span>.<span class="built_in">sub</span>(<span class="built_in">tostring</span>(<span class="built_in">type</span>), <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span> == TInt64 <span class="keyword">or</span> <span class="built_in">type</span> == TInt32 <span class="keyword">or</span> <span class="built_in">type</span> == TInt16 <span class="keyword">then</span></span><br><span class="line">                value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:get_Item(fieldName)))</span><br><span class="line">            <span class="keyword">elseif</span> <span class="built_in">type</span> == TFloat <span class="keyword">then</span></span><br><span class="line">                value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetFloat(i)))</span><br><span class="line">            <span class="keyword">elseif</span> <span class="built_in">type</span> == TDouble <span class="keyword">then</span></span><br><span class="line">                value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetDouble(i)))</span><br><span class="line">            <span class="keyword">elseif</span> <span class="built_in">type</span> == TDecimal <span class="keyword">then</span></span><br><span class="line">                value = <span class="built_in">tonumber</span>(<span class="built_in">tostring</span>(reader:GetDecimal(i)))</span><br><span class="line">            <span class="keyword">elseif</span> <span class="built_in">type</span> == TBoolean <span class="keyword">then</span></span><br><span class="line">                value = <span class="built_in">tostring</span>(reader:GetBoolean(i))==<span class="string">&quot;true&quot;</span> <span class="keyword">and</span> <span class="literal">true</span> <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">elseif</span> <span class="built_in">type</span> == TString <span class="keyword">then</span></span><br><span class="line">                <span class="comment">-- value = reader:GetString(i)</span></span><br><span class="line">                value = <span class="built_in">tostring</span>(reader:get_Item(fieldName))</span><br><span class="line">                <span class="keyword">if</span> TArrayPrefix == <span class="built_in">string</span>.<span class="built_in">sub</span>(value, <span class="number">1</span>, <span class="number">7</span>) <span class="keyword">then</span></span><br><span class="line">                    value = GameUtils.json.decode(<span class="built_in">string</span>.<span class="built_in">sub</span>(value, <span class="number">8</span>))</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(row, value)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">table</span>.<span class="built_in">insert</span>(dataList, row)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">     <span class="comment">-- 构造元表</span></span><br><span class="line">     <span class="keyword">local</span> mt = &#123;</span><br><span class="line">        <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(t, key)</span></span></span><br><span class="line">            <span class="keyword">local</span> index = title[key]</span><br><span class="line">            <span class="keyword">if</span> index <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(t, index)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(dataList) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(v, mt)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> dataList, title</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:_getPrimaryKeys</span><span class="params">(tableName)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._tablePrimaryKeyCache[tableName] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>._tablePrimaryKeyCache[tableName]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> pks = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> reader = <span class="built_in">self</span>._sqliteManager:ExecuteReader(<span class="string">&quot;PRAGMA table_info(&quot;</span>..tableName..<span class="string">&quot;)&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> reader <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">while</span> reader:Read() <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> isPk = reader:GetBoolean(reader:GetOrdinal(<span class="string">&quot;pk&quot;</span>))</span><br><span class="line">            <span class="keyword">if</span> isPk <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">table</span>.<span class="built_in">insert</span>(pks, reader:get_Item(<span class="string">&quot;name&quot;</span>))</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        reader:Close()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">self</span>._tablePrimaryKeyCache[tableName] = pks</span><br><span class="line">    <span class="keyword">return</span> pks</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="3-按需加载表"><a href="#3-按需加载表" class="headerlink" title="3.按需加载表"></a>3.按需加载表</h3><p>可以利用lua元表，当table索引一个表时再去查询db读取整个表并解析成lua配置表类。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> configDictMetaTable = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(t, key)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">rawget</span>(t, key) <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;sqlite 加载表：&quot;</span> .. key)</span><br><span class="line">            <span class="keyword">local</span> configTable = SqliteMonoMgr.instance:findAll(key)</span><br><span class="line">            <span class="built_in">rawset</span>(t, key, configTable)</span><br><span class="line">            <span class="keyword">return</span> configTable</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">ConfigMgr.instance.requestConfig = <span class="function"><span class="keyword">function</span><span class="params">(self, name, configObj)</span></span></span><br><span class="line">    <span class="keyword">local</span> mt = <span class="built_in">getmetatable</span>(configObj._dict)</span><br><span class="line">    <span class="keyword">if</span> mt ~= configDictMetaTable <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(configObj._dict, configDictMetaTable)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> isExistInDB = SqliteMonoMgr.instance:isExistTable(name)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._configDict[name] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> content = <span class="built_in">self</span>._configDict[name]</span><br><span class="line">        configObj:handleConfig(name, content)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> content</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isExistInDB <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">path</span> = <span class="built_in">self</span>._pathPrefix .. name</span><br><span class="line">            content = <span class="built_in">require</span>(<span class="built_in">path</span>)</span><br><span class="line">            <span class="built_in">self</span>._configDict[name] = content</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        configObj:handleConfig(name, content)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>框架中lua配置是预加载+全加载的，其实也可以利用元表做到懒加载，当真正用到数据是才加载。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genProxyMt</span><span class="params">(name, path)</span></span></span><br><span class="line">    <span class="keyword">local</span> name = name</span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">path</span> = <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">loaded</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> datasource = <span class="literal">nil</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(t, k)</span></span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">loaded</span> <span class="keyword">then</span></span><br><span class="line">                datasource = <span class="built_in">require</span>(<span class="built_in">path</span>)</span><br><span class="line">                ConfigMgr.instance:_preProcessConfig(datasource, name)</span><br><span class="line">                <span class="built_in">loaded</span> = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> datasource[k]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ConfigMgr:requestConfig</span><span class="params">(name,configObj)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt_proxy = &#123;</span><br><span class="line">        <span class="built_in">__index</span> = genProxyMt(name, <span class="built_in">path</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt_proxy)</span><br><span class="line">    configObj:handleConfig(name, proxy)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="4-单独一套sqlite-lua查询接口"><a href="#4-单独一套sqlite-lua查询接口" class="headerlink" title="4.单独一套sqlite lua查询接口"></a>4.单独一套sqlite lua查询接口</h3><p>用于业务查询配置，区别于以往方案的baseConfig类。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = class(<span class="string">&quot;SqliteMonoMgr&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 根据id查询</span></span><br><span class="line"><span class="comment">-- @return 返回主键查询结果，只有一条数据返回数据本身，多条数据返回table（多个主键的情况）</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:findById</span><span class="params">(tableName, value, pk)</span></span></span><br><span class="line">    <span class="keyword">if</span> GameUtils.isEmptyString(tableName) <span class="keyword">then</span></span><br><span class="line">        printError(<span class="string">&quot;tableName is nil.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line">    <span class="keyword">if</span> pk==<span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        pk = <span class="string">&quot;id&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._cache[tableName] <span class="keyword">and</span> <span class="built_in">self</span>._cache[tableName][value] <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;findById 命中缓存耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t, tableName, value, pk)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>._cache[tableName][value]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">local</span> reader = <span class="built_in">self</span>._sqliteManager:SQLSelect(tableName, <span class="string">&quot;*&quot;</span>, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;where %s=%s&quot;</span>, pk, value))</span><br><span class="line">    <span class="keyword">if</span> reader <span class="keyword">and</span> <span class="keyword">not</span> reader.IsClosed <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> dataList = <span class="built_in">self</span>:_readDataListAndTitle(reader)</span><br><span class="line">        reader:Close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">self</span>._cache[tableName] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>._cache[tableName] = &#123;&#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> #dataList==<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>._cache[tableName][value] = dataList[<span class="number">1</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;findById 耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t, tableName, value, pk)</span><br><span class="line">            <span class="keyword">return</span> dataList[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;findById 耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t, tableName, value, pk)</span><br><span class="line">            <span class="built_in">self</span>._cache[tableName][value] = dataList</span><br><span class="line">            <span class="keyword">return</span> dataList</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 根据条件查询</span></span><br><span class="line"><span class="comment">-- @return 返回table</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:findAll</span><span class="params">(tableName, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line">    <span class="keyword">local</span> conditions = &#123;...&#125;</span><br><span class="line">    <span class="keyword">if</span> #conditions==<span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">self</span>._loadedTable[tableName] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>:loadConfigTable(tableName)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;findAll 耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t, tableName)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>._cache[tableName]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">local</span> conditionStr = <span class="string">&quot;where&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,#conditions,<span class="number">2</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> key = conditions[i]</span><br><span class="line">        <span class="keyword">local</span> value = conditions[i+<span class="number">1</span>]</span><br><span class="line">        conditionStr = conditionStr..<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot; %s=%s and&quot;</span>, key, value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    conditionStr = <span class="built_in">string</span>.<span class="built_in">sub</span>(conditionStr, <span class="number">1</span>, <span class="number">-4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sql conditionStr:&quot;</span>, conditionStr)</span><br><span class="line">    <span class="keyword">local</span> reader = <span class="built_in">self</span>._sqliteManager:SQLSelect(tableName, <span class="string">&quot;*&quot;</span>, conditionStr)</span><br><span class="line">    <span class="keyword">if</span> reader <span class="keyword">and</span> <span class="keyword">not</span> reader.IsClosed <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> dataList = <span class="built_in">self</span>:_readDataListAndTitle(reader)</span><br><span class="line">        reader:Close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;findAll 耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t, tableName)</span><br><span class="line">        <span class="keyword">return</span> dataList</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 通过输入sql查询</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M:findAllBySql</span><span class="params">(sql)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string</span>.isEmptyString(sql) <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line">    <span class="keyword">local</span> reader = <span class="built_in">self</span>._sqliteManager:ExecuteReader(sql)</span><br><span class="line">    <span class="keyword">if</span> reader <span class="keyword">and</span> <span class="keyword">not</span> reader.IsClosed <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> dataList = <span class="built_in">self</span>:_readDataListAndTitle(reader)</span><br><span class="line">        reader:Close()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;findAllBySql 耗时：&quot;</span>..<span class="built_in">os</span>.<span class="built_in">clock</span>()-t)</span><br><span class="line">        <span class="keyword">return</span> dataList</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="5-db化整为零"><a href="#5-db化整为零" class="headerlink" title="5.db化整为零"></a>5.db化整为零</h3><p>导表工具按Excel目录划分db，一级子目录下Excel表导入到db中，db名以目录名命名。</p>
<p>同时游戏运行时支持多db连接。</p>
<p>表划分db分类：</p>
<ul>
<li><p>经常改动的配置</p>
</li>
<li><p>很少改动的配置</p>
</li>
<li><p>剧情表</p>
</li>
</ul>
<h3 id="6-压缩和热更db"><a href="#6-压缩和热更db" class="headerlink" title="6.压缩和热更db"></a>6.压缩和热更db</h3><p>制作Editor工具，使用ICSharpCode.SharpZipLib.Zip库压缩db，这个库有个控制压缩率的参数compressionLevel(0-9)，以上实测得到的压缩率使用参数值为5，压缩率80%左右。</p>
<p>热更db主要是解压缩和提取替换db文件。</p>
<h3 id="7-数据量大的表的读取方式"><a href="#7-数据量大的表的读取方式" class="headerlink" title="7.数据量大的表的读取方式"></a>7.数据量大的表的读取方式</h3><p>比如language表有13w条数据，这样的表一般不能整个表加载，而要逐条根据id加载+缓存的方式，需要测试下性能。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><h3 id="1-Mono-Data-Sqlite-dll"><a href="#1-Mono-Data-Sqlite-dll" class="headerlink" title="1.Mono.Data.Sqlite.dll"></a>1.Mono.Data.Sqlite.dll</h3><p>根据网上的资料实测，不能使用Editor\Data\MonoBleedingEdge\lib\mono\2.0-api目录下的Mono.Data.Sqlite.dll，使用这个dll打成apk会报类的属性和方法引用空报错。说明不兼容。</p>
<img src="/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/image_SUK4XBL1kd.png" class="">
<p>而应该引用\Editor\Data\Mono\lib\mono\2.0目录下的Mono.Data.Sqlite.dll，即使两者都是Targets .NET 3.5。</p>
<p>使用的Unity版本是Unity2020.3.2f1，其下没有\Editor\Data\Mono目录，但发现<strong>2018.2.3f1，2017.4.37f1下</strong>有这个目录 <strong>。</strong></p>
<p>一开始就使用了Editor\Data\MonoBleedingEdge\下的，Editor上测试正常使用，但是安卓上Mono.Data.Sqlite下的类的某些属性和方法会不兼容报空引用报错（state属性、CreateCommand方法）。</p>
<p>从<strong>2018.2.3f1</strong>下拷贝过来使用，Editor和apk上测试正常了。理解应该是\Editor\Data\Mono\lib\mono\2.0下的dll才兼容，而且这个dll在vs上可以查看到源码。</p>
<p>用ILSpy反编译dll对比：</p>
<img src="/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/image_S_dTSQElWB.png" class="">
<img src="/2022/09/30/SQLite%E6%9B%BF%E6%8D%A2lua%E9%85%8D%E7%BD%AE%E8%A1%A8%E6%96%B9%E6%A1%88%E5%AE%9E%E7%8E%B0/image_DulaDCWifu.png" class="">
<p>最大区别就是版本和Runtime不一样、一个包含源代码和一个只包含了元数据。空报错的原因最大可能是没有把执行代码编译进来。</p>
<h3 id="2-Net-Standard-2-0和-Net-4-x"><a href="#2-Net-Standard-2-0和-Net-4-x" class="headerlink" title="2..Net Standard 2.0和.Net 4.x"></a>2..Net Standard <a target="_blank" rel="noopener" href="http://2.xn--0-se9a.Net" title="2.0和.Net">2.0和.Net</a> 4.x</h3><p>Project Setting&gt;player的Api Compatibility Level选择2.0或4.x，测试都是正常。</p>
<h3 id="3-System-Data-dll"><a href="#3-System-Data-dll" class="headerlink" title="3.System.Data.dll"></a>3.System.Data.dll</h3><p>网上说需要引入这个dll，但是实测不引入也正常使用。</p>
<h3 id="4-connectionString和db存放位置"><a href="#4-connectionString和db存放位置" class="headerlink" title="4.connectionString和db存放位置"></a>4.connectionString和db存放位置</h3><p>安卓上connectionString使用data source=或者URI=file:都可以，但是后面路径不能包内路径，即jar:file://开头的，不然读取失败报错：System.ArgumentException: Invalid ConnectionString format。</p>
<p>db文件只能放在外部可读写目录，即Application.persistentDataPath。db位于包体内，需要拷贝到外部目录。</p>
<p>参考：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/50753569/setup-database-sqlite-for-unity" title="https://stackoverflow.com/questions/50753569/setup-database-sqlite-for-unity">https://stackoverflow.com/questions/50753569/setup-database-sqlite-for-unity</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/112232175" title="https://zhuanlan.zhihu.com/p/112232175">https://zhuanlan.zhihu.com/p/112232175</a></p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;!-- # SQLite替换lua配置表方案实现 --&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;目前游戏中的配置数据实在启动时一次性全部加载进内存，这种方式会造成一定的浪费。而SQLite是一个轻量级的、动态连接的数据库引擎。&lt;/p&gt;
&lt;p&gt;下文探索使用SQLite替换Lua配置表解决内存浪费方案的实现。&lt;/p&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="基础系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="SQLite" scheme="https://laoleo.github.io/tags/SQLite/"/>
    
      <category term="配置表" scheme="https://laoleo.github.io/tags/%E9%85%8D%E7%BD%AE%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>网络层</title>
    <link href="https://laoleo.github.io/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/"/>
    <id>https://laoleo.github.io/2022/05/15/网络层/</id>
    <published>2022-05-14T16:00:00.000Z</published>
    <updated>2022-12-17T13:53:29.951Z</updated>
    
    <content type="html"><![CDATA[<img src="/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_FgCmH2uIWr.png" class="">
<span id="more"></span>
<h1 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h1><img src="/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_FgCmH2uIWr.png" class="">
<p>数据传输格式使用protobuf工具协定，tolua集成了protobuf提供使用。</p>
<p>protobuf.lua：构造协议体、赋值、扩展。</p>
<img src="/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_skRP8CouhK.png" class="">
<p>数据上行下行序列化过程</p>
<img src="/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_UuuQAgKiON.png" class="">
<p>大小端</p>
<p>大小端指数据在机器中的字节在内存中的排序方式。<a target="_blank" rel="noopener" href="https://blog.csdn.net/wwwlyj123321/article/details/100066463" title="链接">链接</a></p>
<img src="/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_Dxda6OJqZV.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;img src=&quot;/2022/05/15/%E7%BD%91%E7%BB%9C%E5%B1%82/image_FgCmH2uIWr.png&quot; class=&quot;&quot;&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="基础系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="network" scheme="https://laoleo.github.io/tags/network/"/>
    
  </entry>
  
  <entry>
    <title>UIParticle@4.0.0研究</title>
    <link href="https://laoleo.github.io/2022/03/18/UIParticle@4.0.0%E7%A0%94%E7%A9%B6/"/>
    <id>https://laoleo.github.io/2022/03/18/UIParticle@4.0.0研究/</id>
    <published>2022-03-17T16:00:00.000Z</published>
    <updated>2022-12-17T13:56:18.010Z</updated>
    
    <content type="html"><![CDATA[<h1 id="UIParticle-4-0-0研究"><a href="#UIParticle-4-0-0研究" class="headerlink" title="UIParticle\@4.0.0研究"></a>UIParticle\@4.0.0研究</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>UIParticle刚开始引进项目中的版本是@3.3.10，发现的问题比较多，材质数不能超8个的问题也在github上提了<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI/issues/122" title="bug#122">bug#122</a>。</p>
<span id="more"></span>
<p>作者最近升级UIParticle到v4，解决了一些问题和增加了新特性，其中包括bug#122。</p>
<p>所以来研究一下，这个新版本的优化内容对项目有没有价值，考虑是否有必要升级版本。</p>
<h2 id="bug修复"><a href="#bug修复" class="headerlink" title="bug修复"></a>bug修复</h2><p>1.submesh can not over 8问题修复</p>
<p>即使是使用很多材质的特效，都没有输出警告了。</p>
<p>2.使用meshRenderer和uv动画实现的烟雾渲染层级不在UI layer问题</p>
<p>使用meshRenderer的粒子不会被UIParticle渲染，因为UIParticle使用了新类UIParticleRenderer进行渲染，同样不会处理非粒子系统下的网格和材质。</p>
<p>3.共享材质问题</p>
<p>动画修改材质属性，共享材质不会同步变化，估计是内部实现已经不使用sharedMaterial属性。</p>
<p>4.ParticleSystem的所有的粒子都能被UIParticle渲染出来吗？</p>
<p>还是拿家具抽奖的那个特效ui_jiajuchoujiang来测试，依然有部分没有渲染出来，而且跟渲染顺序无关。</p>
<p>5.勾选ignoreCanvasScale后不同分辨率下大小不对问题</p>
<p>放弃了ignoreCanvasScale属性，重构了ui缩放逻辑，所以这么问题应该是解决了。</p>
<h2 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h2><p>1.UI自适应缩放</p>
<p>也就是上述第5点。</p>
<p>2.新增吸引子组件</p>
<p>可以吸引粒子沿着某种路径到某个位置，属于效果扩展上的新特性。</p>
<p>3.网格共享组</p>
<p>渲染大量相同粒子时可以使用相同的网格共享组，属于性能优化上的改进。</p>
<p>4.add overlay window</p>
<p>overlay window是unity2021.2开始提供的scene window的覆盖窗口特性，可以自定义菜单，unity2020没有这个特效。</p>
<p>另外Inspector面板做了优化，去掉了IgnoreCanvasScale属性，新增了mesh sharing接口，也支持输出一些警告。</p>
<p>详细看看<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI/releases" title="更新日志">更新日志</a>。</p>
<p><strong>有个问题就是，升级后需要对UIparticle特效的scale重新调整，这点比较麻烦。</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;UIParticle-4-0-0研究&quot;&gt;&lt;a href=&quot;#UIParticle-4-0-0研究&quot; class=&quot;headerlink&quot; title=&quot;UIParticle\@4.0.0研究&quot;&gt;&lt;/a&gt;UIParticle\@4.0.0研究&lt;/h1&gt;&lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;UIParticle刚开始引进项目中的版本是@3.3.10，发现的问题比较多，材质数不能超8个的问题也在github上提了&lt;a target=&quot;_blank&quot; rel=&quot;noopener&quot; href=&quot;https://github.com/mob-sakai/ParticleEffectForUGUI/issues/122&quot; title=&quot;bug#122&quot;&gt;bug#122&lt;/a&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E7%89%B9%E6%95%88/"/>
    
    
      <category term="UIParticle" scheme="https://laoleo.github.io/tags/UIParticle/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/tags/%E7%89%B9%E6%95%88/"/>
    
  </entry>
  
  <entry>
    <title>UIParticle组件的使用问题</title>
    <link href="https://laoleo.github.io/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/"/>
    <id>https://laoleo.github.io/2022/03/05/UIParticle组件的使用问题/</id>
    <published>2022-03-04T16:00:00.000Z</published>
    <updated>2022-12-17T13:56:51.561Z</updated>
    
    <content type="html"><![CDATA[<h1 id="UIParticle组件的使用问题"><a href="#UIParticle组件的使用问题" class="headerlink" title="UIParticle组件的使用问题"></a>UIParticle组件的使用问题</h1><h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>假如能通过代码，对原本的粒子特效prefab，动态添加UIPartcle组件，并且表现效果和RT一样，这样就能够自动化的优化项目中RT特效。</p>
<span id="more"></span>
<h2 id="二、demo测试"><a href="#二、demo测试" class="headerlink" title="二、demo测试"></a>二、demo测试</h2><p>写个demo测试效果，各种RT规格特效选取几个，观察转换前后的效果。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/uiparticleCompare.gif" class="">
<h2 id="三、发现问题"><a href="#三、发现问题" class="headerlink" title="三、发现问题"></a>三、发现问题</h2><p>没有带动画的特效播放正常，带动画的特效发现几个问题，比如ui_jiajuchoujiang特效：</p>
<p>1.代码上暂时没有找到更改Animatable Properties属性的接口，只能在Inspector上更改。</p>
<p>2.代码上刚添加UIParticle组件，首次调用RefreshParticles函数刷新没效果。</p>
<p>3.动画控制着材质属性Material._Main Tex_ST，用UIParticle方式播放时，播放的起始时间对不上，一下子全出来没有先后顺序。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/anim3__eYFZGZolQ.gif" class="">
<p>上图，Inspector上添加动画属性_Main Tex_ST，点击Refresh按钮，然后动画属性_Main Tex_ST播放的起始时间不对。</p>
<p>4.当特效下的网格数大于8个时会报警告：Mesh ‘’ has more than the 8 submeshes. Extra submeshes will be ignored.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mesh <span class="string">&#x27;&#x27;</span> has more than the <span class="number">8</span> submeshes. Extra submeshes will be ignored.</span><br><span class="line">UnityEngine.StackTraceUtility:ExtractStackTrace ()</span><br><span class="line">Coffee.UIExtensions.UIParticleUpdater:Refresh (Coffee.UIExtensions.UIParticle) (at Library/PackageCache/com.coffee.ui-particle@<span class="number">5</span>a8f1263ef/Scripts/UIParticleUpdater.cs:<span class="number">85</span>)</span><br><span class="line">Coffee.UIExtensions.UIParticleUpdater:Refresh () (at Library/PackageCache/com.coffee.ui-particle@<span class="number">5</span>a8f1263ef/Scripts/UIParticleUpdater.cs:<span class="number">54</span>)</span><br><span class="line">UnityEngine.Canvas:SendWillRenderCanvases ()</span><br></pre></td></tr></table></figure>
<p>网格数有限制，大于8个会被忽略，但是效果上看不出啥区别，github上有<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI/issues/186" title="提问bug">提问bug</a>，但没有回复。</p>
<h2 id="四、问题分析"><a href="#四、问题分析" class="headerlink" title="四、问题分析"></a>四、问题分析</h2><h3 id="1-为什么粒子材质会同时播放？"><a href="#1-为什么粒子材质会同时播放？" class="headerlink" title="1.为什么粒子材质会同时播放？"></a>1.为什么粒子材质会同时播放？</h3><p>查看源码发现，动画材质属性更改是通过从ParticleSystemRenderer拿出ShadeMaterials和MaterialPropertyBlock，传给CanvasRenderer，根据Inspector设置好的Animatable material ProPerties来更新Canvas上的材质。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/image_NcuDmPJzjI.png" class="">
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/image_ywMcu33ZPf.png" class="">
<p>所以引起问题的是特效的几个节点引用了同一个材质，而这个材质设置数据后，几个节点就同步更新了。</p>
<p>这里应该复制多个同个材质，分别设置上去，观察效果正常了。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/anim4_tx9hVKst4O.gif" class="">
<p>上图引用同个材质，材质同时更新了。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/anim5_GKfO5IVVAN.gif" class="">
<p>上图复制了材质，单独引用，正常了。</p>
<p>为了证实这个问题，可以自制一个UIparticle特效，下面有两种粒子（1白1蓝），都分别引用同一个材质，另外制作一个animator，只改动第一个粒子的材质颜色，由白到黑再到白。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/image_Uj6XZU2I6p.png" class="">
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/image_67GP1vl5zt.png" class="">
<p>animation上只是改了第一个粒子的材质颜色，但是另一个粒子也受到影响。</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/anim6_MAvMAv1XJM.gif" class="">
<h3 id="2-子网格数限制问题"><a href="#2-子网格数限制问题" class="headerlink" title="2.子网格数限制问题"></a>2.子网格数限制问题</h3><p>网格数大于8会出现不渲染元素的情况，下图tiao03、tiao04的渲染位置从排在后面调整为排在前面，两种情况都有元素丢失，但排在前面的显示出来了：</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/anim2_ocvF-p7l04.gif" class="">
<p>暂不清楚为什么要限制8个网格数，使用时注意引用材质不能太多，否则出现显示丢失元素情况。</p>
<p>这个限制估计是CanvasRenderer的限制，写了段测试代码，CanvasRenderer的mesh合并超过8个子网格数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.UI;</span><br><span class="line"> </span><br><span class="line">public class MeshCombineForCanvas : Graphic</span><br><span class="line">&#123;</span><br><span class="line">    private CanvasRenderer m_canvasRenderer ;</span><br><span class="line">    private Mesh m_mesh ;</span><br><span class="line"> </span><br><span class="line">    protected override void Start()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!m_canvasRenderer) &#123;</span><br><span class="line">            m_canvasRenderer = gameObject.GetComponent&lt;CanvasRenderer&gt;() ?? gameObject.AddComponent&lt;CanvasRenderer&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        m_mesh = CreateMesh();</span><br><span class="line">        // CombineMeshes(m_mesh, <span class="number">8</span>);</span><br><span class="line">        CombineMeshes(m_mesh, <span class="number">10</span>);</span><br><span class="line">        m_canvasRenderer.SetMesh(m_mesh);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private Mesh CreateMesh()</span><br><span class="line">    &#123;</span><br><span class="line">        Vector3[] vertices = new Vector3[<span class="number">4</span>];</span><br><span class="line">        vertices[<span class="number">0</span>] = new Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        vertices[<span class="number">1</span>] = new Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        vertices[<span class="number">2</span>] = new Vector3(<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        vertices[<span class="number">3</span>] = new Vector3(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        int[] triangles = new int[<span class="number">6</span>];</span><br><span class="line">        triangles[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        triangles[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        triangles[<span class="number">2</span>] = <span class="number">2</span>;</span><br><span class="line">        triangles[<span class="number">3</span>] = <span class="number">2</span>;</span><br><span class="line">        triangles[<span class="number">4</span>] = <span class="number">3</span>;</span><br><span class="line">        triangles[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">        Mesh mesh = new Mesh();</span><br><span class="line">        mesh.vertices = vertices;</span><br><span class="line">        mesh.triangles = triangles;</span><br><span class="line">        <span class="keyword">return</span> mesh;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private void CombineMeshes(Mesh meshContainer, int count)</span><br><span class="line">    &#123;</span><br><span class="line">        CombineInstance[] src = new CombineInstance[count];</span><br><span class="line">        <span class="keyword">for</span> (int i=<span class="number">0</span>; i&lt;count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Mesh mesh = CreateMesh();</span><br><span class="line">            CombineInstance inst = new CombineInstance&#123; mesh = mesh &#125;;</span><br><span class="line">            src[i] = inst;</span><br><span class="line">        &#125;</span><br><span class="line">        meshContainer.CombineMeshes(src, <span class="literal">false</span>, <span class="literal">false</span>) ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后同样会报Warning：</p>
<img src="/2022/03/05/UIParticle%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98/image_db_KmLvzYS.png" class="">
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;UIParticle组件的使用问题&quot;&gt;&lt;a href=&quot;#UIParticle组件的使用问题&quot; class=&quot;headerlink&quot; title=&quot;UIParticle组件的使用问题&quot;&gt;&lt;/a&gt;UIParticle组件的使用问题&lt;/h1&gt;&lt;h2 id=&quot;一、背景&quot;&gt;&lt;a href=&quot;#一、背景&quot; class=&quot;headerlink&quot; title=&quot;一、背景&quot;&gt;&lt;/a&gt;一、背景&lt;/h2&gt;&lt;p&gt;假如能通过代码，对原本的粒子特效prefab，动态添加UIPartcle组件，并且表现效果和RT一样，这样就能够自动化的优化项目中RT特效。&lt;/p&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E7%89%B9%E6%95%88/"/>
    
    
      <category term="UIParticle" scheme="https://laoleo.github.io/tags/UIParticle/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/tags/%E7%89%B9%E6%95%88/"/>
    
  </entry>
  
  <entry>
    <title>ParticleEffectForUGUI（UIParticle）</title>
    <link href="https://laoleo.github.io/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/"/>
    <id>https://laoleo.github.io/2022/01/10/ParticleEffectForUGUI（UIParticle）/</id>
    <published>2022-01-09T16:00:00.000Z</published>
    <updated>2022-12-17T13:52:23.608Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ParticleEffectForUGUI（UIParticle）"><a href="#ParticleEffectForUGUI（UIParticle）" class="headerlink" title="ParticleEffectForUGUI（UIParticle）"></a>ParticleEffectForUGUI（UIParticle）</h1><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>ParticleEffectForUGUI插件，又名UIParticle，为UGUI渲染可遮罩、可排序的粒子特效，而且不需要额外摄像机、RT和Canvas。Unity 2018.2及以上版本支持。</p>
<span id="more"></span>
<p>官方对其的使用和与其他方案对比的优缺点已给出详细说明，了解请访问<a target="_blank" rel="noopener" href="https://github.com/mob-sakai/ParticleEffectForUGUI" title="ParticleEffectForUGUI">ParticleEffectForUGUI</a>。</p>
<p>下面研究如何引入到项目中使用，Unity版本是2019.4.35f1，并且和项目现使用的RT粒子特效方案做性能对比。</p>
<h2 id="二、引入项目"><a href="#二、引入项目" class="headerlink" title="二、引入项目"></a>二、引入项目</h2><h4 id="1-导入package"><a href="#1-导入package" class="headerlink" title="1.导入package"></a>1.导入package</h4><p>使用manifest.json添加依赖方式导入。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- manifest.json</span><br><span class="line">dependencies:&#123;</span><br><span class="line">  <span class="string">&quot;com.coffee.ui-particle&quot;</span>: <span class="string">&quot;[https://github.com/mob-sakai/ParticleEffectForUGUI.git#3.3.10](https://github.com/mob-sakai/ParticleEffectForUGUI.git#3.3.10)&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#3.3.10代表版本号。refresh一下就会导入package。</p>
<h4 id="2-添加UIParticle组件"><a href="#2-添加UIParticle组件" class="headerlink" title="2.添加UIParticle组件"></a>2.添加UIParticle组件</h4><p>gameObject右键-UI中可以添加UIParticle组件。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_2vkN8DyEOU.png" class="">
<p>也可以将目前项目里的UI Effect Prefab转换成用UIParticle的方式，在其根节点上添加UIParticle组件即可。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_TKk-_imcnM.png" class="">
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_ckbsiwRhQu.png" class="">
<p>两者效果一致，而且UIParticle方式的特效可以自由缩放大小。</p>
<h4 id="3-编写工具类，在lua层加载UIParticle并显示"><a href="#3-编写工具类，在lua层加载UIParticle并显示" class="headerlink" title="3.编写工具类，在lua层加载UIParticle并显示"></a>3.编写工具类，在lua层加载UIParticle并显示</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- UIParticle.lua</span></span><br><span class="line"><span class="built_in">module</span>(<span class="string">&quot;logic.common.ugui.UIParticle&quot;</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">local</span> UIParticle = class(<span class="string">&quot;UIParticle&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:ctor</span><span class="params">(container)</span></span></span><br><span class="line">    <span class="built_in">self</span>._go = container.gameObject</span><br><span class="line">    <span class="built_in">self</span>._loader = PrefabLoader.Get(<span class="built_in">self</span>._go)</span><br><span class="line">    <span class="built_in">self</span>._url = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._goInst = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:load</span><span class="params">(url)</span></span></span><br><span class="line">    <span class="keyword">if</span> GameUtils.isEmptyString(url) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> url == <span class="built_in">self</span>._url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">self</span>._url = url</span><br><span class="line">    <span class="built_in">self</span>._loader:<span class="built_in">load</span>(url, <span class="built_in">self</span>._onResLoaded, <span class="built_in">self</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:_onResLoaded</span><span class="params">(loader)</span></span></span><br><span class="line">    <span class="keyword">local</span> goInst = loader <span class="keyword">and</span> loader:getInst()</span><br><span class="line">    <span class="keyword">if</span> goutil.isNil(goInst) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    goutil.addChildToParent(goInst, <span class="built_in">self</span>._go)</span><br><span class="line">    <span class="built_in">self</span>._goInst = goInst</span><br><span class="line">    <span class="built_in">self</span>._comUIParticle = goInst:GetComponent(typeof(Coffee.UIExtensions.UIParticle))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._effectLoadedCallback <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>._effectLoadedCallbackObj <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>._effectLoadedCallback(<span class="built_in">self</span>._effectLoadedCallbackObj, goInst, res)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">self</span>._effectLoadedCallback(goInst, res)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--检查美术是否有挂载EffectPlayer的组件</span></span><br><span class="line">    <span class="keyword">local</span> _effectCSComp = goInst:GetComponent(typeof(Pjg.EffectPlayer))</span><br><span class="line">    <span class="keyword">if</span> _effectCSComp <span class="keyword">and</span> <span class="keyword">not</span> goutil.isNil(_effectCSComp) <span class="keyword">then</span></span><br><span class="line">        <span class="comment">--参数默认以组件的，暂不支持外部设置参数</span></span><br><span class="line">        _effectCSComp:AddFinishListener(<span class="built_in">self</span>._onEffectPlayFinish, <span class="built_in">self</span>)</span><br><span class="line">        <span class="comment">--加载好就立即执行play</span></span><br><span class="line">        _effectCSComp:Play()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">--暂时没有全部播放完毕逻辑回调</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:_onEffectPlayFinish</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> goutil.isNil(<span class="built_in">self</span>._go) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._effectFinishCallback <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>._effectFinishCallbackObj <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>._effectFinishCallback(<span class="built_in">self</span>._effectFinishCallbackObj, <span class="built_in">self</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">self</span>._effectFinishCallback()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:clear</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> goutil.isNil(<span class="built_in">self</span>._goInst) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">--检查美术是否有挂载EffectPlayer的组件</span></span><br><span class="line">    <span class="keyword">local</span> _effectCSComp = <span class="built_in">self</span>._goInst:GetComponent(typeof(Pjg.EffectPlayer))</span><br><span class="line">    <span class="keyword">if</span> _effectCSComp <span class="keyword">and</span> <span class="keyword">not</span> goutil.isNil(_effectCSComp) <span class="keyword">then</span></span><br><span class="line">        _effectCSComp:Stop()</span><br><span class="line">        _effectCSComp:RemoveFinishListener()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:OnDestroy</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">self</span>:clear()</span><br><span class="line">    <span class="built_in">self</span>._go = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._loader = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._url = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._goInst = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._effectLoadedCallback = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._effectLoadedCallbackObj = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._effectFinishCallback = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">self</span>._effectFinishCallbackObj = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:getGo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">self</span>._go</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:setEffectLoadedCallback</span><span class="params">(callback, callbackObj)</span></span></span><br><span class="line">    <span class="built_in">self</span>._effectLoadedCallback = callback</span><br><span class="line">    <span class="built_in">self</span>._effectLoadedCallbackObj = callbackObj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:setEffectFinishCallback</span><span class="params">(callback, callbackObj)</span></span></span><br><span class="line">    <span class="built_in">self</span>._effectFinishCallback = callback</span><br><span class="line">    <span class="built_in">self</span>._effectFinishCallbackObj = callbackObj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:play</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> goutil.isNil(<span class="built_in">self</span>._goInst) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">self</span>._goInst.activeSelf <span class="keyword">then</span></span><br><span class="line">        goutil.setActive(<span class="built_in">self</span>._goInst, <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    goutil.setActive(<span class="built_in">self</span>._goInst, <span class="literal">true</span>)</span><br><span class="line">    <span class="comment">--检查美术是否有挂载EffectPlayer的组件</span></span><br><span class="line">    <span class="keyword">local</span> _effectCSComp = <span class="built_in">self</span>._goInst:GetComponent(typeof(Pjg.EffectPlayer))</span><br><span class="line">    <span class="keyword">if</span> _effectCSComp <span class="keyword">and</span> <span class="keyword">not</span> goutil.isNil(_effectCSComp) <span class="keyword">then</span></span><br><span class="line">        _effectCSComp:Stop()</span><br><span class="line">        _effectCSComp:RemoveFinishListener()</span><br><span class="line">        <span class="comment">--参数默认以组件的，暂不支持外部设置参数</span></span><br><span class="line">        _effectCSComp:AddFinishListener(<span class="built_in">self</span>._onEffectPlayFinish, <span class="built_in">self</span>)</span><br><span class="line">        _effectCSComp:Play()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:setScale</span><span class="params">(scale)</span></span></span><br><span class="line">    <span class="built_in">self</span>._comUIParticle.scale = scale</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UIParticle:setPos</span><span class="params">(x, y, z)</span></span></span><br><span class="line">    GameUtils.setLocalPos(<span class="built_in">self</span>._goInst, x, y, z <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> UIParticle</span><br></pre></td></tr></table></figure>
<p>功能包括加载uiParticle Prefab，改变大小和位置。</p>
<p>测试能够正常显示：</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/uiparticle_wQzXgIMX6n.gif" class="">
<h2 id="三、UIParticle实现原理"><a href="#三、UIParticle实现原理" class="headerlink" title="三、UIParticle实现原理"></a>三、UIParticle实现原理</h2><img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_tl8asSvA18.png" class="">
<p>1.会先将粒子系统的共享材质传给CanvasRenderer</p>
<p>2.在Canvas刷新前事件函数里，将粒子系统的网格经过烘焙后合并，将合并的烘焙网格传给CanvasRenderer.Mesh</p>
<p>3.刷新材质属性时，从粒子系统材质上拿到材质属性数据，根据面板上设置好的动画材质属性类型，依次传给CanvasRenderer上的材质。</p>
<p>4.相同材质的粒子会烘焙成网格并合并，UIParticle在烘焙前会对粒子排序，按材质实例ID、渲染队列、渲染顺序等排序，合并网格时将计算材质的hashCode，相等才能一起合并。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_Lq8cKHXJpH.png" class="">
<h2 id="四、性能对比"><a href="#四、性能对比" class="headerlink" title="四、性能对比"></a>四、性能对比</h2><p>UIParticle和RT特效方式进行性能对比</p>
<h4 id="1-单个UI粒子特效对比"><a href="#1-单个UI粒子特效对比" class="headerlink" title="1.单个UI粒子特效对比"></a>1.单个UI粒子特效对比</h4><img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_dlKUVIURur.png" class="">
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_-AleO20bJE.png" class="">
<p>左边UIParticle，右边RT。</p>
<p>两者面数一样，UIParticle比RT方式少1个batches，其实差不多。</p>
<p>对比内存：</p>
<p><strong>1.1256*144RT与UIParticle内存占用对比：</strong></p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_CVmGras3MP.png" class="">
<p>256*144的RT特效内存加载情况，rt不是很大，只是占432kb。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_S5b-ACEJZV.png" class="">
<p>UIParticle内存特效加载后，scene memory只是上涨了0.2MB，而RT特效上涨0.6MB，RT特效占用较大；RT特效的Assets内存也大了0.2MB。</p>
<p>1.2全屏1560*720RT和UIParticle内存占用对比：</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_oZQEU2PqwI.png" class="">
<p>RT特效加载前后内存对比，可以看出加载后scene memory中rt占的内存较大，一张全屏RT占了近13MB。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_0FbXJEVpBZ.png" class="">
<p>UIParticle特效加载前后对比，加载后scene memory中没有rt，内存上升不多。</p>
<p>对比两者可以看出，particleSystem占的内存都一样，而全屏RT所以占用的内存就更明显了。</p>
<h4 id="2-多个相同UI粒子特效对比"><a href="#2-多个相同UI粒子特效对比" class="headerlink" title="2.多个相同UI粒子特效对比"></a>2.多个相同UI粒子特效对比</h4><img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_2gDEMoHZdN.png" class="">
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_dd56kuGgSY.png" class="">
<p>左边UIParticle，右边RT。</p>
<p>UIParticle方式特效面数比RT多，batches数也比较多。相比下，RT方式更好。</p>
<p>对比内存：</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_tWZrP03QQ1.png" class="">
<p>加载10个UIParticle特效，particleSystem数量增加30（正常），scene memory增加1.6MB，assets增加1.4MB，Other上涨0.02GB。</p>
<img src="/2022/01/10/ParticleEffectForUGUI%EF%BC%88UIParticle%EF%BC%89/image_4Tro4aIdsT.png" class="">
<p>加个10个同个粒子的RT特效，RT增加一个（共用同一个255*144大小RT），scene memory增加0.6MB，assets增加0.2MB，Other上涨0.01GB。</p>
<p>明显多个相同粒子特效，内存方面，RT方式优于UIParticle方式。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li><p>UI特效单独显示（比如全屏特效等）的情况，选择UIParticle方式。</p>
</li>
<li><p>UI特效多个相同显示，选择RT方式。</p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ParticleEffectForUGUI（UIParticle）&quot;&gt;&lt;a href=&quot;#ParticleEffectForUGUI（UIParticle）&quot; class=&quot;headerlink&quot; title=&quot;ParticleEffectForUGUI（UIParticle）&quot;&gt;&lt;/a&gt;ParticleEffectForUGUI（UIParticle）&lt;/h1&gt;&lt;h2 id=&quot;一、概述&quot;&gt;&lt;a href=&quot;#一、概述&quot; class=&quot;headerlink&quot; title=&quot;一、概述&quot;&gt;&lt;/a&gt;一、概述&lt;/h2&gt;&lt;p&gt;ParticleEffectForUGUI插件，又名UIParticle，为UGUI渲染可遮罩、可排序的粒子特效，而且不需要额外摄像机、RT和Canvas。Unity 2018.2及以上版本支持。&lt;/p&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E7%89%B9%E6%95%88/"/>
    
    
      <category term="UIParticle" scheme="https://laoleo.github.io/tags/UIParticle/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/tags/%E7%89%B9%E6%95%88/"/>
    
  </entry>
  
  <entry>
    <title>UGUIText组件实现图文混排——原理篇</title>
    <link href="https://laoleo.github.io/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/"/>
    <id>https://laoleo.github.io/2021/12/27/UGUIText组件实现图文混排——原理篇/</id>
    <published>2021-12-26T16:00:00.000Z</published>
    <updated>2022-12-07T13:37:07.617Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#ugui-text组件实现图文混排">UGUI Text组件实现图文混排</a><ul>
<li><a href="#实现图文混排原理">实现图文混排原理</a><ul>
<li><a href="#quad标签的使用">quad标签的使用</a></li>
</ul>
</li>
<li><a href="#渲染内嵌图片">渲染内嵌图片</a><ul>
<li><a href="#文字渲染原理">文字渲染原理</a></li>
<li><a href="#流程讲解">流程讲解</a></li>
<li><a href="#代码实现">代码实现</a></li>
</ul>
</li>
<li><a href="#超链接实现">超链接实现</a><ul>
<li><a href="#超链接处理流程">超链接处理流程</a></li>
<li><a href="#响应点击事件">响应点击事件</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="UGUI-Text组件实现图文混排"><a href="#UGUI-Text组件实现图文混排" class="headerlink" title="UGUI Text组件实现图文混排"></a>UGUI Text组件实现图文混排</h1><h2 id="实现图文混排原理"><a href="#实现图文混排原理" class="headerlink" title="实现图文混排原理"></a>实现图文混排原理</h2><p>Unity手册上介绍UI系统和传统的GUI系统都支持<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2017.4/Documentation/Manual/StyledText.html" title="富文本">富文本</a>，Text、GUIStyle、GUIText和TextMesh类上有rich text的设置选项，开启它后Unity会解析文本中标记标签。</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image__hVtRDjd_h.png" class="">
<p>unity中支持的文本标签如下：</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_yhRARumho4.png" class="">
<p>其中quad标签可以渲染出行内内嵌的图片，但是只是对TextMesh组件有效。</p>
<blockquote>
<p>This is only useful for text meshes and renders an image inline with the text.</p>
</blockquote>
<p>TextMesh是用来生成3D图形字体，不能直接用在UI Canvas下。</p>
<blockquote>
<p>Text Meshes can be used for rendering road signs, graffiti etc. The Text Mesh places text in the 3D scene. To make generic 2D text for GUIs, use a <a href="class-GUIText.html" title="GUI Text">GUI Text</a> component instead.</p>
</blockquote>
<p>2D文本渲染需要用GUI Text组件，它属于传统GUI系统，UI系统（即UGUI）下的Text组件也是一样的用途，正如本节开头说到他们都有rich text的设置。</p>
<p>但是UI的文本组件并不支持内嵌的图片，使用quad标签会出现乱码。好在UGUI开源，可以通过重写Text组件以支持渲染内嵌图片的效果。</p>
<h3 id="quad标签的使用"><a href="#quad标签的使用" class="headerlink" title="quad标签的使用"></a>quad标签的使用</h3><blockquote>
<p>\<quad material=1 size=20 x=0.1 y=0.1 width=0.5 height=0.5></p>
</blockquote>
<p>material：渲染组件上引用的材质，值为材质数组的下表，从0开始。</p>
<p>size：决定内嵌图片的像素大小。</p>
<p>x/y/width/height：决定材质贴图上渲染矩形区域的偏移和大小，它们的value代表百分比，类似于uv坐标。</p>
<p>经过测试得知，实际渲染图片大小的关系：图片像素大小 = size *（width/height）。</p>
<p>可以参考这篇<a target="_blank" rel="noopener" href="https://blog.csdn.net/tom_221x/article/details/113456808" title="文章">文章</a>来推测。</p>
<p>使用在UI Text组件上会出现乱码，其实乱码是字体贴图，放大后可以看见贴图上的文字，只不过缩放太小所以看不到。</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_rVuWhoO_3B.png" class="">
<p>打开rich text设置才会解析标签，否则不解析：</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_7M009fCb6d.png" class="">
<h2 id="渲染内嵌图片"><a href="#渲染内嵌图片" class="headerlink" title="渲染内嵌图片"></a>渲染内嵌图片</h2><p>虽然quad在UI上渲染不出图片，但是可以定义渲染区域大小，可以作为占位符。</p>
<p>借助这个特效，渲染内嵌图片可以分三步：</p>
<ol>
<li><p>使用quad标签占位</p>
</li>
<li><p>去除乱码</p>
</li>
<li><p>使用MaskableGraphic类渲染贴图，放置于占位符位置上</p>
</li>
</ol>
<p>项目规定，在渲染贴图之前，需要将所有用到的贴图打到一个spriteAsset上，并且将它引用到UIGraphicTextSprite组件上，UIGraphicTextSprite组件继承MaskableGraphic类，具体使用过程参考这篇<a target="_blank" rel="noopener" href="http://wiki.info/pages/viewpage.action?pageId=13736289" title="文章">文章</a>。</p>
<h3 id="文字渲染原理"><a href="#文字渲染原理" class="headerlink" title="文字渲染原理"></a>文字渲染原理</h3><img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_n9LveM62tZ.png" class="">
<p>1.左边文本会生成100个顶点数据，100来自假设，但顶点数肯定是4的倍数</p>
<p>2.前8个顶点代表两个中文的位置</p>
<p>3.后面的顶点都是quad标签的顶点，但是unity会做处理，只有前4个代表quad标签的区域，后面顶点位置都位于一个点上，不会渲染内容</p>
<h3 id="流程讲解"><a href="#流程讲解" class="headerlink" title="流程讲解"></a>流程讲解</h3><p>UGUI Text组件渲染文字代码流程图：</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_hn-XI1mBjn.png" class="">
<p>重写渲染流程：</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_0ifY5wkaqd.png" class="">
<p>重写渲染流程详细介绍：</p>
<img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_OTeaUItO0F.png" class="">
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>正则表达式匹配quad标签</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Regex m_spriteTagRegex =</span><br><span class="line">          <span class="keyword">new</span> Regex(<span class="string">@&quot;&lt;quad name=(.+?) size=(\d*\.?\d+%?) width=(\d*\.?\d+%?) des=(.+?) /&gt;&quot;</span>, RegexOptions.Singleline);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (Match match <span class="keyword">in</span> m_spriteTagRegex.Matches(m_OutputText))</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清除乱码</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//清楚乱码</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listTagInfor.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//UGUIText不支持&lt;quad/&gt;标签，表现为乱码，我这里将他的uv全设置为0,清除乱码</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> m = listTagInfor[i].index * <span class="number">4</span>; m &lt; listTagInfor[i].index * <span class="number">4</span> + <span class="number">4</span>; m++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//超出可视范围的不会绘制，即leftBottomIndex &gt;= verts.Count。</span></span><br><span class="line">        <span class="comment">//所以这里不需要处理也不应该处理。若处理，则数组越界。</span></span><br><span class="line">        <span class="keyword">if</span> (m &gt;= verts.Count)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UIVertex tempVertex = verts[m];</span><br><span class="line">        tempVertex.uv0 = Vector2.zero;</span><br><span class="line">        verts[m] = tempVertex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成网格数据</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> InlineSpriteInfor</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">// 文字的最后的位置</span></span><br><span class="line">      <span class="keyword">public</span> Vector3 textpos;</span><br><span class="line">      <span class="comment">// 4 顶点 </span></span><br><span class="line">      <span class="keyword">public</span> Vector3[] vertices;</span><br><span class="line">      <span class="comment">//4 uv</span></span><br><span class="line">      <span class="keyword">public</span> Vector2[] uv;</span><br><span class="line">      <span class="comment">//6 三角顶点顺序</span></span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">int</span>[] triangles;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">bool</span> isEmptySprite;</span><br><span class="line">      <span class="keyword">public</span> Texture texture;</span><br><span class="line">      <span class="keyword">public</span> <span class="built_in">string</span> name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">CalcQuadTag</span>(<span class="params">IList&lt;UIVertex&gt; verts</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">      m_AnimSpriteInfo = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, InlineSpriteInfor[]&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//通过标签信息来设置需要绘制的图片的信息</span></span><br><span class="line">      listSprite = <span class="keyword">new</span> List&lt;InlineSpriteInfor&gt;();</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listTagInfor.Count; i++)</span><br><span class="line">      &#123;                                                                         <span class="number">3</span>    <span class="number">2</span></span><br><span class="line">          <span class="keyword">var</span> leftBottomIndex = ((listTagInfor[i].index + <span class="number">1</span>) * <span class="number">4</span>) - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> (leftBottomIndex &gt;= verts.Count)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          InlineSpriteInfor tempSprite = <span class="keyword">new</span> InlineSpriteInfor();</span><br><span class="line">          tempSprite.name = listTagInfor[i].name;</span><br><span class="line">          tempSprite.isEmptySprite = listTagInfor[i].isEmptySprite;</span><br><span class="line">          </span><br><span class="line">          tempSprite.textpos = verts[leftBottomIndex].position;</span><br><span class="line">          <span class="comment">//设置图片的位置</span></span><br><span class="line">          tempSprite.vertices = <span class="keyword">new</span> Vector3[<span class="number">4</span>];</span><br><span class="line">          tempSprite.vertices[<span class="number">0</span>] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) + tempSprite.textpos;</span><br><span class="line">          tempSprite.vertices[<span class="number">1</span>] = <span class="keyword">new</span> Vector3(listTagInfor[i].size.x, listTagInfor[i].size.y, <span class="number">0</span>) + tempSprite.textpos;</span><br><span class="line">          tempSprite.vertices[<span class="number">2</span>] = <span class="keyword">new</span> Vector3(listTagInfor[i].size.x, <span class="number">0</span>, <span class="number">0</span>) + tempSprite.textpos;</span><br><span class="line">          tempSprite.vertices[<span class="number">3</span>] = <span class="keyword">new</span> Vector3(<span class="number">0</span>, listTagInfor[i].size.y, <span class="number">0</span>) + tempSprite.textpos;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//计算其uv</span></span><br><span class="line">          Sprite sprite;</span><br><span class="line">          m_nameToSpriteDict.TryGetValue(listTagInfor[i].name, <span class="keyword">out</span> sprite);</span><br><span class="line">          Rect spriteRect = sprite.textureRect;</span><br><span class="line">          Texture texSource = sprite.texture;</span><br><span class="line">          tempSprite.texture = texSource;</span><br><span class="line">          Vector2 texSize = <span class="keyword">new</span> Vector2(texSource.width, texSource.height);</span><br><span class="line">          tempSprite.uv = <span class="keyword">new</span> Vector2[<span class="number">4</span>];</span><br><span class="line">          tempSprite.uv[<span class="number">0</span>] = <span class="keyword">new</span> Vector2(spriteRect.x / texSize.x, spriteRect.y / texSize.y);</span><br><span class="line">          tempSprite.uv[<span class="number">1</span>] = <span class="keyword">new</span> Vector2((spriteRect.x + spriteRect.width) / texSize.x, (spriteRect.y + spriteRect.height) / texSize.y);</span><br><span class="line">          tempSprite.uv[<span class="number">2</span>] = <span class="keyword">new</span> Vector2((spriteRect.x + spriteRect.width) / texSize.x, spriteRect.y / texSize.y);</span><br><span class="line">          tempSprite.uv[<span class="number">3</span>] = <span class="keyword">new</span> Vector2(spriteRect.x / texSize.x, (spriteRect.y + spriteRect.height) / texSize.y);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//声明三角顶点所需要的数组</span></span><br><span class="line">          tempSprite.triangles = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">6</span>];</span><br><span class="line">          listSprite.Add(tempSprite);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>渲染贴图</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawSprite</span>(<span class="params">UIGraphicTextSprites spriteGraphic, List&lt;InlineSpriteInfor&gt; listInlineSprite</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> spriteCanvasRenderer = spriteGraphic.GetComponentInChildren&lt;CanvasRenderer&gt;();</span><br><span class="line">  <span class="keyword">if</span> (m_spriteMesh == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    m_spriteMesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (drawSpriteVertices == <span class="literal">null</span>) drawSpriteVertices = <span class="keyword">new</span> List&lt;Vector3&gt;();</span><br><span class="line">  <span class="keyword">else</span> drawSpriteVertices.Clear();</span><br><span class="line">  <span class="keyword">if</span> (drawSpriteUv == <span class="literal">null</span>) drawSpriteUv = <span class="keyword">new</span> List&lt;Vector2&gt;();</span><br><span class="line">  <span class="keyword">else</span> drawSpriteUv.Clear();</span><br><span class="line">  <span class="keyword">if</span> (drawSpriteTriangles == <span class="literal">null</span>) drawSpriteTriangles = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">  <span class="keyword">else</span> drawSpriteTriangles.Clear();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; listInlineSprite.Count; i++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">var</span> inlineSprite = listInlineSprite[i];</span><br><span class="line">      <span class="keyword">if</span> (inlineSprite.isEmptySprite) </span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; inlineSprite.vertices.Length; j++)</span><br><span class="line">      &#123;</span><br><span class="line">          drawSpriteVertices.Add(inlineSprite.vertices[j]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; inlineSprite.uv.Length; j++)</span><br><span class="line">      &#123;</span><br><span class="line">          drawSpriteUv.Add(inlineSprite.uv[j]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; inlineSprite.triangles.Length; j++)</span><br><span class="line">      &#123;</span><br><span class="line">          drawSpriteTriangles.Add(inlineSprite.triangles[j]);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//计算顶点绘制顺序</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; drawSpriteTriangles.Count; i++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">6</span> == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">int</span> num = i / <span class="number">6</span>;</span><br><span class="line">          drawSpriteTriangles[i] = <span class="number">0</span> + <span class="number">4</span> * num;</span><br><span class="line">          drawSpriteTriangles[i + <span class="number">1</span>] = <span class="number">1</span> + <span class="number">4</span> * num;</span><br><span class="line">          drawSpriteTriangles[i + <span class="number">2</span>] = <span class="number">2</span> + <span class="number">4</span> * num;</span><br><span class="line"></span><br><span class="line">          drawSpriteTriangles[i + <span class="number">3</span>] = <span class="number">1</span> + <span class="number">4</span> * num;</span><br><span class="line">          drawSpriteTriangles[i + <span class="number">4</span>] = <span class="number">0</span> + <span class="number">4</span> * num;</span><br><span class="line">          drawSpriteTriangles[i + <span class="number">5</span>] = <span class="number">3</span> + <span class="number">4</span> * num;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  m_spriteMesh.vertices = drawSpriteVertices.ToArray ();</span><br><span class="line">  m_spriteMesh.uv = drawSpriteUv.ToArray ();</span><br><span class="line">  m_spriteMesh.triangles = drawSpriteTriangles.ToArray ();</span><br><span class="line">  </span><br><span class="line">  spriteCanvasRenderer.SetMesh(m_spriteMesh);</span><br><span class="line">  spriteGraphic.UpdateMaterial();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态图片是按一定频率切换主贴图和网格数据实现的</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">float</span> fTime = <span class="number">0.0f</span>;</span><br><span class="line"><span class="comment">//int iIndex = 0;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(listSprite == <span class="literal">null</span> || listSprite.Count==<span class="number">0</span> || m_hasAnimTag==<span class="literal">false</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">fTime += Time.deltaTime;</span><br><span class="line"><span class="keyword">if</span> (fTime &gt;= DynamicTagSwitchInterval)</span><br><span class="line">&#123;</span><br><span class="line">        UpdateAnimSprite();</span><br><span class="line">  fTime = <span class="number">0.0f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateAnimSprite</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_AnimIndex.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> animIndex = m_AnimIndex[i];</span><br><span class="line">        <span class="keyword">if</span> (!m_AnimSpriteInfo.ContainsKey(animIndex)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        m_AnimSpriteStep[animIndex]++;</span><br><span class="line">        <span class="keyword">if</span> (m_AnimSpriteStep[animIndex] &gt;= m_AnimSpriteInfo[animIndex].Length)</span><br><span class="line">        &#123;</span><br><span class="line">            m_AnimSpriteStep[animIndex] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> step = m_AnimSpriteStep[animIndex];</span><br><span class="line">        <span class="keyword">var</span> inlineSprite = m_AnimSpriteInfo[animIndex][step];</span><br><span class="line">        Sprite sprite;</span><br><span class="line">        m_nameToSpriteDict.TryGetValue(inlineSprite.name, <span class="keyword">out</span> sprite);</span><br><span class="line">        <span class="keyword">var</span> spriteGraphic = m_spriteGraphicArray[animIndex];</span><br><span class="line">        spriteGraphic.SetMainTexture(sprite.texture);</span><br><span class="line">        DrawSprite(spriteGraphic, <span class="keyword">new</span> List&lt;InlineSpriteInfor&gt;()&#123;inlineSprite&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="超链接实现"><a href="#超链接实现" class="headerlink" title="超链接实现"></a>超链接实现</h2><h3 id="超链接处理流程"><a href="#超链接处理流程" class="headerlink" title="超链接处理流程"></a>超链接处理流程</h3><img src="/2021/12/27/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86%E7%AF%87/image_TwT2GLPl7b.png" class="">
<h3 id="响应点击事件"><a href="#响应点击事件" class="headerlink" title="响应点击事件"></a>响应点击事件</h3><ol>
<li><p>UIGraphicText组件继承IPointerClickHandler接口，实现OnPointerClick方法</p>
</li>
<li><p>RectTransformUtility.ScreenPointToLocalPointInRectangle方法将屏幕坐标转成local坐标</p>
</li>
<li><p>判断是否点击在包围盒上，从而响应预先绑定的点击事件</p>
</li>
</ol>
<p>源代码</p>
<p><a href="UGUIText组件实现图文混排——原理篇/UIGraphicText__lKh67xRzm.cs">UIGraphicText.cs</a></p>
<p><a href="UGUIText组件实现图文混排——原理篇/UIGraphicTextSpritesMgr_VeAnnPQruV.cs">UIGraphicTextSpritesMgr.cs</a></p>
<p><a href="UGUIText组件实现图文混排——原理篇/EmojiSpriteAsset_m_7Wcnb4Es.cs">EmojiSpriteAsset.cs</a></p>
<p><a href="UGUIText组件实现图文混排——原理篇/UIGraphicTextSprites_SJ0ts213El.cs">UIGraphicTextSprites.cs</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h2 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; title=&quot;目录&quot;&gt;&lt;/a&gt;目录&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#ugui-text组件实现图文混排&quot;&gt;UGUI Text组件
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="业务系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
    
      <category term="emoji" scheme="https://laoleo.github.io/tags/emoji/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/tags/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
  </entry>
  
  <entry>
    <title>图文混排-支持多个不同emoji来自不同图集和散图</title>
    <link href="https://laoleo.github.io/2021/11/11/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%962/"/>
    <id>https://laoleo.github.io/2021/11/11/UGUIText组件实现图文混排——项目优化2/</id>
    <published>2021-11-10T16:00:00.000Z</published>
    <updated>2022-12-07T13:37:02.710Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="图文混排-支持多个不同emoji来自不同图集和散图"><a href="#图文混排-支持多个不同emoji来自不同图集和散图" class="headerlink" title="图文混排-支持多个不同emoji来自不同图集和散图"></a>图文混排-支持多个不同emoji来自不同图集和散图</h1><p>之前针对表情不支持多图集的问题优化过一板，可以回顾下这篇文章：<a href="./UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96.md">UIGraphicText组件表情渲染优化-支持表情来之不同图集</a></p>
<p>但后来发现图文混排场景不支持多个不同emoji来自不同图集和散图，下面是问题描述。</p>
<p>PC下不打图集下发现，多个不同的emoji标签显示同一个emoji sprite。</p>
<p><img src="UGUIText组件实现图文混排——项目优化2/4c1118d6cb20ce80f3105b95502455c3.tmp" alt="C:\\88534cc8db9f6423fece8da47e598d32"><img src="UGUIText组件实现图文混排——项目优化2/7975d77768f66dd5b45d9ef03f066e45.tmp" alt="C:\\53fba21b5a4b310d26e01fbc92b36a2e"></p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a><strong>原因分析</strong></h2><p>每个text组件下只分配一个maskableGraphic组件，如其名可遮罩图形，该组件可以根据uv坐标来截取自身mainTexture上的区域，以渲染emoji。</p>
<p>当不打图集，uv坐标就代表整个mainTexture，也就是整张单图，而mainTexture同一时刻只能代表一张单图。</p>
<p>所以在这个例子中，所有的emoji都显示同一张图。</p>
<p>按照这个原理，即使在打图集的情况下，假如一行消息上的emoji并不是都来自同一个图集，那么显示上也会出问题。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a><strong>解决方案</strong></h2><p>这个问题的瓶颈在于maskableGraphic组件的数量，可以根据不同的texture来分配maskableGraphic组件来渲染emoji，这样就可以支持同时显示来自不同texture的emoji。</p>
<p>问题分拆：</p>
<ol>
<li>分组，按sprite的texture的不同来决定分配UIGraphiTextSprites组件（继承maskableGraphic），每个UIGraphiTextSprites组件负责渲染这个texture的emoji。</li>
<li>重构drawSprites方法逻辑以支持分组渲染emoji</li>
<li>处理Update逻辑以支持渲染动图</li>
</ol>
<p>但实践结果发现，按texture不同来分配maskableGraphic组件的方式并不适用于多个动图（动图即多个sprite切换）的情况，比如不打图集情况下有两个一样的动图emoji，当动图切换sprite texture时候，因为按texture分配组件所以两个一样的动图emoji只分配一个组件，前一个emoji会被后一个emoji抢占组件而不渲染。</p>
<p><img src="UGUIText组件实现图文混排——项目优化2/1b068870d1847acdd585381f49f9127c.tmp" alt="C:\\7a9f240bac4cb3c6c539f8bad0891c12"><img src="UGUIText组件实现图文混排——项目优化2/b1ea6bccc642c35685b0dd0f5671b303.tmp" alt="C:\\ad1a89e4b9b73f312118b21ca07bab28"></p>
<p>所以最终的方案为：</p>
<ol>
<li>区分静图和动图的emoji，静图的emoji按texture分配UIGraphiTextSprites组件</li>
<li>动图的emoji分配单独一个UIGraphiTextSprites组件负责渲染</li>
<li>UIGraphicTextSpritesMgr池化UIGraphiTextSprites组件，避免在消息列表界面频繁创建和销毁组件</li>
</ol>
<p>分配策略代码如下：</p>
<p>展开源码</p>
<p>UIGraphicTextSprites[] m_spriteGraphicArray;</p>
<p>private void DistributeTextSprite(List\&lt;SpriteTagInfor> listTag)</p>
<p>{</p>
<p>var staticEmojiDict = new Dictionary\&lt;Texture, List\&lt;int>>();</p>
<p>for (var i=0;i\&lt;listTag.Count;i++)</p>
<p>{</p>
<p>var tagInfor = listTag[i];</p>
<p>var animTagArray = m_AnimSpriteTag[i];</p>
<p>if (animTagArray.Length>1)</p>
<p>{</p>
<p>var textSprite = CreateTextSprite();</p>
<p>m_spriteGraphicArray[i] = textSprite;</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>var sprite = m_nameToSpriteDict[tagInfor.name];</p>
<p>if (!staticEmojiDict.ContainsKey(sprite.texture)) {</p>
<p>staticEmojiDict[sprite.texture] = new List\&lt;int>(){i};</p>
<p>}</p>
<p>staticEmojiDict[sprite.texture].Add(i);</p>
<p>}</p>
<p>}</p>
<p>// staticEmojiDict：{texture1=>{1，3}}</p>
<p>foreach (var item in staticEmojiDict)</p>
<p>{</p>
<p>var textSprite = CreateTextSprite();</p>
<p>foreach(var index in item.Value)</p>
<p>{</p>
<p>m_spriteGraphicArray[index] = textSprite;</p>
<p>}</p>
<p>}</p>
<p>}</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a><strong>具体实现</strong></h2><p>下面以渲染emoji的流程图来讲解讲解改造的过程。</p>
<img src="/2021/11/11/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%962/ebee4d8b9fab274fef93b95923e20796.tmp" class="" title="C:\\97daee51e2a0dadd426d08e8b46ba127">
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a><strong>遇到的问题</strong></h2><p>1.OnPopulateMesh中控制gameObject的slefActive会导致报错，与onLogCallBack有冲突。</p>
<img src="/2021/11/11/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%962/949ad5756a5f0697641e2267e54b6a2a.tmp" class="" title="C:\\c8e64b17c775c1a4b44a6a7a6a6354ce">
<p>“Trying to add…… while we are already inside a graphic rebuild loop.”这句是UGUI的报错，查看了UGUI的源码发现：</p>
<p>canvas刷新时，会将标记为dirty的UIElement重新构建，graphic类会生成网格时调用OnPopulateMesh。</p>
<p>这个时候Graphic类不能更改，更改会让canvas标记setDirty加入到待构建队列，而且在canvas刷新时不能禁止入队，所以报了这个错。</p>
<p>下面是UGUI的源码：</p>
<p><img src="UGUIText组件实现图文混排——项目优化2/889d57042c9cc1a988458e23e9617d0d.tmp" alt="C:\\8671ab9a5ec1a5f297a33d24684e119b"><img src="UGUIText组件实现图文混排——项目优化2/1ed8f3c55e63efc72047784eb2d715ec.tmp" alt="C:\\3b0528cdf5e8756c32cae65ffba1311a"><img src="UGUIText组件实现图文混排——项目优化2/35ae882a0e5fee85b1b7a102ba20976f.tmp" alt="C:\\11e53b162bb563663b032f919afcab4a"></p>
<p>即在OnPopulateMesh方法里不能执行setActive方法，可以放在base.SetCVerticesDirty方法里做。</p>
<p>2.重用cell的带sprite的text没有更新文本，只是调用了disable后调了enable，log：</p>
<p>因为是base.SetVertivesDirty方法前提前返回了，没有加入到canvas的待更新队列不会更新图形，所以不能这样做。</p>
<p>下面是引起错误的代码：</p>
<img src="/2021/11/11/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%962/83146e7e3d81e80b54edf6131d3203e2.tmp" class="" title="C:\\56a7b0dce321c762d3affc70752c805e">
<h2 id="测试与规范"><a href="#测试与规范" class="headerlink" title="测试与规范"></a><strong>测试与规范</strong></h2><p>兼容性排查，排查修改类被引用到的地方是否正常？</p>
<p>修改了UIGraphicText类和UIGraphicTextSprites类，两者在项目中引用我排查过，变更代码不会引起错误，但UIGraphicTextSprites类属于submodule的框架层，不知其他项目的情况。</p>
<p>测试案例如下：</p>
<p><img src="UGUIText组件实现图文混排——项目优化2/584310e308f30ee963734e6004db68f7.tmp" alt="C:\\b7c4a0986ebdf75c5ef2bda9f54b15cf"><img src="UGUIText组件实现图文混排——项目优化2/4e5d287689f65ab1fab2db8cc848f218.tmp" alt="C:\\b40295cf6f4f0fca2550c102727d03d9"></p>
<p>观察在各个平台上打不打图集的表现情况：</p>
<table>
<thead>
<tr>
<th><strong>测试平台</strong></th>
<th><strong>是否打图集</strong></th>
<th><strong>结果（emoji、多个emoji、动图emoji、动图）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Unity</td>
<td>不打</td>
<td>正常</td>
</tr>
<tr>
<td>Unity</td>
<td>打</td>
<td>正常</td>
</tr>
<tr>
<td>安卓</td>
<td>打</td>
<td>正常</td>
</tr>
<tr>
<td>IOS</td>
<td>打</td>
<td>正常</td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;图文混排-支持多个不同emoji来自不同图集和散图&quot;&gt;&lt;a href=&quot;#图文混排-支持多个不同emoji来自不同图集和散图&quot; class=&quot;headerlink&quot; title=&quot;图文混排-支持多个不同emoji来自
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="业务系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
    
      <category term="emoji" scheme="https://laoleo.github.io/tags/emoji/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/tags/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
  </entry>
  
  <entry>
    <title>游戏热更新</title>
    <link href="https://laoleo.github.io/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/"/>
    <id>https://laoleo.github.io/2021/09/10/游戏热更新/</id>
    <published>2021-09-09T16:00:00.000Z</published>
    <updated>2022-12-07T13:35:55.741Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="游戏热更新"><a href="#游戏热更新" class="headerlink" title="游戏热更新"></a>游戏热更新</h1><h2 id="version数据解析"><a href="#version数据解析" class="headerlink" title="version数据解析"></a>version数据解析</h2><p>在本地打包时会有跳过热更新或者测试热更新的需求，但没有文档解析打包界面version相关选项的作用，也不知道登录界面版本字符串的含义，所以这篇文章对打包过程的version相关参数和选项作详细解析，以及简单讲解游戏包更新流程。</p>
<img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image.png" class="">
<img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image_1.png" class="">
<h3 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h3><ul>
<li>Build Package的Version：仅用作展示，作为游戏登录界面的版本字符串的一部分。</li>
<li>Build Package的VersionCode：作为GameConst.txt里的NativeVersionCode，用来更新包外的GameConst.txt。当包内与包外的GameConst里的NativeVersionCode不同时，会覆盖外部GameConst.txt文件。另一个作用是作为请求remoteVersionManifest文件获取最新版本号的参数。</li>
<li>游戏常量配置的游戏是否启用热更新：对应GameConst.txt的gameOpenHotUpdate字段，可以忽略Version而跳过热更。</li>
</ul>
<img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image_2.png" class="">
<ul>
<li>登录界面的版本字符串分为MSDK和非MSDK格式，区别就是MSDK格式多了腾讯热更版本号，对游戏更新逻辑没影响。<ul>
<li>MSDK格式：V{msdkVersion}-{LocalVersion}-{VersionName}-{VersionCode}</li>
<li>非MSDK格式：V{LocalVersion}-{VersionName}-{VersionCode}</li>
</ul>
</li>
</ul>
<p>LocalVersion用于对比remoteVersion决定更新，VersionName对应Build Package的Version，VersionCode对应Build Package的VersionCode。</p>
<p>LocalVersion的值记录于Assets\Resources\version.manifest文件中</p>
<img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image_3.png" class="">
<h2 id="更新流程"><a href="#更新流程" class="headerlink" title="更新流程"></a>更新流程</h2><img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image_4.png" class="">
<p>版本号a.b.c各级的作用：</p>
<img src="/2021/09/10/%E6%B8%B8%E6%88%8F%E7%83%AD%E6%9B%B4%E6%96%B0/image_5.png" class="">
<h2 id="热更线程代码"><a href="#热更线程代码" class="headerlink" title="热更线程代码"></a>热更线程代码</h2><p><a href="游戏热更新/DownloadThread.cs">DownloadThread.cs</a></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// downloadFile用子线程实现，new Thread(new ThreadStart(RunDownloading))</span></span><br><span class="line"><span class="keyword">class</span> <span class="title">DownloadThread</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="keyword">if</span> (!_isStop || _thread != <span class="literal">null</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          CLogger.Log(<span class="string">&quot;DownloadThread::Start() - Download Thread Already Started:&quot;</span> + !_isStop + <span class="string">&quot;#thread:&quot;</span> + ((_thread == <span class="literal">null</span>) ? <span class="string">&quot;null&quot;</span> : _thread.ManagedThreadId.ToString()));</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      _isStop = <span class="literal">false</span>;</span><br><span class="line">      _thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ThreadStart(RunDownloading));</span><br><span class="line">      CLogger.Log(<span class="string">&quot;DownloadThread::Start() - Create Download Thread:&quot;</span> + _thread.ManagedThreadId);</span><br><span class="line">      _thread.IsBackground = <span class="literal">true</span>; <span class="comment">// 设置为后台线程，确保当主线程退出时该线程也会结束</span></span><br><span class="line">      _thread.Start();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RunDownloading</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (; ; )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (_isStop)</span><br><span class="line">                &#123;</span><br><span class="line">                    CLogger.Log(<span class="string">&quot;DownloadThread::RunDownloading() - Download Thread Meet Stop Flag,ThreadId:&quot;</span> + Thread.CurrentThread.ManagedThreadId);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (_currentTask == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">lock</span> (_pendingTasks)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> num = _pendingTasks.Count;</span><br><span class="line">                        <span class="keyword">if</span> (num &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            _currentTask = _pendingTasks.Dequeue();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            _isWaitting = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">this</span>.Wait();</span><br><span class="line">                            _isWaitting = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!_isStop &amp;&amp; _currentTask != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//Debug.Log (&quot;StartDownload&quot;);</span></span><br><span class="line">                    <span class="comment">// 开始断点续传下载文件</span></span><br><span class="line">                    DownloadFromBreakPoint(_currentTask);</span><br><span class="line">                    <span class="comment">//Debug.Log (&quot;EndDownload&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>lock关键字</p>
<p>IEquatasble <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lian--ying/p/9502879.html">https://www.cnblogs.com/lian–ying/p/9502879.html</a></p>
<h3 id="C-多线程编程"><a href="#C-多线程编程" class="headerlink" title="C#多线程编程"></a>C#多线程编程</h3><p><a target="_blank" rel="noopener" href="http://images.china-pub.com/ebook4610001-4615000/4613657/ch01.pdf">http://images.china-pub.com/ebook4610001-4615000/4613657/ch01.pdf</a></p>
<p><a target="_blank" rel="noopener" href="http://apps.mxinfos.com/电子书籍/多线程编程.pdf">http://apps.mxinfos.com/电子书籍/多线程编程.pdf</a></p>
<h3 id="断点续传"><a href="#断点续传" class="headerlink" title="断点续传"></a>断点续传</h3><p>下载热更文件使用了<strong>断点续传</strong>，原因是当下载大文件中途断网或退出时，可以保证下次更新在上次下载进度基础上继续正常下载。</p>
<p>断点续传需要服务端支持，需支持允许分段方式请求的文件数据。</p>
<p>使用http协议头字段range告知服务器下载文件字节数据范围值，例如：range:bytes=500-1000。配合If-Range:Etag/if-modified判断文件是否发生变化。详细看考这篇<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e8dee3dbc409">文章</a>。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关键代码</span></span><br><span class="line"><span class="keyword">if</span> (File.Exists(task.storagePath))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.从已下载部分数据的文件统计已下载字节数、剩余下载字节数</span></span><br><span class="line">    <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(task.storagePath, FileMode.OpenOrCreate, FileAccess.ReadWrite, FileShare.ReadWrite))</span><br><span class="line">    &#123;</span><br><span class="line">        receivedLength = fileStream.Length;</span><br><span class="line">        toDownloadLength = totalLength - receivedLength;</span><br><span class="line">        fileStream.Close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (receivedLength != dfi.receivedSize)</span><br><span class="line">    &#123;</span><br><span class="line">        CLogger.Log(<span class="built_in">string</span>.Format(<span class="string">&quot;DownloadThread::DownloadFromBreakPoint() - break point save receive size is wrong for file[&#123;0&#125;], saveSize=&#123;1&#125;, fileSize=&#123;2&#125;&quot;</span>, _currentTaskFileName, dfi.receivedSize, receivedLength));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">task.fileLength = totalLength;</span><br><span class="line">task.receivedLength = receivedLength;</span><br><span class="line">_currentTaskTotalBytes = totalLength;</span><br><span class="line">_currentTaskReceivedBytes = receivedLength;</span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span> transferOkay = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">if</span> (toDownloadLength &gt; <span class="number">0L</span>)</span><br><span class="line">&#123;</span><br><span class="line">    CLogger.Log(<span class="string">&quot;DownloadThread::DownloadFromBreakPoint() - start http download, The request url is [&quot;</span> + uri + <span class="string">&quot;] with range [&quot;</span> + receivedLength + <span class="string">&quot;,&quot;</span> + totalLength + <span class="string">&quot;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">    HttpWebRequest request2 = (HttpWebRequest)WebRequest.Create(uri);</span><br><span class="line">    request2.Timeout = kTimeOut;</span><br><span class="line">    request2.KeepAlive = <span class="literal">true</span>;</span><br><span class="line">    request2.ReadWriteTimeout = kTimeOut;</span><br><span class="line">    request2.AddRange((<span class="built_in">int</span>)receivedLength, (<span class="built_in">int</span>)totalLength);</span><br><span class="line"></span><br><span class="line">    HttpWebResponse response2 = (HttpWebResponse)request2.GetResponse();</span><br><span class="line">    transferOkay = <span class="keyword">this</span>.ReadBytesFromResponse(task, response2);</span><br><span class="line">    response2.Close();</span><br><span class="line">    request2.Abort();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (transferOkay)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.OnDownloadFinished(task, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.读取数据存储进文件</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">ReadBytesFromResponse</span>(<span class="params">DownloadTask task, WebResponse response</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">bool</span> okay = <span class="literal">false</span>;</span><br><span class="line">    DownloadFileTransferInfo fileInfo = _transferMgr.GetDownloadFileInfo(task.file);</span><br><span class="line">    FileUtils.Instance.CheckDirExistsForFile(task.storagePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(task.storagePath, task.receivedLength == <span class="number">0</span> ? FileMode.Create : FileMode.OpenOrCreate, FileAccess.ReadWrite, FileShare.ReadWrite))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 3.设置文件流的起始指针为已收到的字节大小</span></span><br><span class="line">      fileStream.Position = task.receivedLength;</span><br><span class="line">      <span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">      <span class="keyword">using</span> (Stream responseStream = response.GetResponseStream())</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">int</span> bytesRead = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> (task.receivedLength &lt; task.fileLength)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">// 4.读写流把数据从respone体中读出并写入到目标文件中</span></span><br><span class="line">              bytesRead = responseStream.Read(array, <span class="number">0</span>, array.Length);</span><br><span class="line">              fileStream.Write(array, <span class="number">0</span>, bytesRead);</span><br><span class="line">              task.receivedLength += bytesRead;</span><br><span class="line">              _currentTaskReceivedBytes = task.receivedLength;</span><br><span class="line"></span><br><span class="line">              _transferMgr.UpdateFileTransferProgress(fileInfo, task.receivedLength);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          okay = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (task.receivedLength != task.fileLength)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="built_in">string</span> s = <span class="built_in">string</span>.Format(<span class="string">&quot;DownloadThread::ReadBytesFromResponse() - Download length not fit Error:&#123;0&#125;/&#123;1&#125;&quot;</span>, task.receivedLength, task.fileLength);</span><br><span class="line">          CLogger.LogError(s);</span><br><span class="line">          okay = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">this</span>.OnDownloadFinished(task, <span class="keyword">new</span> Exception(s));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> okay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面断点续传的是ab文件，下面续传zip文件：</p>
<p><a href="游戏热更新/BreakpointTransferZip.cs">BreakpointTransferZip.cs</a></p>
<h2 id="热更包与基线"><a href="#热更包与基线" class="headerlink" title="热更包与基线"></a>热更包与基线</h2><h3 id="热更文件检出"><a href="#热更文件检出" class="headerlink" title="热更文件检出"></a>热更文件检出</h3><p>热更包的资源文件通过对比两个版本的资源变更情况得出</p>
<p>用git对比？选出具有相同目录结构文件？</p>
<p>网上的一般方式是用<strong>MD5</strong>检出变更的文件，服务器会下发最新版文件的MD5信息，用之和本地文件MD5对比。</p>
<p>应不用选出具有相同目录结构的文件包，服务端会下发热更文件的相对存储路径。</p>
<p><strong>基线怎么来呢？</strong></p>
<p>很简单，记录上一次打包的所有ab到cache文件即可。百田热更基线记录abCache的时机为每次发热更包后，腾讯的则是发整包版本后。</p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;游戏热更新&quot;&gt;&lt;a href=&quot;#游戏热更新&quot; class=&quot;headerlink&quot; title=&quot;游戏热更新&quot;&gt;&lt;/a&gt;游戏热更新&lt;/h1&gt;&lt;h2 id=&quot;version数据解析&quot;&gt;&lt;a href=&quot;#versio
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="基础系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="热更新" scheme="https://laoleo.github.io/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/"/>
    
  </entry>
  
  <entry>
    <title>射箭小游戏</title>
    <link href="https://laoleo.github.io/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/"/>
    <id>https://laoleo.github.io/2021/06/22/射箭小游戏/</id>
    <published>2021-06-21T16:00:00.000Z</published>
    <updated>2022-12-07T13:35:47.417Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="射箭小游戏"><a href="#射箭小游戏" class="headerlink" title="射箭小游戏"></a>射箭小游戏</h1><img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_bPic0MSA86.png" class="">
<h3 id="碰撞检测"><a href="#碰撞检测" class="headerlink" title="碰撞检测"></a>碰撞检测</h3><p>属于2D游戏，没有深度，碰撞检测采用判断两线段是否相交的方法，即箭头两帧之间位置线段与箭靶中心为原点的xy轴中心线两线段。</p>
<img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_jB99fdiEFy.png" class="">
<p>之所以选择这种判断方法，是因为中靶的位置是算分数的一个因素，不能像射气球那种带碰撞盒的方式，箭进入碰撞盒后就会立刻停止。这样的得分效果不好，只能拿到击中边缘的3分。</p>
<p>假如两帧的线段同时与两中心线相交，优先取与y轴平行的中心线交点，因为箭停留在靶上的效果较好。</p>
<p>实际效果发现与x轴平行的右半段，会很大概率挡住箭射中Y轴中心线，这样效果不好。右半段是为了托住箭避免没中Y轴线而穿靶，所以可以加个检测前提。</p>
<h4 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h4><p>判断二维平面两线段是否相交代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 求线段交点，以解线性方程组的方式</span></span><br><span class="line"><span class="comment">-- @param p0 Vector2</span></span><br><span class="line"><span class="comment">-- @return 线段是否相交,交点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GameUtils.calcIntersectionOfLinear2D</span><span class="params">(p0, p1, p2, p3)</span></span></span><br><span class="line">    <span class="comment">-- 直线的一般方程为F(x) = ax + by + c = 0</span></span><br><span class="line">    <span class="comment">-- 已知两点可得：a = y0 – y1, b = x1 – x0, c = x0y1 – x1y0</span></span><br><span class="line">    <span class="comment">-- 可推出两直线交点：</span></span><br><span class="line">    <span class="comment">-- x = (b0*c1 – b1*c0)/D</span></span><br><span class="line">    <span class="comment">-- y = (a1*c0 – a0*c1)/D</span></span><br><span class="line">    <span class="comment">-- D = a0*b1 – a1*b0， (D为0时，表示两直线重合)</span></span><br><span class="line">    <span class="keyword">local</span> a0=p0.y-p1.y</span><br><span class="line">  <span class="keyword">local</span> b0=p1.x-p0.x</span><br><span class="line">  <span class="keyword">local</span> c0=p0.x*p1.y-p0.y*p1.x</span><br><span class="line">    <span class="keyword">local</span> a1=p2.y-p3.y</span><br><span class="line">  <span class="keyword">local</span> b1=p3.x-p2.x</span><br><span class="line">  <span class="keyword">local</span> c1=p2.x*p3.y-p2.y*p3.x</span><br><span class="line">    <span class="keyword">local</span> D=a0*b1-a1*b0</span><br><span class="line">    <span class="keyword">if</span> D == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">local</span> x=(b0*c1-b1*c0)/D</span><br><span class="line">    <span class="keyword">local</span> y=(c0*a1-c1*a0)/D</span><br><span class="line">    <span class="comment">-- 判断交点是否在两条线段上</span></span><br><span class="line">    <span class="keyword">local</span> EPSINON = <span class="number">0.000001</span> <span class="comment">--浮点数相减的结果的不精确问题</span></span><br><span class="line">    <span class="keyword">if</span> (x - p0.x) * (x - p1.x) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (y - p0.y) * (y - p1.y) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (x - p2.x) * (x - p3.x) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (y - p2.y) * (y - p3.y) &lt;= EPSINON </span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, Vector2.New(x, y)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>, Vector2.New(x, y)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在实现线段的碰撞检测中踩了些坑，总结两点注意点：</p>
<ol>
<li>两帧之间的位置坐标点不要采取预测下一帧位置的方式，而是保留上一帧位置。因为用默认一帧deltaTime（约0.034,30帧）预测下一帧位置，可能由于卡帧导致跟实际下一帧的位置出现带有隐患的相差，假如这个相差的距离刚好包含了中心位置，就会出现穿透现象。写这么长，不如画个图：</li>
</ol>
<img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_fNhLsjLAng.png" class="">
<ol>
<li>浮点数运算精度缺失问题。坐标点的值时浮点数，判断相等时候要注意，不能使用全等，即使两个相等浮点数相减不一定每次都等于0，使用允许误差范围判断math.abs(a -b) &lt; c，c为使用场景下允许的最大误差.</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (x - p0.x) * (x - p1.x) &lt;= <span class="number">0</span> <span class="keyword">and</span> </span><br><span class="line">        (y - p0.y) * (y - p1.y) &lt;= <span class="number">0</span> <span class="keyword">and</span> </span><br><span class="line">        (x - p2.x) * (x - p3.x) &lt;= <span class="number">0</span> <span class="keyword">and</span> </span><br><span class="line">        (y - p2.y) * (y - p3.y) &lt;= <span class="number">0</span></span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">改为：</span><br><span class="line"><span class="keyword">local</span> EPSINON = <span class="number">0.000001</span></span><br><span class="line"><span class="keyword">if</span> (x - p0.x) * (x - p1.x) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (y - p0.y) * (y - p1.y) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (x - p2.x) * (x - p3.x) &lt;= EPSINON <span class="keyword">and</span> </span><br><span class="line">        (y - p2.y) * (y - p3.y) &lt;= EPSINON </span><br><span class="line"><span class="keyword">then</span></span><br></pre></td></tr></table></figure>
<p>3.检测移动靶的碰撞检测问题。当靶与箭相向运动，靶移动速度过快，同时箭的移动速度过慢（两帧之间线段太短），就会很大概率出现穿透问题。有个很简单的解决方法，检测移动靶时候箭两帧之间的线段不能过小 （小于阈值时适当延长），而且策划的配置不会配太快的靶，这样就基本能避免检测移动物体的穿透问题。有时候限制bug发生的条件也可以简单地解决问题。</p>
<p>但是还是发现偶然小概率有穿靶情况，假如两帧之间最短距离定得太大，击中时箭会有种被靶吸附的效果，不太好。认真观察这个bug，箭刚好错过了移动靶的中位线时正好都未于靶右半部分。网上有个方法是增大碰撞区域，这里可以将靶右半部分作为碰撞盒，引入碰撞盒检测。</p>
<img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_9kEuPrkNrd.png" class="">
<p>综上所述，得出碰撞检测的最佳实践是：</p>
<p>1.优先检查Y轴中心线</p>
<p>2.将x轴中心线以圆心分成两段，检测是否与半段相交。</p>
<p>3.否则判断箭是否下落状态并且下落角度大于45度，检测是否与右半段相交。</p>
<p>4.否则检测箭是否位于靶右半边区域，并且箭在上升，则碰撞；或者箭下降且到了中心点y轴一下区域，则碰撞。</p>
<h3 id="摇杆拉弓效果"><a href="#摇杆拉弓效果" class="headerlink" title="摇杆拉弓效果"></a>摇杆拉弓效果</h3><p>摇杆拉弓弓弦表现伸缩性</p>
<img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_eBJv4Og4HY.png" class="">
<p>通过拉伸弓弦图片width来实现，但有个问题是弓弦的粗细程度会跟着伸缩而改变，在大小比较小的情况下表现不太明显，可以接受。</p>
<h3 id="轨迹预览"><a href="#轨迹预览" class="headerlink" title="轨迹预览"></a>轨迹预览</h3><img src="/2021/06/22/%E5%B0%84%E7%AE%AD%E5%B0%8F%E6%B8%B8%E6%88%8F/image_0xirtCNbHW.png" class="">
<p>这个轨迹实现有三步：</p>
<ol>
<li><p>初始化克隆出一系列轨迹点</p>
</li>
<li><p>抽离出箭移动公式，输入时刻输出位置</p>
</li>
<li><p>在拖拽监听中设置一系列轨迹点的位置</p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;射箭小游戏&quot;&gt;&lt;a href=&quot;#射箭小游戏&quot; class=&quot;headerlink&quot; title=&quot;射箭小游戏&quot;&gt;&lt;/a&gt;射箭小游戏&lt;/h1&gt;&lt;img src=&quot;/2021/06/22/%E5%B0%84%E7%AE
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="业务系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="小游戏" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/%E5%B0%8F%E6%B8%B8%E6%88%8F/"/>
    
    
      <category term="小游戏" scheme="https://laoleo.github.io/tags/%E5%B0%8F%E6%B8%B8%E6%88%8F/"/>
    
  </entry>
  
  <entry>
    <title>新手引导系统</title>
    <link href="https://laoleo.github.io/2021/04/09/%E6%96%B0%E6%89%8B%E5%BC%95%E5%AF%BC%E7%B3%BB%E7%BB%9F/"/>
    <id>https://laoleo.github.io/2021/04/09/新手引导系统/</id>
    <published>2021-04-08T16:00:00.000Z</published>
    <updated>2022-12-07T13:35:39.593Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#新手引导系统">新手引导系统</a><ul>
<li><a href="#需求分析">需求分析</a></li>
<li><a href="#系统设计架构">系统设计架构</a></li>
<li><a href="#新手指引遮罩">新手指引遮罩</a></li>
<li><a href="#行为树">行为树</a></li>
</ul>
</li>
</ul>
<h1 id="新手引导系统"><a href="#新手引导系统" class="headerlink" title="新手引导系统"></a>新手引导系统</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><ol>
<li><p>强制引导。必须要完成的，常见是进入游戏新手副本。</p>
</li>
<li><p>条件触发引导。由各种条件达成触发，如达到等级，通关副本等。</p>
</li>
<li><p>中断后再次执行。玩家因异常或主动退出中断引导，根据关键步是否完成情况决定是否再次打开。</p>
</li>
<li><p>异常处理。当条件不满足时执行具体的处理方法。比如提交物品，不存在对应物品，引导直接结束。</p>
</li>
<li><p>附加协议。用于某些关键步，确定收发了指定协议然后确定步骤是否完成。比如引导召唤就判断召唤协议是否返回。</p>
</li>
<li><p>并行。引导动作是否并行执行，比如战斗引导中，英雄挂了，并行执行救援引导。</p>
</li>
</ol>
<h2 id="系统设计架构"><a href="#系统设计架构" class="headerlink" title="系统设计架构"></a>系统设计架构</h2><img src="/2021/04/09/%E6%96%B0%E6%89%8B%E5%BC%95%E5%AF%BC%E7%B3%BB%E7%BB%9F/image_BXoVzPQBan.png" class="">
<h2 id="新手指引遮罩"><a href="#新手指引遮罩" class="headerlink" title="新手指引遮罩"></a>新手指引遮罩</h2><p>挖空矩形遮罩上的目标显示区域实现</p>
<ol>
<li><p>编写继承Graphic的脚本类，绑定在mask view上</p>
</li>
<li><p>根据指定的节点，计算中心点，宽高等数据，确定挖孔区域</p>
</li>
<li><p>在OnPopulateMesh回调中重绘顶点数据，绘制四个矩形组成的一个中间空的图形，这个就是所谓的挖孔实现</p>
</li>
<li><p>脚本类集成IPointerClickHandler接口，在OnPointerClick回调中根据鼠标点位置，判断是否点击在挖孔区域内，接着执行lua点击回调，同时传递点击事件</p>
</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecuteEvents.Execute(arrow.gameObject, ed, ExecuteEvents.pointerClickHandler);</span><br></pre></td></tr></table></figure>
<h2 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h2><p>利用行为树控制整个流程，一个引导执行完毕后接着执行另一个引导。</p>
<ol>
<li><p>action的执行有行为树FlowSequence类控制，action作为它的children节点，控制其串行执行</p>
</li>
<li><p>每个节点有状态和结果两个属性，onStart()开始执行，执行完成调用onDone()，通知父节点执行next child的onStart()</p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h2 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; title=&quot;目录&quot;&gt;&lt;/a&gt;目录&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#新手引导系统&quot;&gt;新手引导系统&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a 
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="业务系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="新手引导" scheme="https://laoleo.github.io/tags/%E6%96%B0%E6%89%8B%E5%BC%95%E5%AF%BC/"/>
    
  </entry>
  
  <entry>
    <title>海外版本diff工具</title>
    <link href="https://laoleo.github.io/2021/03/18/%E6%B5%B7%E5%A4%96%E7%89%88%E6%9C%ACdiff%E5%B7%A5%E5%85%B7/"/>
    <id>https://laoleo.github.io/2021/03/18/海外版本diff工具/</id>
    <published>2021-03-17T16:00:00.000Z</published>
    <updated>2022-12-07T13:35:29.622Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#海外版本diff工具">海外版本diff工具</a><ul>
<li><a href="#一背景">一、背景</a></li>
<li><a href="#二使用介绍">二、使用介绍</a></li>
<li><a href="#三实现思路">三、实现思路</a></li>
<li><a href="#四sh脚本语法">四、sh脚本语法</a></li>
</ul>
</li>
</ul>
<h1 id="海外版本diff工具"><a href="#海外版本diff工具" class="headerlink" title="海外版本diff工具"></a>海外版本diff工具</h1><h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>海外版本是从国内版本基础上做差异化替换而来，代码上采用replaceModule的方式覆盖重写module的方法，资源上优先加载对应语言目录下的替换资源。</p>
<p>这种方案决定了，大多数替换内容（代码、预制物等） 是在源内容的基础上演变而来，依赖源内容。当合并国内版本后，需要检查源内容做了什么哪些修改，代码上有没有逻辑冲突，预制资源方面需不需要更新。</p>
<p>可以总结有两个需求：</p>
<ol>
<li><p>检查replace的module在合并前后代码有哪些更新</p>
</li>
<li><p>检查出替换的预制在合并前后有哪些是更新了</p>
</li>
</ol>
<p>更新：</p>
<p>追加了其他两个需求：</p>
<p>1.检查多语言的scene目录资源在合并前后的更改和新增情况</p>
<p>2.检查fmod资源的更新情况</p>
<h2 id="二、使用介绍"><a href="#二、使用介绍" class="headerlink" title="二、使用介绍"></a>二、使用介绍</h2><img src="/2021/03/18/%E6%B5%B7%E5%A4%96%E7%89%88%E6%9C%ACdiff%E5%B7%A5%E5%85%B7/image_lch2ake5uD.png" class="">
<p>选项介绍：</p>
<ul>
<li><p>语言类型：选择当前语言类型，必填。</p>
</li>
<li><p>合并后版本号：海外dev分支合并国服版本后的commitID，commitID太长不一定需要填全部，git能够识别commit即可，必填。</p>
</li>
<li><p>合并前版本号：海外的dev分支合并国服版本前的commitID，必填。</p>
</li>
<li><p>自定义执行shell文件的exe路径：用于执行diff.sh脚本的shell exe路径。假如你的系统有git-bash.exe，填它的路径也可以。windows上必填，因为windows上默认的终端可能是cmd.exe，它执行shell文件会不成功。mac系统可以不填。</p>
</li>
</ul>
<p>比如台湾版本：</p>
<p>语言类型选：tw</p>
<p>合并前后版本到gitlab pjg-client仓库commit栏目上找commitID。</p>
<p>功能介绍：</p>
<ul>
<li><p>导出replace module更改：将replace module代码文件的差异导出到桌面上，文件名replace-module-{commitID0}-{commitID1}.diff。</p>
</li>
<li><p>导出多语言目录zh/ui/views下的预制perfab文件更新情况：将多语言目录下ui的prefab文件对应的zh目录源文件在两个版本间的差异，和zh目录下新增但海外语言目录没有的预制内容导出到桌边，文件名zh-UIPrefab-{commitID0}-{commitID1}.diff。</p>
</li>
<li><p>导出多语言目录zh/scene下所有资源的更新情况：同上，多语言目录的资源对应的zh目录下的资源，对比两个版本前后zh目录的资源更新情况和新增情况，然后由场景决定是否需要更新对应多语言（如tw）目录的资源。执行会导出diff文件到桌面。</p>
</li>
<li><p>导出fmod event的更改情况：检出更改的文件，决定是否更改对应多语言目录下的文件。</p>
</li>
</ul>
<h2 id="三、实现思路"><a href="#三、实现思路" class="headerlink" title="三、实现思路"></a>三、实现思路</h2><img src="/2021/03/18/%E6%B5%B7%E5%A4%96%E7%89%88%E6%9C%ACdiff%E5%B7%A5%E5%85%B7/image_y5ou7bMrqO.png" class="">
<p>实现原理很简单，就是找出相应的文件名，调用git diff命令输出差异即可。</p>
<h2 id="四、sh脚本语法"><a href="#四、sh脚本语法" class="headerlink" title="四、sh脚本语法"></a>四、sh脚本语法</h2><p>工具利用c# API Process类执行sh脚本，diff.sh脚本主要做两件事情，一是解析参数，二是调用git diff命令。</p>
<p>这里简单解析下sh语法，帮助理解代码。</p>
<p>1、获取参数<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="variable">$@</span></span><br></pre></td></tr></table></figure></p>
<p>2、定义数组<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">commitIdArr</span><span class="operator">=</span>()</span><br></pre></td></tr></table></figure><br>3、数值自增<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="name">commitIdArr</span><span class="character">\_</span>index++))</span><br></pre></td></tr></table></figure><br>4、获取变量值<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$moduleNameArr_index</span>或者<span class="variable">$&#123;outputFileName&#125;</span></span><br></pre></td></tr></table></figure><br>5、输出数组内容<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo moduleNameArr\[<span class="symbol">@]</span></span><br></pre></td></tr></table></figure><br>6、数组长度<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="variable">$&#123;</span><span class="comment">#moduleNameArr\[@]&#125;</span></span><br></pre></td></tr></table></figure><br>学习shell脚本语法可以查看这里：<a target="_blank" rel="noopener" href="https://www.runoob.com/linux/linux-shell.html" title="shell教程">shell教程</a>。</p>
<p>代码：</p>
<p><a href="海外版本diff工具/LanguageDiffWindow_xSMzWdHsMs.cs">LanguageDiffWindow.cs</a></p>
<p><a href="海外版本diff工具/diff_7U8prTz5se.sh">diff.sh</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h2 id=&quot;目录&quot;&gt;&lt;a href=&quot;#目录&quot; class=&quot;headerlink&quot; title=&quot;目录&quot;&gt;&lt;/a&gt;目录&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;#海外版本diff工具&quot;&gt;海外版本diff工具&lt;/a&gt;&lt;ul&gt;
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="基础系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="多语言" scheme="https://laoleo.github.io/tags/%E5%A4%9A%E8%AF%AD%E8%A8%80/"/>
    
      <category term="海外" scheme="https://laoleo.github.io/tags/%E6%B5%B7%E5%A4%96/"/>
    
  </entry>
  
  <entry>
    <title>UIGraphicText表情渲染优化-支持表情来自不同图集</title>
    <link href="https://laoleo.github.io/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/"/>
    <id>https://laoleo.github.io/2021/02/25/UGUIText组件实现图文混排——项目优化/</id>
    <published>2021-02-24T16:00:00.000Z</published>
    <updated>2022-12-07T13:35:21.071Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="UIGraphicText表情渲染优化-支持表情来自不同图集"><a href="#UIGraphicText表情渲染优化-支持表情来自不同图集" class="headerlink" title="UIGraphicText表情渲染优化-支持表情来自不同图集"></a>UIGraphicText表情渲染优化-支持表情来自不同图集</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>当表情sprite没有被打到一个图集上，UIGraphicText类渲染表情或会错乱。</p>
<h2 id="表情的渲染过程"><a href="#表情的渲染过程" class="headerlink" title="表情的渲染过程"></a>表情的渲染过程</h2><p>聊天窗口表情的渲染过程大致如何：</p>
<img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/620aa9915773654e87c2ed8201b32736.png" class="" title="C:\\454369bfe7514cfa65961fb357f5a99b">
<ul>
<li>ui_emoji.asset包含所有emoji sprite信息，包括name、引用等。</li>
<li>UIGraphicText主要是解析输入内容字符串，得出sprite的顶点几何参数等。</li>
<li>CanvasRender应是负责渲染的。</li>
<li>UIGraphicTextSprites继承自<a target="_blank" rel="noopener" href="https://docs.unity.cn/cn/current/ScriptReference/UI.MaskableGraphic.html">MaskableGraphic</a>类，这个类的作用是管理源图集，截取源图集的某个区域。</li>
</ul>
<p>获取源图集的代码：</p>
<img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/78a230605169741abf7b42ea9cf32942.tmp" class="" title="C:\\5c36480e5fd362841a9fda19931987af">
<p>表情的源图集引用被写死，默认第一个表情的源图集。这就是当表情来自其他图集时，显示错误的原因。</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>目前所有的表情会打到一个图集上，下面两种场景会导致表情打到不同图集：</p>
<ol>
<li>表情增加，直到2048*2048大小装不下（图集maxsize为2048是项目组限制，因为在一些低端机上加载不了大于2048的图）</li>
<li>表情sprite的tag不一致，需要用别的tag划分表情（tag决定sprite所属的图集）</li>
</ol>
<p>为了满足以上两种场景，需要对这个系统进行优化，支持表情来自不同的图集。</p>
<p>有两个步骤：</p>
<ol>
<li>更改mainTexture获取</li>
</ol>
<p>展开源码</p>
<p>// UIGraphicTextSprites.cs</p>
<p>public class UIGraphicTextSprites : MaskableGraphic</p>
<p>{</p>
<p>…</p>
<p>private Texture _texSource; // 由外部传入改写mainTexture</p>
<p>public override Texture mainTexture</p>
<p>{</p>
<p>get</p>
<p>{</p>
<p>if (m_spriteAsset == null)</p>
<p>return s_WhiteTexture;</p>
<p>if (m_spriteAsset.listSpriteInfor == null || m_spriteAsset.listSpriteInfor.Count == 0)</p>
<p>{</p>
<p>return s_WhiteTexture;</p>
<p>}</p>
<p>if (_texSource != null)</p>
<p>{</p>
<p>return _texSource;</p>
<p>}</p>
<p>var texSource = m_spriteAsset.listSpriteInfor[0].sprite.texture;</p>
<p>if (texSource == null)</p>
<p>return s_WhiteTexture;</p>
<p>else</p>
<p>return texSource;</p>
<p>}</p>
<p>}</p>
<p>public void SetMainTexture(Texture t)</p>
<p>{</p>
<p>_texSource = t;</p>
<p>}</p>
<p>…</p>
<p>}</p>
<p>2. 更改对应的源图集</p>
<p>展开源码</p>
<p>// UIGraphicText.cs</p>
<p>void CalcQuadTag(IList\&lt;UIVertex> verts)</p>
<p>{</p>
<p>…</p>
<p>Texture texSource = listSpriteInfor[0].sprite.texture;</p>
<p>for (int j = 0; j \&lt; listSpriteInfor.Count; j++)</p>
<p>{</p>
<p>//通过标签的名称去索引spriteAsset里所对应的sprite的名称</p>
<p>if (listTagInfor[i].name == listSpriteInfor[j].name) {</p>
<p>spriteRect = listSpriteInfor[j].sprite.textureRect;</p>
<p>texSource = listSpriteInfor[j].sprite.texture;</p>
<p>m_spriteGraphic.SetMainTexture(texSource);</p>
<p>break;</p>
<p>}</p>
<p>}</p>
<p>// Texture texSource = listSpriteInfor[0].sprite.texture;</p>
<p>…</p>
<p>}</p>
<h3 id="0714更新"><a href="#0714更新" class="headerlink" title="0714更新"></a>0714更新</h3><p>发现动态表情在pc上不打图集情况下显示有问题，表情并没有想预期一样动，有的甚至不动。</p>
<p>动态表情的实现原理是按一定的帧率改变sprite的顶点、uv和网格三角形参数，通过CanvasRenderer组件和UIGraphicTextSprites组件（继承MaskableGraphic），截取源图texture（sprite或者图集）得到显示区域。</p>
<p>原因是不打图集时，动态表情的源图获取不正确，截取的源图永远是第一张。</p>
<p>解决方法是在Update()中切换sprite截取参数同时改变UIGraphicTextSprites的mainTexture。</p>
<p>更改commit看这里。</p>
<h2 id="检验"><a href="#检验" class="headerlink" title="检验"></a>检验</h2><p>我的unity目标平台是android，先将textureImporter对安卓图片压缩格式更改代码注释掉，否则更改压缩格式会被重置。</p>
<img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/3dbde81dd90a3504f493adc0aeb348f5.tmp" class="" title="C:\\c1b700ce925f6782c0ddfad7ebaff16d">
<p>更改1601_1,1602_1,1603_1的format为区别于ETC2_RGBA8的其他格式，测试不同压缩格式打包不同图集的场景：</p>
<img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/03742e0b64e62e87941c5ff8441ee88a.tmp" class="" title="C:\\fe883496df4caacccd989e850fccc8ca">
<p>更改1604_1,1605_1的tag，测试不同tag打包到不同图集的场景：</p>
<img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/c9e62ff06615ff8ab9ab1b914721f146.tmp" class="" title="C:\\f99e868b89f1a7b9ab3af6a5c9fdac1d">
<p>sprite packer上pack图集，检查表情的确打到了三个不同的图集：</p>
<p><img src="UGUIText组件实现图文混排——项目优化/10e1096586b53ed9f944e9d5101c4241.tmp" alt="C:\\883fd9a545661d5f5811d3edac78f399"><img src="UGUIText组件实现图文混排——项目优化/dc44a3625ccf585467173a0f9a8e574f.tmp" alt="C:\\c0bf4aa254b650fb676bfa50bfbec15f"> <img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/1b0894421887907ac78332cb31b81eca.tmp" class="" title="C:\\094eb1d714aefb5993a488081c763144"> <img src="/2021/02/25/UGUIText%E7%BB%84%E4%BB%B6%E5%AE%9E%E7%8E%B0%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92%E2%80%94%E2%80%94%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96/ceb2cc566e9ddb1db29fc8a826ecd3a1.tmp" class="" title="C:\\e4ce0e9521e9b633c56b0d462711f669"></p>
<p>pc上测试，正常。</p>
<p>安卓上测试，正常。</p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;UIGraphicText表情渲染优化-支持表情来自不同图集&quot;&gt;&lt;a href=&quot;#UIGraphicText表情渲染优化-支持表情来自不同图集&quot; class=&quot;headerlink&quot; title=&quot;UIGraphi
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="业务系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%B8%9A%E5%8A%A1%E7%B3%BB%E7%BB%9F/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
    
      <category term="emoji" scheme="https://laoleo.github.io/tags/emoji/"/>
    
      <category term="图文混排" scheme="https://laoleo.github.io/tags/%E5%9B%BE%E6%96%87%E6%B7%B7%E6%8E%92/"/>
    
      <category term="UGUI" scheme="https://laoleo.github.io/tags/UGUI/"/>
    
  </entry>
  
  <entry>
    <title>游戏中特效加载原理和优化方法</title>
    <link href="https://laoleo.github.io/2021/01/25/%E6%B8%B8%E6%88%8F%E4%B8%AD%E7%89%B9%E6%95%88%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E5%92%8C%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95/"/>
    <id>https://laoleo.github.io/2021/01/25/游戏中特效加载原理和优化方法/</id>
    <published>2021-01-24T16:00:00.000Z</published>
    <updated>2022-12-07T13:34:27.932Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<p>游戏项目中一般会用到一些优化手段，大部分优化的是资源的大小对内存的影响，比如项目中特效的加载会拥有两个类：photoFactoryEffect和photoMutilEffect</p>
<p><strong>photoFactory与photoMutil的区别</strong></p>
<p>photoFactory是一个优化类，作用就是减轻通过photoMutil生成的特效克隆go的大小，优化的是内存</p>
<p>photoMutil生成一个挂载特效rt的go，真正管理特效的是photoProducer。</p>
<p><strong>特效加载原理</strong></p>
<p>特效的gameObject通过camaro和rt映射到其他的gameObject上，一个特效只会加载一次，利用rt分发多份。</p>
<p>// PhotoEffectFactory.lua  module(“logic.common.ugui.PhotoEffectFactory”,package.seeall)  local PhotoEffectFactory = class(“PhotoEffectFactory”)  function PhotoEffectFactory:ctor()     self._factoryContainer = goutil.create(“PHOTOFACTORYROOT”, false)     GameUtils.setPos(self._factoryContainer, -2500, 0, 0)     – 所有生效的特效     self._effects={}     – 池化     self._pool=ObjectPool.New(20,PhotoEffectFactory._createEffect,         PhotoEffectFactory._disposeEffect,         PhotoEffectFactory._resetEffect         ) end  function PhotoEffectFactory._createEffect()     local effect = {}     local container = goutil.create(“eff”, true)     container.layer = Framework.LayerUtil.NameToLayer(SceneLayer.UI)     effect.container = container     effect.photoEff = Framework.LuaComponentContainer.Add(container, PhotoMultiEffect)     effect.photoEff:setEffectLoadedCallback(PhotoEffectFactory._onEffectLoaded, PhotoEffectFactory.instance)     –克隆的特效     effect.clones={}     – 引用数     effect.count=0     return effect end  function PhotoEffectFactory._resetEffect(effect)     effect.count=0     effect.clones={}     effect.photoEff:clear() end  function PhotoEffectFactory._disposeEffect(effect)     if not goutil.isNil(effect.container) then          goutil.destroy(effect.container)     end end  – 外部接口：提供256 * 144规格的RT特效克隆体 –uiWidth, uiHeight  需要显示的ui尺寸，请根据具体界面情况传入 function PhotoEffectFactory:getSmallClonePhotoEffect(url, uiWidth, uiHeight)     return self:getClonePhotoEffect(url, PhotoUtil.SmallRTWidth, PhotoUtil.SmallRTHeight, uiWidth, uiHeight) end  – 外部接口：重新播放RT特效 function PhotoEffectFactory:rePlayPhotoEffect(url)     local photoData = url and self._effects[url]     if photoData then         if not goutil.isNil(photoData.orgGoInst) then             goutil.setActive(photoData.orgGoInst, false)             goutil.setActive(photoData.orgGoInst, true)         end     end end  – 获取克隆的RT特效预制物 –uiWidth, uiHeight  需要显示的ui尺寸，请根据具体界面情况传入 function PhotoEffectFactory:getClonePhotoEffect(url, rtWidth, rtHeight, uiWidth, uiHeight)     if GameUtils.isEmptyString(url) then         return     end     – 如果未生成     local eff=self._effects[url]     if eff==nil then         eff=self._pool:fetchObject()         local container=eff.container         rtWidth = rtWidth or PhotoUtil.PartRTWidth         rtHeight = rtHeight or PhotoUtil.PartRTHeight         goutil.setWidth(container.transform, uiWidth or rtWidth)–ui尺寸默认是rt大小         goutil.setHeight(container.transform, uiHeight or rtHeight)         – 放在factory root 下         goutil.addChildToParent(eff.container, self._factoryContainer)         – rename         eff.container.name=url         self._effects[url]=eff         –临时处理，后续优化         if rtWidth == PhotoUtil.SmallRTWidth and rtHeight == PhotoUtil.SmallRTHeight then             eff.photoEff:showSmallEffect(url)         else                     eff.photoEff:showPartEffect(url)         end     end      eff.count = eff.count + 1     –只是克隆rawImage，transform     local objClone = goutil.create(tostring(eff.count),true)     objClone.layer = Framework.LayerUtil.NameToLayer(SceneLayer.UI)     GameUtils.copyRectTransform(objClone:GetComponent(goutil.Type_RectTransform), eff.container:GetComponent(goutil.Type_RectTransform))     GameUtils.copyRawImage(objClone:AddComponent(typeof(UnityEngine.UI.RawImage)), eff.container:GetComponent(typeof(UnityEngine.UI.RawImage)))     – local objClone = goutil.clone(self._urlToPhotoDict[url].container, tostring(self._urlToPhotoDict[url].count))     —————————–     – 判断当前特效是否已经加载完成，是则直接显示     if eff.photoEff:checkIsFinishLoadByUrl(url) then         local rawImageComp = objClone:GetComponent(typeof(UnityEngine.UI.RawImage))         if rawImageComp then             rawImageComp.enabled = true         end     end     table.insert(eff.clones, objClone)     return objClone end  – 判断创建出来的GameObject的RT与复制品的RT是否指向同一张RT，如果不是，则需要将复制品指向的RT修改过来 function PhotoEffectFactory:_pointToSameRT(url)     local photoData = self._effects[url]     if photoData and photoData.photoEff then         local orgRawImage = photoData.photoEff:getRawImage()         if orgRawImage then             local goCopy = photoData.clones and photoData.clones[1]             if not goutil.isNil(goCopy) then                 local copyRawImage = goCopy:GetComponent(typeof(UnityEngine.UI.RawImage))                 if copyRawImage and orgRawImage.texture ~= copyRawImage.texture then                     for i = 1, #photoData.clones do                         goCopy = photoData.clones[i]                         if not goutil.isNil(goCopy) then                             copyRawImage = goCopy:GetComponent(typeof(UnityEngine.UI.RawImage))                             if copyRawImage then                                 copyRawImage.texture = orgRawImage.texture                             end                         end                     end                 end             end         end     end end  function PhotoEffectFactory:turnOn(url)     if self._effects and self._effects[url] then         if self._effects[url].photoEff then             self._effects[url].photoEff:turnOn()             self:_pointToSameRT(url)         end     end end  function PhotoEffectFactory:turnOff(url)     if self._effects and self._effects[url] then         if self._effects[url].photoEff then             self._effects[url].photoEff:turnOff()           end     end end  function PhotoEffectFactory:_onEffectLoaded(goInst, res)     if res and res.ResPath then         local data = self._effects and self._effects[res.ResPath]         if data then             data.orgGoInst = goInst             if data.clones then                 local rawImageComp                 for i = 1, #data.clones do                     if not goutil.isNil(data.clones[i]) then                         rawImageComp = data.clones[i]:GetComponent(typeof(UnityEngine.UI.RawImage))                         if rawImageComp then                             rawImageComp.enabled = true                         end                     end                 end             end         end     end end  function PhotoEffectFactory:destroyClonePhotoEffect(url,justclear)     local photoEffect=self._effects and self._effects[url]      if photoEffect then         photoEffect.count = photoEffect.count - 1         if photoEffect.count &lt;= 0 then             self._pool:returnObject(photoEffect)             self._effects[url]=nil         end     end end   – 预留接口：清除所有的PhotoEffect function PhotoEffectFactory:destroy()     if self._effects then         self._pool:clear()         self._effects={}     end end  PhotoEffectFactory.instance = PhotoEffectFactory.New()  return PhotoEffectFactory</p>
<p>// photoMultiEffect.lua  module(“logic.common.ugui.PhotoMultiEffect”, package.seeall)  local PhotoMultiEffect = class(“PhotoMultiEffect”)  function PhotoMultiEffect:ctor(compContainer)     self._compContainer = compContainer     self._go = self._compContainer.gameObject     self._multiLoader = MultiResLoader.New() –资源的引用都在这里引用     self._photo = Framework.PhotoBase.Add(self._go)     self._rtWidth = PhotoUtil.PartRTWidth     self._rtHeight = PhotoUtil.PartRTHeight     self._effectLoadedCallback = nil     self._effectLoadedCallbackObj = nil     self._effectOnePlayFinishCallback = nil     self._effectOnePlayFinishCallbackObj = nil     self._bInitUVRect = true     self._urls = {}     self._goInstList = {}     PhotoUtil.initPhotoSetting()     self:_initRawImage() end  function PhotoMultiEffect:_initRawImage()     if not goutil.isNil(self._go) then         self._rawImage = self._go:GetComponent(typeof(UnityEngine.UI.RawImage))         if self._rawImage == nil then             self._rawImage = self._go:AddComponent(typeof(UnityEngine.UI.RawImage))         end         self._rawImage.enabled = false         self._rawImage.raycastTarget = false         self._rawImage.material = PhotoUtil.getEffMaterial()     end end  function PhotoMultiEffect:_setRawImageUVRect(rtWidth, rtHeight)     if self._bInitUVRect and self._rawImage then         self._rtWidth = rtWidth         self._rtHeight = rtHeight         PhotoUtil.setRTCapacity(rtWidth, rtHeight)         –计算RawImage的大小以及偏移         local uvRectW = math.min(1, goutil.getWidth(self._go.transform) / rtWidth)         local uvRectH = math.min(1, goutil.getHeight(self._go.transform) / rtHeight)         local uvRectX = (1 - uvRectW) * 0.5         local uvRectY = (1 - uvRectH) * 0.5         self._rawImage.uvRect = UnityEngine.Rect.New(uvRectX, uvRectY, uvRectW, uvRectH)         self._bInitUVRect = false     end end  – 该接口只提供给PhotoEffectFactory使用，其他地方不允许调用 function PhotoMultiEffect:getRawImage()     return self._rawImage end  function PhotoMultiEffect:setEffectLoadedCallback(callback, callbackObj)     self._effectLoadedCallback = callback     self._effectLoadedCallbackObj = callbackObj end  function PhotoMultiEffect:setEffectOnePlayFinishCallback(callback, callbackObj)     self._effectOnePlayFinishCallback = callback     self._effectOnePlayFinishCallbackObj = callbackObj end  function PhotoMultiEffect:setClickEnable(bRaycastTarget)     if self._rawImage then         self._rawImage.raycastTarget = bRaycastTarget     end end  function PhotoMultiEffect:setClickCallback(callback, callbackObj)     if callback == nil then         return     end     if goutil.isNil(self._go) then         return     end     if not self._btnClick then         local compButton = self._go:GetComponent(typeof(UnityEngine.UI.Button))         if compButton == nil then             self._go:AddComponent(typeof(UnityEngine.UI.Button))         end         self._btnClick = Framework.ButtonAdapter.Get(self._go)         self._btnClick:AddClickListener(callback, callbackObj)     end end  – 小图标规格的RT特效 256 * 144 function PhotoMultiEffect:showSmallEffect(…)     local urls = {…}     if not urls or #urls == 0 then         return     end     self:loadRes(urls, PhotoUtil.SmallRTWidth, PhotoUtil.SmallRTHeight) end  – 中等规格的RT特效 512 * 288 function PhotoMultiEffect:showPartEffect(…)     local urls = {…}     if not urls or #urls == 0 then         return     end     self:loadRes(urls, PhotoUtil.PartRTWidth, PhotoUtil.PartRTHeight) end  – 全屏规格的RT特效 1280 * 720 function PhotoMultiEffect:showFullScreneEffect(…)     local urls = {…}     if not urls or #urls == 0 then         return     end     self:loadRes(urls, PhotoUtil.RTWidth, PhotoUtil.RTHeight) end  – 最大全屏规格的RT特效 1560 * 720，不能再接受更大的尺寸规格 function PhotoMultiEffect:showMaxScreneEffect(…)     local urls = {…}     if not urls or #urls == 0 then         return     end     self:loadRes(urls, PhotoUtil.MaxRTWidth, PhotoUtil.MaxRTHeight) end  function PhotoMultiEffect:loadRes(urls, rtWidth, rtHeight)     if self._photo == nil then         return     end     self:_setRawImageUVRect(rtWidth, rtHeight)     self._photo:TurnOn(rtWidth, rtHeight)     self._isOn = true     local renderTexture = self._photo and self._photo.producer and self._photo.producer.renderTexture     if renderTexture == nil then         printError(“renderTexture is nil, self._go=”, self._go.name)         self._rawImage.enabled = false         return     – 重复 photobase.turnOn里已经做了     – else         – self._rawImage.texture = renderTexture     end     local len = #urls     for i = 1, len do         if not self._urls then             self._urls = {}         end         table.insert(self._urls, urls[i])         self._multiLoader:addResPath(urls[i])     end     PhotoUtil.addUsingRTCount(self, rtWidth, rtHeight)     –暂时没有全部加载完毕逻辑回调     self._multiLoader:load(_, self._onSingleResLoaded, self) end  function PhotoMultiEffect:_onSingleResLoaded(res)     if res.IsSuccess then         if goutil.isNil(self._go) or self._photo == nil then             self:clear()             return         end         –9/4修改：self._isOn为false表示有两种情况，一种是在特效加载完成之前调用了turnOff接口，一种是调用了clear接口；         –按道理调用clear接口并不会回调到这里，所以处理第一种情况就好         if not self._isOn then             if self._urls == nil or #self._urls == 0 then                 self:turnOff()                 return             end         end         local goInst         if self._urls then             for i = #self._urls, 1, -1 do                 if res.ResPath == self._urls[i] then                     table.remove(self._urls, i)                     goInst = goutil.clone(res:GetAsset(nil, nil))                     goInst.layer = Framework.LayerUtil.NameToLayer(PhotoUtil.LayerName)                     table.insert(self._goInstList, goInst)                     break                 end             end         end         if goInst then             if self._photo then                 –检查当前是turnOff还是turnOn                 – goutil.setActive(goInst, self._isOn)                 self._rawImage.enabled = self._isOn                 if self._isOn then                     self._photo:ShowTarget(goInst, true)                 else                     goutil.addChildToParent(goInst, self._go)                 end             end             if self._effectLoadedCallback then                 if self._effectLoadedCallbackObj then                     self._effectLoadedCallback(self._effectLoadedCallbackObj, goInst, res)                 else                     self._effectLoadedCallback(goInst, res)                 end             end             –检查美术是否有挂载EffectPlayer的组件             local _effectCSComp = goInst:GetComponent(typeof(Pjg.EffectPlayer))             if _effectCSComp and not goutil.isNil(_effectCSComp) then                 –参数默认以组件的，暂不支持外部设置参数                 _effectCSComp:AddFinishListener(self._onEffectOnePlayFinish, self)                 –加载好就立即执行play                 _effectCSComp:Play()             end         end     end end  –暂时没有全部播放完毕逻辑回调 function PhotoMultiEffect:_onEffectOnePlayFinish()     if goutil.isNil(self._go) then         return     end     if self._effectOnePlayFinishCallback then         if self._effectOnePlayFinishCallbackObj then             self._effectOnePlayFinishCallback(self._effectOnePlayFinishCallbackObj)         else             self._effectOnePlayFinishCallback()         end     end end  function PhotoMultiEffect:getFirstUrl()     return self._urls and self._urls[1] end  function PhotoMultiEffect:getUrlString()     return table.concat(self._urls, “#”) end  – 根据传入的路径判断该特效是否已经加载完成 function PhotoMultiEffect:checkIsFinishLoadByUrl(url)     local bLoaded = false     if self._multiLoader and self._multiLoader:getResource(url) then         return true     end end  – bReplay：是否重播，有些特效需要再次打开的时候调用 – 注意：重播只针对本身是显示状态的特效，如果本身特效由于功能需要自己被隐藏，bReplay传入true也是没法重播 function PhotoMultiEffect:turnOn(bReplay)     if not self._isOn then         if self._rawImage then             self._rawImage.enabled = true         end         if self._goInstList and self._photo then             self._photo:TurnOn(self._rtWidth, self._rtHeight)             PhotoUtil.addUsingRTCount(self, self._rtWidth, self._rtHeight)             local goInst             for i = 1, #self._goInstList do                 goInst = self._goInstList[i]                 if not goutil.isNil(goInst) then                     if bReplay and goInst.activeSelf then                         goutil.setActive(goInst, false)                         goutil.setActive(goInst, true)                     end                     –检查美术是否有挂载EffectPlayer的组件                     local _effectCSComp = goInst:GetComponent(typeof(Pjg.EffectPlayer))                     if _effectCSComp and not goutil.isNil(_effectCSComp) then                         _effectCSComp:Stop()                         _effectCSComp:RemoveFinishListener()                         –参数默认以组件的，暂不支持外部设置参数                         _effectCSComp:AddFinishListener(self._onEffectOnePlayFinish, self)                         _effectCSComp:Play()                     end                     self._photo:ShowTarget(goInst, true)                 end             end         end         self._isOn = true     end end  function PhotoMultiEffect:turnOff()     if goutil.isNil(self._go) then         return     end     if self._isOn then         if self._rawImage then             self._rawImage.enabled = false         end         if self._goInstList and self._photo then             for i = 1, #self._goInstList do                 if not goutil.isNil(self._goInstList[i]) then                     –goutil.setActive(self._goInstList[i], false)                     goutil.addChildToParent(self._goInstList[i], self._go)                 end             end         end         if self._photo then             self._photo:TurnOff()             PhotoUtil.reduceUsingRTCount(self, self._rtWidth, self._rtHeight)         end         self._isOn = false     end end  function PhotoMultiEffect:clear()     self._urls = {}     if self._multiLoader then         self._multiLoader:clear()     end     if self._goInstList then         for i = 1, #self._goInstList do             if not goutil.isNil(self._goInstList[i]) then                 –检查美术是否有挂载EffectPlayer的组件                 local _effectCSComp = self._goInstList[i]:GetComponent(typeof(Pjg.EffectPlayer))                 if _effectCSComp and not goutil.isNil(_effectCSComp) then                     _effectCSComp:Stop()                     _effectCSComp:RemoveFinishListener()                 end                 goutil.destroy(self._goInstList[i])             end         end         self._goInstList = {}     end     if self._photo then         self._photo:TurnOff()         PhotoUtil.reduceUsingRTCount(self, self._rtWidth, self._rtHeight)     end     self._isOn = false     if goutil.isNil(self._go) then         return     end     if self._rawImage then         self._rawImage.enabled = false     end     self._bInitUVRect = true end  function PhotoMultiEffect:OnDestroy()     self:clear()     self._multiLoader=nil     self._compContainer = nil     self._go = nil     self._photo = nil     self._rawImage = nil     self._effectLoadedCallback = nil     self._effectLoadedCallbackObj = nil     self._effectOnePlayFinishCallback = nil     self._effectOnePlayFinishCallbackObj = nil     self._urls = nil     self._goInstList = nil      if self._btnClick then         self._btnClick:RemoveClickListener()         self._btnClick = nil     end end – 判断是否是空闲，需要加载特效 function PhotoMultiEffect:isFree()     return not self._isOn and self._multiLoader.totalCount==0 end  return PhotoMultiEffect</p>
<p>// PhotoBase.cs  using System.Collections; using System.Collections.Generic; using UnityEngine; using UnityEngine.UI;  namespace Framework {     public class PhotoBase : MonoBehaviour      {         protected PhotoProducer _producer;         protected RawImage _rawImg;          public static PhotoBase Add(GameObject go)         {             return go.AddComponentOnce<PhotoBase>();         }          void Awake()         {             //2018/8/8修改,防止gameObject或父节点被隐藏，lua已经初始化RawImage后显示gameObject的时候Awake接口被调用             _rawImg = gameObject.GetComponent<RawImage> ();             if (_rawImg == null) {                 _rawImg = gameObject.AddComponentOnce<RawImage>();                 _rawImg.raycastTarget = false;                 _rawImg.texture = null;                 _rawImg.material = PhotoProducerCache.Instance.GetPhotoMaterial();             }         }          protected virtual void OnEnable()         {             if(_producer != null)             {                 _producer.producerContainer.SetActive(true);             }         }          protected virtual void OnDisable()         {             if(_producer != null &amp;&amp; _producer.producerContainer != null)             {                 _producer.producerContainer.SetActive(false);             }         }          public void EnableClick(bool isEnable)         {             if(isEnable)             {                 _rawImg.raycastTarget = true;             }             else             {                 _rawImg.raycastTarget = false;             }         }          //在turn on的时候才有值         public PhotoProducer producer         {             get{ return _producer;}         }          //在turn on的时候才能调用         public void SetCameraPosition(float x,float y,float z)         {             GlobalObject.gVec3.x = x;             GlobalObject.gVec3.y = y;             GlobalObject.gVec3.z = z;              _producer.rtCamera.transform.localPosition = GlobalObject.gVec3;         }          //在turn on的时候才能调用         public void SetCameraRotation(float x,float y,float z)         {             _producer.rtCamera.transform.localRotation = Quaternion.Euler(x,y,z);         }          /**          *  将一个物体放入拍摄空间内          * */         public void ShowTarget(GameObject go,bool allSameLayer)         {             if(allSameLayer)                 go.SetLayerRecursively(PhotoProducerCache.Instance.GetCullingLayer());             else                 go.layer = PhotoProducerCache.Instance.GetCullingLayer();                          go.transform.SetParent(_producer.targetContainer.transform,false);         }          /**          *  把拍摄目标全部移除          * */         public void RemoveAllTargets()         {             GameObjectUtil.ClearChildren(_producer.targetContainer);         }                      public void TurnOn()         {             if(_producer == null)             {                 Rect size = (gameObject.transform as RectTransform).rect;                 _producer = PhotoProducerCache.Instance.Fetch(Mathf.CeilToInt(size.width),Mathf.CeilToInt(size.height));                 _rawImg.texture = _producer.renderTexture;              }              if(this.gameObject.activeInHierarchy)             {                 _producer.producerContainer.SetActive(true);             }             else             {                 _producer.producerContainer.SetActive(false);             }         }          /// <summary>         /// 重载TurnOn接口，支持外部传入需要创建的RT大小         /// </summary>         public void TurnOn(float width, float height)         {             if(_producer == null)             {                 if (_rawImg == null) {                     _rawImg = gameObject.GetComponent<RawImage> ();                 }                 _producer = PhotoProducerCache.Instance.Fetch(Mathf.CeilToInt(width),Mathf.CeilToInt(height));                 _rawImg.texture = _producer.renderTexture;              }              if(this.gameObject.activeInHierarchy)             {                 _producer.producerContainer.SetActive(true);             }             else             {                 _producer.producerContainer.SetActive(false);             }         }          public bool IsOn         {             get{ return _producer != null;}         }          public void TurnOff()         {             if(_producer != null)             {                 PhotoProducerCache.Instance.Return(_producer);                 _producer = null;             }         }          void OnDestroy()         {             TurnOff();         }     } }</p>
<p>// photoProducer.cs  using System.Collections; using System.Collections.Generic; using UnityEngine;  namespace Framework  {     public class PhotoProducer     {         private GameObject _rtContainer;         private GameObject _targetContainer;         private Camera _rtCamera;         private RenderTexture _rt;          public GameObject producerContainer         {             get { return _rtContainer;}         }          public GameObject targetContainer         {             get {return _targetContainer;}         }          public Camera rtCamera         {             get {return _rtCamera;}         }          public RenderTexture renderTexture         {             get {return _rt;}         }          public PhotoProducer(int width,int height,int cullingMask,int rtDepth,RenderTextureFormat rtFormat,int antiAliasing)         {             _rtContainer = new GameObject(“PhotoProducer_“ + PhotoProducerCounter.GetCounter());              _targetContainer = new GameObject(“TargetContainer”);             _targetContainer.transform.SetParent(_rtContainer.transform,false);              _rtContainer.transform.position = PhotoProducerCounter.GenPosition();             GameObject.DontDestroyOnLoad(_rtContainer);              GameObject cameraObj = new GameObject(“Camera”);             cameraObj.transform.SetParent(_rtContainer.transform, false);             this._rtCamera = cameraObj.AddComponent<Camera>();             this._rtCamera.useOcclusionCulling = false;              _rtCamera.enabled = true;             _rtCamera.clearFlags = CameraClearFlags.SolidColor;             _rtCamera.backgroundColor = new Color(0, 0, 0, 0);             _rtCamera.cullingMask = cullingMask;             _rtCamera.targetTexture = _rt;             _rtCamera.farClipPlane = 1000;              _rt = new RenderTexture(width, height,rtDepth,rtFormat);             if(antiAliasing &gt; 0)                 _rt.antiAliasing = antiAliasing;              _rtCamera.targetTexture = _rt;         }          public void Dispose()         {             if (_rtCamera != null) {                 _rtCamera.targetTexture = null;             }             if(_rt != null)             {                 GameObject.Destroy(_rt);                 _rt = null;             }             GameObjectUtil.Destroy(_rtContainer);         }     } }</p>
<p>// photoProducerCache.cs  using System.Collections.Generic; using UnityEngine;  namespace Framework {     /**      *  UI特效公用的RenderTexture缓存 以及 用于绘制的Camera和GameObject      *  RenderTexture的大小  有若干种规格,游戏项目中规划好预定的几种规格规范      *  规格1   1136 640                                    *  规格2   200*200      * */     public class PhotoProducerCache : Singleton<PhotoProducerCache>     {         //一些设置         private int _photoCullingLayer = 0;         private int _photoCullingMask = 0;          private int _rtDepth = 32;         private RenderTextureFormat _rtFormat = RenderTextureFormat.ARGB32;          private int _antiAliasing = 2;         private Material _photoMat;          //每种规格 对应的 缓存RenderTexture列表         private Dictionary&lt;int,List<PhotoProducer>&gt; _cache = new Dictionary&lt;int,List<PhotoProducer>&gt;();         private Dictionary&lt;int,int&gt; _capacityDict = new Dictionary&lt;int, int&gt;();          public void SetAALevel(int aaLevel)         {             this._antiAliasing = aaLevel;         }          public void SetCullingLayer(int mask)         {             _photoCullingLayer = mask;             _photoCullingMask = 1&lt;&lt;_photoCullingLayer;         }          public int GetCullingLayer()         {             return _photoCullingLayer;         }                      public void SetRenderTextureDepth(int depth)         {             _rtDepth = depth;         }          public void SetRenderTextureFormat(RenderTextureFormat format)         {             _rtFormat = format;         }                      public void SetCapacity(int width,int height,int capacity)         {             int key = (width &lt;&lt; 16) + height;             _capacityDict[key] = capacity;         }          public void SetPhotoMaterial(Material mat)         {             _photoMat = mat;         }          public Material GetPhotoMaterial()         {             return _photoMat;         }                      public PhotoProducer Fetch(int width,int height)         {             if(width &lt;= 0 || height &lt;= 0) return null;             int key = (width &lt;&lt; 16) + height;             PhotoProducer producer;             if(_cache.ContainsKey(key))             {                 List<PhotoProducer> producers = _cache[key];                 if(producers.Count &gt; 0)                 {                     producer = producers[producers.Count-1];                     producer.targetContainer.SetActive(true);                     producers.RemoveAt(producers.Count-1);                 }                 else                 {                     producer =  new PhotoProducer(width,height,_photoCullingMask,_rtDepth,_rtFormat,_antiAliasing);                 }             }             else             {                 producer = new PhotoProducer(width,height,_photoCullingMask,_rtDepth,_rtFormat,_antiAliasing);             }             return producer;         }          public void Return(PhotoProducer producer)         {             if(producer == null) return;             RenderTexture rt = producer.renderTexture;             int key = (rt.width &lt;&lt; 16) + rt.height;             int capacity;             _capacityDict.TryGetValue(key,out capacity);              if(capacity &gt; 0)             {                 List<PhotoProducer> producers;                 _cache.TryGetValue(key,out producers);                 if(producers == null)                 {                     producers = new List<PhotoProducer>();                     _cache[key] = producers;                 }                  if(producers.Count &lt; capacity)                   {                     if (producer.producerContainer) {                         producer.producerContainer.SetActive(false);                     }                     producers.Add(producer);                 }                 else //剩余容量不够了，销毁掉                 {                     producer.Dispose();                 }             }             else //不需要缓存的             {                 producer.Dispose();             }         }            } }</p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;游戏项目中一般会用到一些优化手段，大部分优化的是资源的大小对内存的影响，比如项目中特效的加载会拥有两个类：photoFactoryEffect和photoMutilEffect&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;photoFact
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E7%89%B9%E6%95%88/"/>
    
    
      <category term="特效" scheme="https://laoleo.github.io/tags/%E7%89%B9%E6%95%88/"/>
    
  </entry>
  
  <entry>
    <title>RenderTexture特效系统实现原理</title>
    <link href="https://laoleo.github.io/2021/01/20/RenderTexture%E7%89%B9%E6%95%88%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>https://laoleo.github.io/2021/01/20/RenderTexture特效系统实现原理/</id>
    <published>2021-01-19T16:00:00.000Z</published>
    <updated>2022-12-07T13:34:13.149Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="RenderTexture特效系统实现原理"><a href="#RenderTexture特效系统实现原理" class="headerlink" title="RenderTexture特效系统实现原理"></a>RenderTexture特效系统实现原理</h1><h2 id="一、RenderTexture阐述"><a href="#一、RenderTexture阐述" class="headerlink" title="一、RenderTexture阐述"></a>一、RenderTexture阐述</h2><p>食物语中的显示的特效一般是使用RenderTexture结合摄像机拍摄3D物体实现的，实际上游戏中显示的是一张加载好的RT。</p>
<p>什么是RT？为啥RT可以渲染一张动态的图片？</p>
<p>RT是一种特殊的Texture，可以在运行时实现更新内容。网上有句话可以概括：将一个FBO链接到server-side的texture对象上。通俗一点就是将渲染结果应用到gpu上的texture对象上，而texture对象就是游戏中的一张贴图，渲染结果（FBO的数据）可以动态变化，那么贴图的内容也跟着动态变化。</p>
<p>FBO全称：FrameBufferObject，gpu上的一块buffer区域，用来存储渲染结果。一般有个默认的FBO直接连接显示器窗口区域，其他的FBO存储渲染结果供需要时使用，正是这时候，RT作为一块渲染区域应用这些FBO。</p>
<p>server-side：cpu加载贴图资源到内存，叫做client-side；cpu将资源从内存拷贝到gpu中，叫做发送到server-side。</p>
<p>为什么特效需要用RT应用到项目中，而不直接加载呢？</p>
<p>关键的原因是项目中一般在UI上挂特效，特效资源的渲染层跟UI不属于同一个渲染层级，所以总是在UI资源之前或之后，没办法在两个UI资源之间，让特效显示在最上层的话，那么就会挡住比如断线重连这类层级优先级最高的UI。</p>
<p>所以要利用RT渲染特效，作为一个UI资源加载进来。</p>
<h2 id="二、RT特效系统设计原理"><a href="#二、RT特效系统设计原理" class="headerlink" title="二、RT特效系统设计原理"></a>二、RT特效系统设计原理</h2><p>怎样实现RT特效？</p>
<p>很简单就是创建一个RenderTexture对象，赋值给camera的targetTextrue属性，同时赋值给RawImage对象的texture属性。这就相当于camera将渲染结果（特效的表现）写入到了RenderTexture对象，RawImage对象作为一个显示窗口区域，连接到RenderTexture对象存储数据的FBO。</p>
<p>着点于项目上，RT特效系统是如何设计的，这么设计的原因有是什么呢？先看以下系统关系图：</p>
<img src="/2021/01/20/RenderTexture%E7%89%B9%E6%95%88%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/image.png" class="">
<p>图中清晰的表达了类之间数据流向，关键的就是传递RT和特效实例，各类发挥的作用：</p>
<ol>
<li>PhotoProducer负责创建RT、摄像机和特效实例的容器TargetContainer，相当于一块特效的渲染场景，而且这个渲染场景跟UI不是同一个渲染层，另外负责把RT传递给PhotoBase的RawImage组件上。</li>
<li>PhotoProducerCache作为对象池，管理PhotoProducer的分配和回收。</li>
<li>PhotoBase就是作为承载RT的容器，显示在UI上。</li>
<li>PhotoMultiEffect负责通过url加载特效资源，并将特效资源实例传递到Pruducer中的TargetContainer容器。</li>
</ol>
<p>另外这些类通过turnOn和turnOff方法控制特效的显示和隐藏。</p>
<ul>
<li>turnOn方法：将Effect Inst加到TargetContainer节点下，将RT跟Camera和RawImage连接起来。</li>
<li>TurnOff方法：将RawImage置为不可用enable为false，将Effect Inst移出TargetContainer，并且将ProducerContainer置为不可见，归还Producer到对象池以便供其他特效使用。</li>
</ul>
<p>还有一点，PhotoProducerCache的主要优化手段是将RT缓存起来，用RT的规格（宽高）作为索引来复用RT。项目中规定了RT的几种规则：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--最大规格RT尺寸(不能再大了) 1560 * 720</span></span><br><span class="line">PhotoUtil.MaxRTWidth = <span class="number">1560</span></span><br><span class="line">PhotoUtil.MaxRTHeight = <span class="number">720</span></span><br><span class="line"><span class="comment">--大规格RT尺寸 1280 * 720</span></span><br><span class="line">PhotoUtil.RTWidth = <span class="number">1280</span></span><br><span class="line">PhotoUtil.RTHeight = <span class="number">720</span></span><br><span class="line"><span class="comment">--中等规格RT尺寸 512 * 288</span></span><br><span class="line">PhotoUtil.PartRTWidth = <span class="number">512</span></span><br><span class="line">PhotoUtil.PartRTHeight = <span class="number">288</span></span><br><span class="line"><span class="comment">--小规格RT尺寸 256 * 144</span></span><br><span class="line">PhotoUtil.SmallRTWidth = <span class="number">256</span></span><br><span class="line">PhotoUtil.SmallRTHeight = <span class="number">144</span></span><br></pre></td></tr></table></figure>
<p>这样做应该是为限制RT规则来方便复用吧，而且面对各种规则的RT特效复用可能会出现特效裁边这种问题。</p>
<p>RT特效系统中还处理了一种情况：显示多个同一类特效。</p>
<p>当然RT肯定是同一张，但是需要创建多个PhotoMultiEffect的实例，进而实例化多个特效资源实例，这样就浪费资源了，创建多个特效实例可以省去，我们需要的是多个RT的承载体，也就是多个挂有RawImage组件的GameObject。</p>
<p>所以就有PhotoEffectFactory类，负责管理同一类特效的多处显示情况。</p>
<img src="/2021/01/20/RenderTexture%E7%89%B9%E6%95%88%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/image_1.png" class="">
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;RenderTexture特效系统实现原理&quot;&gt;&lt;a href=&quot;#RenderTexture特效系统实现原理&quot; class=&quot;headerlink&quot; title=&quot;RenderTexture特效系统实现原理&quot;&gt;&lt;/a
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="特效" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E7%89%B9%E6%95%88/"/>
    
    
      <category term="特效" scheme="https://laoleo.github.io/tags/%E7%89%B9%E6%95%88/"/>
    
      <category term="RT" scheme="https://laoleo.github.io/tags/RT/"/>
    
      <category term="RenderTexture" scheme="https://laoleo.github.io/tags/RenderTexture/"/>
    
  </entry>
  
  <entry>
    <title>Unity Addressable Asset System介绍、教程和原理讲解</title>
    <link href="https://laoleo.github.io/2021/01/15/UnityAddressable/"/>
    <id>https://laoleo.github.io/2021/01/15/UnityAddressable/</id>
    <published>2021-01-14T16:00:00.000Z</published>
    <updated>2022-12-06T15:30:38.413Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="Unity-Addressable-Asset-System介绍、教程和原理讲解"><a href="#Unity-Addressable-Asset-System介绍、教程和原理讲解" class="headerlink" title="Unity Addressable Asset System介绍、教程和原理讲解"></a>Unity Addressable Asset System介绍、教程和原理讲解</h1><h2 id="1-背景（怎么来的）"><a href="#1-背景（怎么来的）" class="headerlink" title="1. 背景（怎么来的）"></a>1. 背景（怎么来的）</h2><p>Unity Addressable Asset System是官方推出的资源加载和资源管理的一套解决方案。</p>
<p>它使用异步加载的方式加载资源，提供统一的加载接口，不管资源放在哪个目录，不管资源的依赖有多复杂。</p>
<p>传统的资源管理方式严重将组织、构建、加载Asset的逻辑捆绑在一起，比如</p>
<ol>
<li>资源存放在Resource文件，那加载资源必须要用到Resources.Load方法，并且提供资源路径</li>
<li>加载ab中的asset时，加载代码需要和构建策略捆绑在一起，先找出资源对应的bundle加载完成后，再加载需要的资源。</li>
<li>以路径加载的代码，当资源路径发生改变往往要多次更改代码，这个更改可能涉及多处。</li>
<li>资源位于远程，需要写代码管理资源的下载、加载、卸载和缓存。<img src="/2021/01/15/UnityAddressable/image.png" class="">
基于以上种种不便，Unity Addressable Asset System（下文称AA系统）的一个重要好处就是解决以上种种痛点。<h2 id="2-特点（有何用）"><a href="#2-特点（有何用）" class="headerlink" title="2. 特点（有何用）"></a>2. 特点（有何用）</h2></li>
</ol>
<ul>
<li>快速迭代：解耦组织、构建、加载Asset的逻辑，通过[address]和统一接口加载资源，不管资源放是否来自Resources目录，或者将来重命名或者路径变更，不管资源如何构建，都不用再修改加载代码。</li>
<li>依赖管理：当加载一个资源的时候，AA系统会先加载完这个资源的所有依赖，然后再返回这个资源。</li>
<li>内存管理：自动管理资源加载卸载的引用计数，并提供工具探测内存泄露问题。</li>
<li>内容打包：当资源变更时能够有效打包资源，更容易管理本地和远程打包资源和有效减小应用大小。</li>
<li>配置文件：统一管理资源如何打包的变量，避免配置分散多处修改问题。</li>
</ul>
<h2 id="3-概念"><a href="#3-概念" class="headerlink" title="3. 概念"></a>3. 概念</h2><h3 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h3><p>group定义一组在构建时可处理的Addressable Asset集合。</p>
<p>默认有两个group，如上图：</p>
<ul>
<li>Built In Data。内置的group，包含Resources文件夹，这个group不支持修改。</li>
<li>Default Local Group。在Inspector标记Addresables的Asset会默认添加进这里，支持修改，包括改名和添加Schema。</li>
</ul>
<h3 id="Group-Schema"><a href="#Group-Schema" class="headerlink" title="Group Schema"></a>Group Schema</h3><p>group schema定义一组分配给group在构建使用的数据，可视为配置数据，决定group中Asset如何打包、打包粒度等等。</p>
<p>点击group，查看这个group中添加的schema，和schema的配置：</p>
<img src="/2021/01/15/UnityAddressable/image_1.png" class="">
<p>包括三种Schema：</p>
<ol>
<li>Content Updage Restriction 主要决定ab可不可以更改<br> Update Restriction：决定改组内容打包成ab后，可不可以动态更新。can change post release：允许发布后变更；cannot change post release：不允许发布后变更。</li>
<li>Content Packing &amp; Loading <strong>决定打包方式和加载的配置</strong>，包括构建目录、压缩、打包模式等等<br> 下面是几个重要的配置，鼠标移动到变量名上可以显示该配置作用介绍：<br> Build Path：打包后的发布路径。可分为本地和远程路径。<br> Load Path：加载ab的路径，可分为本地和远程路径。<br> 这些的路径变量来自Profiles中定义的变量，Profiles的解析请看下面。<br> Compression：支持三种压缩方式，包括不压缩、LZ4和LZMA。<br> Include In Build：勾选才会将该group纳入构建进程中。<br> Use Asset Bundle Cache：勾选会将加载的ab加进缓存目录中，远程bundle才需要勾选。<br> Bundle Mode：打包模式，分别是Pack Separately单独打包，Pack Together全部达成一个包，Pack Together By Label根据label划分打包。<br> Bundle Naming：bundle的命名规则。<br> Asset Provider：加载和解析Asset的类，不同的资源类型对应不同的provider。<br> Asset bundle Provider：加载和解析Asset bundle的类，默认为AssetBundleProvider。</li>
<li>Resources and Build In Scenes<strong> 是否将Resources和Build Setting Scenes包含进来打包</strong><br> Include Resources Folders：是否将Resources文件夹下的Asset包含进group。Resources下的Asset会打包进包体，一般不需要勾选。<br> Include Build Setting Scenes：是否包含Build Setting添加的Scenes。</li>
</ol>
<h3 id="Addressable-Asset-Settings"><a href="#Addressable-Asset-Settings" class="headerlink" title="Addressable Asset Settings"></a>Addressable Asset Settings</h3><p>作为AA系统全局的配置文件，在初始化的时候生成。以下介绍几个重要的变量：</p>
<p>属性介绍：</p>
<p>Disable Catalog Update on Startup：勾选则在AA系统初始化时候不检查catalog文件更新。</p>
<p><strong>Build Remote Catalog</strong>： 勾选则生成远程ab的catalog文件，需要配置remote catalog文件的build path和load path。</p>
<p>Send Profiler Event：勾选则开启分析器。</p>
<p>Unique Bundle IDs：给bundle分配独一无二的ID。因为catalog文件可以在初始化以外的时候更新，当旧资源已经在内存中时，但unity无法下载两个同internal name的资源，这种情况资源无法及时更新。要么先卸载重新资源重新下载，要么分配给bundle单独的id来区分。开启这个选项，当资源更新时不仅仅是更新该资源，也会更新依赖链，带来一定的性能花销。</p>
<p>Contiguous Bundle：基于源资源的排序来排序Bundle，可以加快Asset加载速度。</p>
<p><strong>Build and Play Mode Scripts</strong></p>
<p>Use Asset Database （fastest）：加载源文件模式，不用打ab和分析。</p>
<p>Simulate Groups（Advanced）：模拟组模式，以不打ab方式来分析内容的布局和依赖。用类似加载ab的方式，通过ResourceManager从AssetDatabase加载。这个模式用于模拟加载策略，调整和平衡内容的分布。</p>
<p>Use Existing Build：使用构建好的ab加载，需要提前构建好ab。</p>
<p>Default Build Script：默认的构建脚本。</p>
<p>可选的Build Script都是ScriptableObject的Asset。假如需要扩展，可以新建脚本，继承IDataBuilder接口。添加可以选择左下角+，添加Build Script Asset。</p>
<p>前三个Play Mode Script分别对应Assetables Groups-》Play Mode Script下的三个模式。</p>
<p>Default Build Script对应Assetables Groups-》Build-》New Build-》Default Build Script。</p>
<p>Asset Group Template：group模板，Assetables Groups面板下Create→Group下，或者group右键菜单可以选择。在Project面板目录上右键菜单Create-》Addressables-》Group Templates-》Blank Group Template可以创建模板。</p>
<h2 id="4-使用流程（怎么用）"><a href="#4-使用流程（怎么用）" class="headerlink" title="4. 使用流程（怎么用）"></a>4. 使用流程（怎么用）</h2><h3 id="step1-安装"><a href="#step1-安装" class="headerlink" title="step1 安装"></a>step1 安装</h3><p>到Package Manager安装以下两个package：</p>
<ul>
<li>Addressables，基本包，本文章使用的版本是1.16.15</li>
<li>Scriptable Build Pipeline package，依赖包</li>
</ul>
<h3 id="step2-初始化"><a href="#step2-初始化" class="headerlink" title="step2 初始化"></a>step2 初始化</h3><p>安装包后，通过菜单栏Window-&gt;Asset Management-&gt;Addressables→Groups 可以打开AA系统的管理面板</p>
<p>未初始化会出现初始化按钮，点击后Asset目录下会出现一个AddressableAssetsData目录，存放着一些配置文件。</p>
<h3 id="step3-标记可寻址"><a href="#step3-标记可寻址" class="headerlink" title="step3 标记可寻址"></a>step3 标记可寻址</h3><p>需要将Asset标记为Addressable，才能纳入AA系统的管理。标记为Addressable Asset有两个途径：</p>
<p>通过Inspector。勾选，会将Asset添加进默认的group（Default Local Group），以相对Assets目录的地址作为AA系统寻找该Asset的【address】，这个地址支持修改。</p>
<ol>
<li>拖动Asset进group。<h3 id="step4-配置远程打包路径"><a href="#step4-配置远程打包路径" class="headerlink" title="step4 配置远程打包路径"></a>step4 配置远程打包路径</h3>unity官方推荐新建一个profile为hosting service所用，配置正确的build path和load path，可以上可以填上Hosting Service 变量：<br>并在需要在AddressableAssetSettings上开启构建远程catelog，选用Editor Hosted Profile，选择build path 和 load path：<br>Addressables Group面板上选择Editor Hosted Profile<br>最后在group Inspector面板中选择内容构建输出的目录，若为远程资源则选择RemoteBuildPath。<br>这就配置完了Hosting Services的使用流程。<h3 id="step5-打包"><a href="#step5-打包" class="headerlink" title="step5 打包"></a>step5 打包</h3>前面已经了解到Group Schema控制打包方式，主要用到两个Schema：content update restriction 和 content packing &amp; loading<br>打出的ab类型可分为远程和本地，静态和非静态（can change post release为非静态）。两两结合可以分为四个组，每个组下各包含两个资源：<br>点击Addressables Groups菜单栏build-》new build-》default build script，开始构建。<br>ab构建完成后，可以看到本地ab和远程ab分别打包到了各自的目录：<br>local和remote各自有一份catalog json文件，remote多了一份hash文件，记录catalog文件的hash值，用于判断catalog文件的更新。<br>catalog文件里记录了address到资源的映射关系，用于定位资源和决定如何加载资源（where和how），每当资源发生变动后构建完成时，catalog文件重新生成。<h3 id="step6-更新"><a href="#step6-更新" class="headerlink" title="step6 更新"></a>step6 更新</h3>再看看更新资源后，各组间的资源打包后如何组织？<br>每个组更改第一个资源后，点击Tools-》check for content update restriction，检查更新<br>这时候会打开窗口选择addressables_content_state.bin文件，文件位于Assets/AddressableAssetsData/[platform]下，发布哪个平台选择哪个平台，一般是Android和Windows。<br>为什么要选择这个bin文件？<br>使用过BuildPipeline构建ab都知道有个manifest文件记录资源间依赖关系，AA系统会将资源间依赖关系记录进这个bin文件，作为对比找出更改的资源。<br>这步过后，会检查出更改的资源：<br>为什么所有资源都有更改，只检查出两个有更新，并且两个资源都来自静态组？<br>unity推荐打包内容分两种类型：</li>
</ol>
<ul>
<li>can change post release：期望更新的动态内容。一般打成小包，以控制精准更新，减少包中其他没有更新的资源的不必要更新。</li>
<li>cannot change post release：不期望更新的静态内容。一般打到一个很少更新的大包中。</li>
</ul>
<p>addressables_content_state.bin文件只是记录了静态资源的hash和依赖关系，动态资源的依赖关系动态计算没有记录到bin文件中，所以check for content update restriction只是作用于static组，对nonStatic组没有作用，也即是对设置了can change post release的组没有作用。</p>
<p>点击apply changes按钮，groups会出现变化：</p>
<p>static组中更改的资源会移动到一个新组content update group：</p>
<p>content update group属于remote non static组</p>
<p>点击build-》update a previous build，选择刚才的bin文件，增量更新</p>
<p>对比发现：</p>
<p>catalog json和hash文件会更新，被重写。</p>
<p>静态组资源bundle并不会被重写更改或者重生生成，静态组中更改的资源会被移动进content update group重新打包到remote目录。</p>
<p>非静态资源组的bundle包虽然不会被重写，但是会被重新生成，hash值也会更新。</p>
<p>旧的非静态资源组bundle会在catalog文件中失去连接和记录，成为无效资源（这个无效资源会保留在用户设备上成为垃圾资源，应该要有个机制及时清理）。</p>
<p>note：每次full build，bundle和catalog文件会重新生成，localBuildpath目录会清空，但是remoteBuildPath目录并不会清空，新生成的资源会跟旧资源混合。</p>
<p>用一张图来阐述官方推荐的AA系统资源更新生命周期：</p>
<img src="/2021/01/15/UnityAddressable/image_2.png" class="">
<img src="/2021/01/15/UnityAddressable/image_3.png" class="">
<h2 id="5-工具"><a href="#5-工具" class="headerlink" title="5. 工具"></a>5. 工具</h2><h3 id="Profiles"><a href="#Profiles" class="headerlink" title="Profiles"></a>Profiles</h3><p>通过菜单栏Window-&gt;Asset Management→Addressables→Profiles 或者 group面板的菜单栏tools→Profiles 打开Profiles面板。</p>
<p>这个是AA系统用来管理一组组变量的解决方案。</p>
<p>默认有以上5个变量，见名知义。</p>
<p>从变量的值中发现有两种符号：[]和{}。</p>
<p>[]：定义编辑时的变量。比如UnityEditor.EditorUserBuildSettings.activeBuildTarget，在编辑时就可以得到的值。</p>
<p>{}：定义运行时的变量。比如UnityEngine.AddressableAssets.Addressables.RuntimePath，在运行时才知道值。</p>
<p>左上角可以添加变量和Profile，在变量上右键可以删除和更名变量。</p>
<p>在AddressableAssetSettings Inspector上可以选择使用哪一份Profilles，这里使用Default Profiles。</p>
<h3 id="Hosting-Services"><a href="#Hosting-Services" class="headerlink" title="Hosting Services"></a>Hosting Services</h3><p>AA系统提供本地资源服务器，模拟远程资源加载。被设计的目的是为了在测试打包内容时加快迭代速度，不需要另外写一套远程资源下载加载代码。它能够为本地或者远端的客户端提供内容。</p>
<p>Addressables Groups-》tools-》Hosting Services-》Create-》Local Hosting创建本地资源服务器：</p>
<p>勾选Enable会分配端口号启动服务器，也可以指定端口号。</p>
<p>开启后，hosting services会以每个group的build path为资源目录提供内容。</p>
<h3 id="内存管理memory-management"><a href="#内存管理memory-management" class="headerlink" title="内存管理memory management"></a>内存管理memory management</h3><p>AA系统通过Addressables API来管理资源的引用计数，提供Event Viewer工具监测资源对象被引用和内存占用情况。</p>
<p>Addressables常见的资源加卸载API：</p>
<ul>
<li>Addressables.LoadAssetAsync &amp; Addressables.Release </li>
<li>Addressables.LoadSceneAsync &amp; Addressables.UnloadSceneAsync</li>
<li>Addressables.InstantiateAsync &amp; Addressables.ReleaseInstance</li>
</ul>
<p>写段测试代码观察资源的引用情况：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.AddressableAssets;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.ResourceManagement.AsyncOperations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Loader</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnEnable</span>()</span></span><br><span class="line">  &#123;</span><br><span class="line">    InstByLoadAssetAsync(<span class="string">&quot;Assets/Local_static 1.prefab&quot;</span>);</span><br><span class="line">    InstByLoadAssetAsync(<span class="string">&quot;Assets/Local_non_static.prefab&quot;</span>);</span><br><span class="line">    InstByLoadAssetAsync(<span class="string">&quot;Assets/Remote_static 1.prefab&quot;</span>);</span><br><span class="line">    InstByLoadAssetAsync(<span class="string">&quot;Assets/Remote_non_static.prefab&quot;</span>);</span><br><span class="line">    InstByLoadAssetAsync(<span class="string">&quot;Assets/Local_static.prefab&quot;</span>);</span><br><span class="line">    InstByInstantiateAsync(<span class="string">&quot;Assets/Local_static 1.prefab&quot;</span>);</span><br><span class="line">    InstByInstantiateAsync(<span class="string">&quot;Assets/Local_non_static.prefab&quot;</span>);</span><br><span class="line">    InstByInstantiateAsync(<span class="string">&quot;Assets/Remote_static 1.prefab&quot;</span>);</span><br><span class="line">    InstByInstantiateAsync(<span class="string">&quot;Assets/Remote_non_static.prefab&quot;</span>);</span><br><span class="line">    InstByInstantiateAsync(<span class="string">&quot;Assets/Local_static.prefab&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InstByLoadAssetAsync</span>(<span class="params"><span class="built_in">string</span> address</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    AsyncOperationHandle&lt;GameObject&gt; handle = Addressables.LoadAssetAsync&lt;GameObject&gt;(address);</span><br><span class="line">    handle.Completed += OnLoadDone;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLoadDone</span>(<span class="params">AsyncOperationHandle&lt;GameObject&gt; handle</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Instantiate(handle.Result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">InstByInstantiateAsync</span>(<span class="params"><span class="built_in">string</span> address</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Addressables.InstantiateAsync(address);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>play mode script选择use existing build，因为use asset database 模式没有统计资源依赖数据（实际上只有fps和Monoheap），线上是ab加载模式所以数据更加准确。</p>
<p>通过tools-》Event Viewer打开面板：</p>
<ul>
<li>FPS: 帧率</li>
<li>MonoHeap：内存占用</li>
<li>Event Count：每帧事件数</li>
<li>Instantiation Counts：通过Addressables.InstantiateAsync实例化的资源</li>
<li>Resource Request：每个资源的引用计数</li>
</ul>
<p>注意：当资源的引用计数为零时，并不代表该资源被回收，比如AB中的a资源引用未0，但AB自身的引用不为0，AB未被释放所以a也未释放。</p>
<h2 id="6-代码层加载资源过程（如何实现）"><a href="#6-代码层加载资源过程（如何实现）" class="headerlink" title="6. 代码层加载资源过程（如何实现）"></a>6. 代码层加载资源过程（如何实现）</h2><p>第一步初始化，加载catalog文件，解析出资源定位信息。</p>
<img src="/2021/01/15/UnityAddressable/image_4.png" class="">
<p>接下来的过程可以简单分为两步：寻址和加载。</p>
<img src="/2021/01/15/UnityAddressable/image_5.png" class="">
<ol>
<li>catalog文件会被加载并解析得出所有的Locator对象，Locator对象包括资源及其依赖的信息。</li>
<li>遍历所有的Locator对象，匹配address key，找出对应的Locator，Locator下包含了资源的Location对象，这个对象管理资源地址及其依赖信息。</li>
<li>ResourceManager类根据Locations对象上记录的ProviderId找到Provider对象，调用返回自身和其依赖的异步操作对象AsyncOperation，执行异步操作加载资源通过回调函数返回。</li>
</ol>
<p><strong>Location对象：</strong></p>
<p>可以看到上面记录的InternalId，Dependencies、ProviderId、LocatorId等信息。</p>
<p>catalog文件中记录有LocatorId，能被它解析出map信息：</p>
<p><strong>参考资料：</strong></p>
<p>Addressables官方文档</p>
<p>Addressable Asset System</p>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;Unity-Addressable-Asset-System介绍、教程和原理讲解&quot;&gt;&lt;a href=&quot;#Unity-Addressable-Asset-System介绍、教程和原理讲解&quot; class=&quot;headerl
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="资源管理" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
    
    
      <category term="Addressable" scheme="https://laoleo.github.io/tags/Addressable/"/>
    
  </entry>
  
  <entry>
    <title>项目打包策略</title>
    <link href="https://laoleo.github.io/2020/12/05/%E8%B5%84%E6%BA%90%E6%89%93%E5%8C%85%E7%AD%96%E7%95%A5/"/>
    <id>https://laoleo.github.io/2020/12/05/资源打包策略/</id>
    <published>2020-12-04T16:00:00.000Z</published>
    <updated>2022-12-07T13:39:06.616Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h2 id="项目打包策略"><a href="#项目打包策略" class="headerlink" title="项目打包策略"></a>项目打包策略</h2><p>打包策略：</p>
<ul>
<li><p>A：把整个目录打进一个ab</p>
</li>
<li><p>B：把目录下的子目录中的资源打进子目录的ab中</p>
</li>
<li><p>C：把整个目录拷贝到ab目录不打ab</p>
</li>
<li><p>D：目录下的每一个资源打一个ab，不管是否重复</p>
</li>
<li><p>E：目录下的每一个资源打一个ab，每个依赖也打成一个ab，去除重复</p>
</li>
<li><p>F：图集的图片根据tag打ab，每个tag打一个ab</p>
</li>
<li><p>G：lua打包，一个目录打成一个ab，可以选择是否编码，编码为.bytes文件，通过根据不同平台选择LuaEncoder目录下的对应编码器进去编码（利用py脚本语言执行脚本运行luajit-2.1编码器）。编码器在各种运行平台和目标平台的使用情况如下。</p>
</li>
<li><p>H：lua打包，多个目录打成一个ab，会编码</p>
</li>
</ul>
<p>各种策略应用的项目目录情况：</p>
<table>
<thead>
<tr>
<th style="text-align:left">策略</th>
<th style="text-align:left">目录</th>
<th style="text-align:left">筛选模式</th>
<th style="text-align:left">特点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">D</td>
<td style="text-align:left">Assets/GameAssets/ui</td>
<td style="text-align:left">(.asset)$</td>
<td style="text-align:left">这类资源的特点是各个模块都有分布，数量多，1比1打ab策略有利于控制ab大小粒度，属于按类型和功能模块分组策略</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/ui</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/ui/animations</td>
<td style="text-align:left">(.controller)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/ui/materials</td>
<td style="text-align:left">(.mat)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/audio</td>
<td style="text-align:left">(.ogg</td>
<td style="text-align:left">.mp3</td>
<td>.wav)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/audio/audiomixer</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/live2dcharacter</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/live2dcharacter</td>
<td style="text-align:left">(^(?!.*?(model))).+(.json</td>
<td style="text-align:left">.bytes)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/bigbg</td>
<td style="text-align:left">(.jpg</td>
<td style="text-align:left">.png)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/font</td>
<td style="text-align:left">(.ttf</td>
<td style="text-align:left">.fontsettings)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">C</td>
<td style="text-align:left">Assets/GameAssets/movie</td>
<td style="text-align:left">(.mp4)$</td>
<td style="text-align:left">这类资源一般是配置文件，或者像是mp4这种游戏中用得比较少的资源文件</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/config</td>
<td style="text-align:left">(.txt</td>
<td style="text-align:left">.png</td>
<td>.jpg)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">A</td>
<td style="text-align:left">Assets/GameAssets/shaders</td>
<td style="text-align:left"></td>
<td style="text-align:left">全局常驻的文件</td>
</tr>
<tr>
<td style="text-align:left">E</td>
<td style="text-align:left">Assets/GameAssets/scene/pj-g_scene_assets</td>
<td style="text-align:left">.*materials_dynload.+(.mat)$</td>
<td style="text-align:left">这类资源的引用比较复杂，材质贴图引用得多，有些资源需要动态加载，需要对依赖资源做去重处理。 场景、spine人物动画、特效属于这类。</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/character</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/language/[lang]/character</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/effect</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/language/[lang]/effect</td>
<td style="text-align:left">(.prefab)$</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/scene/pj-g_scene_prefab</td>
<td style="text-align:left">(._p[\d]{0,}.prefab</td>
<td style="text-align:left">._stage.prefab)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/GameAssets/language/[lang]/scene/pj-g_scene_prefab</td>
<td style="text-align:left">(._p[\d]{0,}.prefab</td>
<td style="text-align:left">._stage.prefab)$</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">F</td>
<td style="text-align:left">Assets/AtlasSource</td>
<td style="text-align:left"></td>
<td style="text-align:left">UI用的精灵图，需要根据自定义tag打图集，其实就是按功能模块分组策略</td>
</tr>
<tr>
<td style="text-align:left">G</td>
<td style="text-align:left">Assets/aounity-framework/ToLua/Lua</td>
<td style="text-align:left"></td>
<td style="text-align:left">lua文件根据模块打ab，属于按逻辑实体分组策略，类似于粒度比较大的模块，但代码文件也属于系统常驻类型，不宜分得太小粒度</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/aounity-framework/Scripts/Lua/framework</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/aounity-framework/Scripts/Lua/frameworkext</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Assets/Scripts/Lua/logic</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">H</td>
<td style="text-align:left"><p>Assets/aounity-framework/Scripts/Lua/bootstrap</p><p></p><p>Assets/Scripts/Lua/bootstrap</p></td>
<td style="text-align:left"></td>
<td style="text-align:left">lua文件根据模块打ab，同一个模块多个目录打在一起</td>
</tr>
</tbody>
</table>
<blockquote>
<p>没有写明打包策略的多语言下的目录，说明跟对应其的公用目录的打包策略一致。</p>
</blockquote>
<h2 id="Lua编译"><a href="#Lua编译" class="headerlink" title="Lua编译"></a>Lua编译</h2><p>using luajit2.1.0-beta3.</p>
<p>编码器在各种运行平台和目标平台的使用：</p>
<p>不同平台使用的编码器不同</p>
<pre><code>1.pc使用

luajit64:   win, ios 64bit

luajit32:   android 32bit

2. mac使用

编译命令

luajit\_mac32 make CC=&quot;gcc -m32&quot;

luajit\_mac64 make XCFLAGS=-DLUAJIT\_ENABLE\_GC64

luavm:        macos using luac(for u5.x). 

luajit\_mac64: win, ios 64bit

luajit\_mac32: android 32bit

以下文件mac需要执行权限

luavm/luac

luajit\_mac32/luajit

luajit\_mac64/luajit
</code></pre><blockquote>
<p>注意：没有权限mac无法编译，导致打不出lua文件的ab，也没有报错提示</p>
</blockquote>
<blockquote>
<p>其实研究ab分组策略就是研究资源依赖树实现资源加载最优的问题。</p>
</blockquote>
<p>ab分组策略原则参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/91926428">https://zhuanlan.zhihu.com/p/91926428</a></p>
<h2 id="build-package"><a href="#build-package" class="headerlink" title="build package"></a>build package</h2><p>项目构建包逻辑原理很简单，前面处理和准备好参数和数据，传递给BuildPipeline.BuildAssetBundles方法构建ab。</p>
<p>工具面板上的参数解析：</p>
<ul>
<li><p>isEncodeLua：是否时候luajit-2.1编码lua文件成字节码。</p>
</li>
<li><p>isForceRebuild：BuildAssetBundleOptions.ForceRebuildAssetBundle参数，强制重打ab，即使Asset没有更改。</p>
</li>
<li><p>isOnlyBuildLua：是否只打lua ab。√了就不会打其他资源ab，在调试真机时候更改lua代码进行调试会很方便。</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h2 id=&quot;项目打包策略&quot;&gt;&lt;a href=&quot;#项目打包策略&quot; class=&quot;headerlink&quot; title=&quot;项目打包策略&quot;&gt;&lt;/a&gt;项目打包策略&lt;/h2&gt;&lt;p&gt;打包策略：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;A：把整个目录打
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unity" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/"/>
    
      <category term="资源管理" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
    
    
      <category term="打包" scheme="https://laoleo.github.io/tags/%E6%89%93%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>场景控制流程解读</title>
    <link href="https://laoleo.github.io/2020/11/01/%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%AF%BB/"/>
    <id>https://laoleo.github.io/2020/11/01/场景控制流程解读/</id>
    <published>2020-10-31T16:00:00.000Z</published>
    <updated>2022-12-06T15:30:38.518Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span>
<h1 id="场景控制流程解读"><a href="#场景控制流程解读" class="headerlink" title="场景控制流程解读"></a>场景控制流程解读</h1><h2 id="1-初始化流程"><a href="#1-初始化流程" class="headerlink" title="1 初始化流程"></a>1 初始化流程</h2><p>场景的初始化和进出控制有SceneMgr类负责管理，SceneMgr类实例化的时候，会对所有的场景类做一系列的初始化操作，包括场景类实例化，加入场景类中的功能组件类的实例化。</p>
<img src="/2020/11/01/%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%AF%BB/image_SqQ7dNS1Cb.png" class="">
<ol>
<li><p>实例化所有注册到SceneMgr:_registerScenes()中的场景类，然后在每个场景中注入onEnterFinished和onStageLoadFinished函数，分别在进入完成和舞台加载完成时调用，控制loading页面的关闭和资源的释放</p>
</li>
<li><p>在实例化Scene Component时，执行自身的onInit函数，进行初始化的工作。</p>
</li>
</ol>
<p>以上就是场景实例化的流程。</p>
<p>加入新的场景代码需要以下：</p>
<ol>
<li><p>在SceneType文件加入场景type</p>
</li>
<li><p>在Editor的pjg&gt;场景编辑器&gt;场景导出，新增场景id和资源配置，保存导出生成t_scene配置</p>
</li>
<li><p>新增场景类代码，并加入stage组件，控制场景资源的加载。</p>
</li>
<li><p>在SceneMgr:_registerScenes()注册场景类</p>
</li>
</ol>
<h2 id="2-进入流程"><a href="#2-进入流程" class="headerlink" title="2 进入流程"></a>2 进入流程</h2><img src="/2020/11/01/%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%AF%BB/image_3NDenmx_Of.png" class="">
<ol>
<li><p>stage组件类中需要加入load函数，控制场景资源的加载，并且在资源加载完成回调中调用调用_onStageLoadFinished函数和_onAllLoaded函数</p>
</li>
<li><p>调用_onStageLoadFinished函数需在_onAllLoaded函数之前，_onAllLoaded函数其实就是调用了scene:onEnterFinished函数&#x20;</p>
</li>
</ol>
<img src="/2020/11/01/%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%AF%BB/image_xvaTyll7c-.png" class="">
<ol>
<li>场景资源其实是prefeb资源，实例化后被挂载在【SCENEROOT/场景名]】节点下</li>
</ol>
<h2 id="3-退出流程"><a href="#3-退出流程" class="headerlink" title="3 退出流程"></a>3 退出流程</h2><img src="/2020/11/01/%E5%9C%BA%E6%99%AF%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E8%A7%A3%E8%AF%BB/image_YlLPrr-tq-.png" class="">
<h2 id="4-场景组件的类型和作用"><a href="#4-场景组件的类型和作用" class="headerlink" title="4 场景组件的类型和作用"></a>4 场景组件的类型和作用</h2><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>类型</td>
<td>用途</td>
<td>相关配置表</td>
<td>其他</td>
</tr>
<tr>
<td>SceneStageBase类</td>
<td>控制场景资源（舞台）加载和释放，注入的onEnterFinished和onStageLoadFinished函数在这个类中调用</td>
<td>t_scene（在Editor上【pjg&gt;场景编辑器&gt;场景导出】生成）</td>
<td></td>
</tr>
<tr>
<td>SceneCameraBase类</td>
<td>负责相机的参数设置和相机的焦点跟随，相机的参数配置在camera表</td>
<td>t_camera</td>
<td></td>
</tr>
<tr>
<td>SceneZoneMgr类</td>
<td>负责管理场景上所有的区域，场景分区域加载是管理大资源加载的一种手段。一般简单的场景不需要加，主场景和主线副本场景比较大会分区域，需要用到这个类。</td>
<td>t_scene，t_scene_zone（在Editor【pjg&gt;场景编辑器&gt;区域导出】上生成）</td>
<td></td>
</tr>
<tr>
<td>SceneCfgFinder类</td>
<td>负责管理场景配置信息的查找，场景配置查找的代码可以写进这个类的衍生类。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SceneGlobalTouchMgr类</td>
<td>负责识别和管理场景上的屏幕触摸事件，包括点击、缩放、和拖拽。最大允许两点触摸，小屋的放大缩小就是通过这个类实现的</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TriggerFactory类</td>
<td>场景触发器，通过id初始化触发器并派发触发器根据条件触发动作。比如场景中的预制和特效加载完成触发一些动作</td>
<td>t_scene_trigger，t_scene_triggeraction</td>
<td></td>
</tr>
<tr>
<td>UnitFactoryBase类</td>
<td>管理场景里面的各个单元，比如主界面的陆吾猫的实现就可以当做一个单元</td>
<td></td>
<td></td>
</tr>
<tr>
<td>UnitBase类</td>
<td>子类作为单元各个功能组件的容器，单元类各功能的实现需要封装进UnitComponentBase类的之类</td>
<td></td>
<td></td>
</tr>
<tr>
<td>UnitComponentBase类</td>
<td>单元功能组件的封装</td>
<td></td>
</tr>
</tbody>
</table>
]]></content>
    
    <summary type="html">
    
      &lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h1 id=&quot;场景控制流程解读&quot;&gt;&lt;a href=&quot;#场景控制流程解读&quot; class=&quot;headerlink&quot; title=&quot;场景控制流程解读&quot;&gt;&lt;/a&gt;场景控制流程解读&lt;/h1&gt;&lt;h2 id=&quot;1-初始化流程&quot;&gt;&lt;a href=
    
    </summary>
    
      <category term="Unity游戏开发" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="基础系统" scheme="https://laoleo.github.io/categories/Unity%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E5%9F%BA%E7%A1%80%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="场景" scheme="https://laoleo.github.io/tags/%E5%9C%BA%E6%99%AF/"/>
    
      <category term="Scene" scheme="https://laoleo.github.io/tags/Scene/"/>
    
  </entry>
  
  <entry>
    <title>散乱知识汇集【工作日记05】</title>
    <link href="https://laoleo.github.io/2020/03/26/05-%E6%95%A3%E4%B9%B1%E7%9F%A5%E8%AF%86%E6%B1%87%E9%9B%86/"/>
    <id>https://laoleo.github.io/2020/03/26/05-散乱知识汇集/</id>
    <published>2020-03-25T16:00:00.000Z</published>
    <updated>2022-12-06T15:30:37.614Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;quality=100&amp;size=b4000_4000&amp;sec=1585232140&amp;di=19cede1f52e7d232878de1e59f7ef215&amp;src=http://gss0.baidu.com/-vo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/dbb44aed2e738bd4f69c4f49a58b87d6277ff90d.jpg" alt="Stark"></p>
<center><i style="color:#333;">(权游Stark家族图徽)</i></center>

<span id="more"></span>
<blockquote>
<p>下面的内容是，我最近几个月工作遇到的零散的技术和知识点的汇聚，定期整理归类繁杂的知识，有利于形成知识的结构化。</p>
</blockquote>
<p>目录：</p>
<ul>
<li>git相关</li>
<li>protobuf协议</li>
<li>make构建</li>
</ul>
<h2 id="git相关"><a href="#git相关" class="headerlink" title="git相关"></a>git相关</h2><h3 id="git子模块"><a href="#git子模块" class="headerlink" title="git子模块"></a>git子模块</h3><p>允许git仓库做为另一个git仓库的子目录，同时保持自己的独立提交<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加子模块，同时会创建.gitmodules保存仓库子模块的映射信息</span></span><br><span class="line">git <span class="keyword">submodule </span><span class="keyword">add </span>[url] </span><br><span class="line"></span><br><span class="line"><span class="comment"># clone含有子模块的项目后拉取子模块代码</span></span><br><span class="line">git <span class="keyword">clone </span>[url]</span><br><span class="line">git <span class="keyword">submodule </span>init</span><br><span class="line">git <span class="keyword">submodule </span>update</span><br><span class="line"><span class="comment"># 加入--recursive 同等于上面</span></span><br><span class="line">git <span class="keyword">clone </span>--recursive [url]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在子模块上更新代码</span></span><br><span class="line">git fetch</span><br><span class="line">git merge <span class="keyword">origin/master</span></span><br><span class="line"><span class="keyword"></span><span class="comment"># 在主项目中执行下面命令同等于上面操作,缺少[submodule name]默认更新所有子模块</span></span><br><span class="line">git <span class="keyword">submodule </span>update --remote [<span class="keyword">submodule </span>name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在主项目看到子模块的提交日志</span></span><br><span class="line">git log -p --<span class="keyword">submodule</span></span><br></pre></td></tr></table></figure></p>
<p>git子模块：<a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97">https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97</a><br>业界文档：<a target="_blank" rel="noopener" href="https://juejin.im/post/5addeb48518825672a028a3b">https://juejin.im/post/5addeb48518825672a028a3b</a></p>
<h3 id="git-diff命令"><a href="#git-diff命令" class="headerlink" title="git-diff命令"></a>git-diff命令</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 显示更改文件数</span><br><span class="line">git diff <span class="keyword">COMMIT</span> <span class="keyword">COMMIT</span> <span class="comment">--shortstat  </span></span><br><span class="line">#显示更改的文件名</span><br><span class="line"><span class="comment">--name-status </span></span><br><span class="line"></span><br><span class="line"># 筛选文件</span><br><span class="line"># 合并后对比一些特定文件的情况下，这条命令尤为重要，后买可以接对多个文件名，用vscode的diff插件还要一个一个文件检查</span><br><span class="line"># 假如合并文件有几百个，工作量是艰巨的，可以写个shell脚本处理对比结果，写进txt文件</span><br><span class="line"># 我最近就有个这样的需求，幸好有这条命令</span><br><span class="line">git diff <span class="keyword">COMMIT</span> <span class="keyword">COMMIT</span> *.lua *.js </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 筛选具体目录下的目标文件，注意<span class="type">path</span>从当前目录起始</span><br><span class="line">git diff <span class="keyword">COMMIT</span> <span class="keyword">COMMIT</span> <span class="type">path</span>/<span class="keyword">to</span>/target  </span><br><span class="line"></span><br><span class="line"># 版本信息</span><br><span class="line">git <span class="keyword">show</span> <span class="keyword">COMMIT</span> </span><br></pre></td></tr></table></figure>
<h2 id="protobuf协议"><a href="#protobuf协议" class="headerlink" title="protobuf协议"></a>protobuf协议</h2><p>游戏中的数据通讯协议主要是Protobuf+socket，只有登录时拿到ID和session或token用到了http协议。对于数据响应要求高、低延迟甚至实时的应用程序，像游戏、直播、即时聊天，一般都会用到protobuf作为数据结构化和序列化的协议。</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>Protobuf全称Protocol Buffer，是google内部广泛使用的结构化数据存储、数据序列化的协议。下面是google官方给出的定义：<br>Protocol Buffers 是一种轻便高效的结构化数据存储格式，可以用于结构化数据序列化，很适合做数据存储或 RPC 数据交换格式。它可用于通讯协议、数据存储等领域的语言无关、平台无关、可扩展的序列化结构数据格式。</p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><p>首先从定义上，可以看到一个描述protobuf的关键字：方便高效。</p>
<ul>
<li>proobuf的语法比xml简洁方便</li>
</ul>
<p>拿常见的数据序列化协议Json，xml与protobuf做对比：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.proto</span><br><span class="line">package lm; </span><br><span class="line">message helloworld </span><br><span class="line">&#123; </span><br><span class="line">   required int32     id = 1;  // ID </span><br><span class="line">   required string    str = 2;  // str </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">.xml</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">helloword</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">str</span>&gt;</span>helloworld<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>protobuf是二进制协议，比同为文本协议的json和xml的读写操作都要高效，快捷。<br>文本协议要读进内存，会被解析成二进制，而pb属于二进制协议，所以相对文本协议解析速度更快。</li>
</ul>
<p>官方针对protobuf的性能将其更各种数据协议做了测试比较，下图是通过各个协议对一个对象操作的时间–Total time，包括创建对象、将对象序列化为内存中的字节序列，然后再反序列化的过程。</p>
<p><img src="http://m.qpic.cn/psc?/V12x89qA2LlAEO/YPhsM5mUO5.bFmyDEhTOh.bBxFLbiHnVZm4ijUstjs4299r7Qq73xp9N6FkEC3fTipoSpwWAoyqyDu6AavAyu7I6I3SMKyuZQdfOcLaFKu0!/b&amp;bo=sAKrAbACqwEDGTw!&amp;rf=viewer_4" alt="image"></p>
<p>protobuf性能测试报告：<a target="_blank" rel="noopener" href="https://code.google.com/archive/p/thrift-protobuf-compare/wikis/Benchmarking.wiki">https://code.google.com/archive/p/thrift-protobuf-compare/wikis/Benchmarking.wiki</a></p>
<ul>
<li>protobuf协议更小</li>
</ul>
<p>各协议的字节码大小对比：<br><img src="http://m.qpic.cn/psc?/V12x89qA2LlAEO/NZ9C4PTRAOGVNvAxFZDwtwanSqa8Dd8UwWZwMJTLqealcb2nqDNffsJmDvN0EJWV7GIgHvUar5NDR37*AGkxwA!!/b&amp;bo=SwTNAUsEzQEDCSw!&amp;rf=viewer_4" alt="image"></p>
<ul>
<li>protobuf与平台无关，与语言无关，所以兼容性更好</li>
</ul>
<p>java中使用json和xml数据结构，使用使用相应的包支持的，jackson（java的标准json库）和javolution xmlformat（javolution库中格式化xml的API）。<br>而protobuf可以通过编译器将描述数据结构的.proto文件编译成各种目标语言，github仓库上标有目标语言有：c++、java、c#、JavaScript、Ruby、Go、PHP、Dart、Objective-C。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf">https://github.com/protocolbuffers/protobuf</a></p>
<h2 id="make构建"><a href="#make构建" class="headerlink" title="make构建"></a>make构建</h2><p>make是一个常用的构建工具，多用于C语言项目，但在一些大型的项目中使用频率也比较高。</p>
<p>假如一个工程里有个makefile文件，往往都需要用到make命令来构建。</p>
<h3 id="详细介绍："><a href="#详细介绍：" class="headerlink" title="详细介绍："></a>详细介绍：</h3><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2015/02/make.html">http://www.ruanyifeng.com/blog/2015/02/make.html</a></p>
<h3 id="如何用make来构建node-js项目"><a href="#如何用make来构建node-js项目" class="headerlink" title="如何用make来构建node.js项目"></a>如何用make来构建node.js项目</h3><p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2015/03/build-website-with-make.html">http://www.ruanyifeng.com/blog/2015/03/build-website-with-make.html</a></p>
<h3 id="windows下使用make命令安装教程"><a href="#windows下使用make命令安装教程" class="headerlink" title="windows下使用make命令安装教程"></a>windows下使用make命令安装教程</h3><p>下载MinGW：<a target="_blank" rel="noopener" href="http://sourceforge.net/projects/mingw/files/latest/download?source=files">http://sourceforge.net/projects/mingw/files/latest/download?source=files</a></p>
<p>下载后假如没在bin下找make.exe，可以到MinGW instanllation manager中找到下载MinGW-make.exe，勾选包然后到左上角点击apply change下载(记得把MinGW-make改名成make)。最好把basic setup都下了。</p>
<p>最后记得手动添加环境变量：path/to/MinGW/bin，就可以使用了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;amp;quality=100&amp;amp;size=b4000_4000&amp;amp;sec=1585232140&amp;amp;di=19cede1f52e7d232878de1e59f7ef215&amp;amp;src=http://gss0.baidu.com/-vo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/dbb44aed2e738bd4f69c4f49a58b87d6277ff90d.jpg&quot; alt=&quot;Stark&quot;&gt;&lt;/p&gt;
&lt;center&gt;&lt;i style=&quot;color:#333;&quot;&gt;(权游Stark家族图徽)&lt;/i&gt;&lt;/center&gt;
    
    </summary>
    
      <category term="工具" scheme="https://laoleo.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="git" scheme="https://laoleo.github.io/tags/git/"/>
    
      <category term="protobuf" scheme="https://laoleo.github.io/tags/protobuf/"/>
    
      <category term="Protocol Buffer" scheme="https://laoleo.github.io/tags/Protocol-Buffer/"/>
    
      <category term="make" scheme="https://laoleo.github.io/tags/make/"/>
    
  </entry>
  
  <entry>
    <title>不得不懂的工作流优化技能【工作日记04】</title>
    <link href="https://laoleo.github.io/2019/12/20/04-%E4%B8%8D%E5%BE%97%E4%B8%8D%E6%87%82%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BC%98%E5%8C%96%E6%8A%80%E8%83%BD/"/>
    <id>https://laoleo.github.io/2019/12/20/04-不得不懂的工作流优化技能/</id>
    <published>2019-12-19T16:00:00.000Z</published>
    <updated>2022-12-06T15:30:37.611Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://pic1.win4000.com/wallpaper/2017-11-08/5a029f1175340.jpg" alt="我是图片"></p>
<span id="more"></span>
<blockquote>
<p>工作日记是笔者记录在日常工作中对负责的前端项目和任务的总结和提炼，在工作中寻乐趣，在代码中找灵魂，输出工作中有价值有意思的沉淀，用娱乐精神分享知识。</p>
</blockquote>
<blockquote>
<p>下文可能存在图片未显示问题，可异步到 <a target="_blank" rel="noopener" href="https://juejin.im/post/5dcd569d51882510b265fc62">原文</a> 阅读</p>
</blockquote>
<p>很多朋友都知道我们团队是在智能音箱上开发语音技能业务，问答类和剧情类是语音技能中常见的两大类，其中剧情类是我们家游戏重中之重。</p>
<p>剧情游戏的数据结构是树，称为剧情树。上线游戏之前，得先在后台手动录入剧情树，包括创建剧情节点、填入语料信息、关键词等等。故事内容小的不出一百个剧情节点，大的还要划分章节，剧情节点总数可达千级以上。<br><img src="http://b184.photo.store.qq.com/psb?/V12x89qA2LlAEO/7EoUcLRyVwuW4jKAVcqKAUgwghtnsujZtzd9TMD8Iow!/b/dLgAAAAAAAAA&amp;bo=fgWqAX4FqgEDCSw!&amp;rf=viewer_4" alt="image"></p>
<p>那么人工录入这颗庞大的剧情树的时间成本会制约剧情游戏上线时间，况且这么多数据靠人工操作，那人岂不是要心态爆炸。</p>
<p>有大佬说过：有麻烦的地方，就有机会。谁说的我想不起来。</p>
<center><br>    <img width="200" src="http://b191.photo.store.qq.com/psb?/V12x89qA2LlAEO/5Qtfvc0ROsoe3VEROyr3amxeZ9EQuFRpLQLeAKzRFnw!/b/dL8AAAAAAAAA&bo=2gDwANoA8AARCT4!&rf=viewer_4"></img><br></center>

<p>况且不忍心看着运营妹子把青春都浪费在重复无价值的工作上，于是就有了我，一位技术不咋地但乐善好施的前端专业切图手，挺身而出，做了以下事情。</p>
<center><br>    <img width="200" src="http://m.qpic.cn/psb?/V12x89qA2LlAEO/ba.jrAo5EBEsb8Z6kUXjh1LKPc.BE.*1gVfOx54UmXY!/b/dLgAAAAAAAAA&bo=8ADwAPAA8AACOR0!&rf=viewer_4"></img><br></center>


<ul>
<li><a href="#工作流分析">工作流分析</a></li>
<li><a href="#推动立项">推动立项</a></li>
<li><a href="#实现需求">实现需求</a></li>
<li><a href="#效果和收益">效果和收益</a></li>
</ul>
<h2 id="工作流分析"><a href="#工作流分析" class="headerlink" title="工作流分析"></a>工作流分析</h2><p>把录入剧情树的工作流程画成图来表达会更加容易说明问题：<br><img src="http://b182.photo.store.qq.com/psb?/V12x89qA2LlAEO/irSMmVs9SQXAZc.sQNRUNvzUF2AcpE1qI11nC38RsKs!/b/dLYAAAAAAAAA&amp;bo=WAK3AFgCtwADCSw!&amp;rf=viewer_4" alt="image"></p>
<p>很简单的一个工作流，把效率不高的环节拆分成多个组合因素，这里的目的主要是录入剧情树的相关信息，把信息分类如下：<br><img src="http://b182.photo.store.qq.com/psb?/V12x89qA2LlAEO/KL0TIziHozdKiDj0ij7KTQgemnqVWU95I4rM5YdTB2I!/b/dLYAAAAAAAAA&amp;bo=lALpAZQC6QEDCSw!&amp;rf=viewer_4" alt="image"></p>
<p>其中有些信息是可以直接从剧本中去是识别提炼出来形成结构化数据，将这个任务自动化，交给机器来处理，人工只负责剧本不需要出现、数据操作类的信息，那么一下步就是按自动/人工的范畴来重整信息。<br><img src="http://b309.photo.store.qq.com/psb?/V12x89qA2LlAEO/360ys0nAUzliwPsseN63c1piKE.gxPEOVybPBtnENpU!/b/dDUBAAAAAAAA&amp;bo=5ANBAuQDQQIDCSw!&amp;rf=viewer_4" alt="image"></p>
<p>右边的就是重整后的信息分类，两个分类可以演化成两个新阶段，机器分析剧本自动化阶段和人工补全阶段，替换掉前面效率低下的部分就可以形成新的工作流：<br><img src="http://b191.photo.store.qq.com/psb?/V12x89qA2LlAEO/YbT32wTf*K8*knQAtn5Jh5W7MlFfZp.ugGPtwVawxEU!/b/dL8AAAAAAAAA&amp;bo=0AIcAdACHAEDCSw!&amp;rf=viewer_4" alt="image"></p>
<p>优化升级后的工作流需要一个剧本分析器来为它赋能。</p>
<p>现在的感觉就像仿佛看见了曙光。</p>
<center><br>    <img width="200" src="http://m.qpic.cn/psb?/V12x89qA2LlAEO/o4r2aVqjJIaMwG*LrzJSw0Xuc0XZ2AdKU.2r58u8XxM!/b/dPMAAAAAAAAA&bo=9wCaAAAAAAACZy4!&rf=viewer_4"></img><br></center>


<p>你以为我会现在马上动手做吗？不，这仅仅是我歪歪的一个东西，并没有经过各方面的认同，需要请求下产品和技术老大的意见，否者辛辛苦苦做出来，得不到大家认同，没有功劳更没有苦劳。</p>
<h2 id="项目立项"><a href="#项目立项" class="headerlink" title="项目立项"></a>项目立项</h2><p>在周会上回报工作情况时候，顺水推舟的拿出上面的工作流分析，向组内提出了这个优化方案。大伙也没啥意见，反正不用他们搬砖，真是替你们有我这么个好伙伴感到开心。</p>
<center><br>    <img width="200" src="http://b184.photo.store.qq.com/psb?/V12x89qA2LlAEO/bmc64lJ4xpxu59RZC9Xq7DRVxyhVRuZASlr.L3L9iiM!/b/dLgAAAAAAAAA&bo=8ADWAPAA1gARCT4!&rf=viewer_4"></img><br></center>


<p>接着找到产品，需要确定两点：</p>
<ul>
<li>剧情剧本的统一格式（假如策划伙伴每人各持一套，兼容代码会让人写到吐）</li>
<li>解析器具体的功能点</li>
</ul>
<p>最终这个项目的面貌逐渐清晰：<br><!-- 具体需求 --></p>
<ul>
<li>剧本格式<figure class="highlight node-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一章 互动</span><br><span class="line"><span class="meta prompt_">...</span></span><br><span class="line">1. 已经是晚上11点了</span><br><span class="line">你的女神突然很想吃宵夜</span><br><span class="line">你会帮她叫外卖还是让她赶紧睡觉？  </span><br><span class="line">(1-1： 帮她叫外卖，叫外卖，外卖。1-2： 让她赶紧睡觉，赶紧睡觉，睡觉)</span><br><span class="line"><span class="meta prompt_">...</span></span><br></pre></td></tr></table></figure></li>
<li>功能<ul>
<li>上传.docx文档剧本</li>
<li>解析提出信息</li>
<li>验证剧情树结构</li>
<li>输出结构化数据</li>
</ul>
</li>
</ul>
<h2 id="实现需求"><a href="#实现需求" class="headerlink" title="实现需求"></a>实现需求</h2><p>这里我们直接看关键功能：解析剧本提炼信息。这里就包含两个步骤：解析docx文档和识别提炼信息。</p>
<ul>
<li>解析docx文档</li>
</ul>
<p>自己实现个解析docx文档程序？一般人不会那么干，那是牛人做的事情。<br><!--【表情包：牛】--></p>
<center><br>    <img width="200" src="http://m.qpic.cn/psb?/V12x89qA2LlAEO/uU8WcIx9l0DnUXjQSaLjPMau6FWllCnmMZu07ThMPik!/b/dFMBAAAAAAAA&bo=5gC3AOYAtwACaU0!&rf=viewer_4"></img><br></center>

<p><code>mammoth.js</code>可以解决这个问题。</p>
<blockquote>
<p>Mammoth is designed to convert .docx documents, such as those created by Microsoft Word, and convert them to HTML. </p>
</blockquote>
<p>意思是主要用于将word的.docx文档转换成HTML文档，除此之外mammoth有个extractRawText方法可以转换成row text行文本，以换行符划分。</p>
<p>将解析文档功能封装成函数:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mammoth = <span class="built_in">require</span>(<span class="string">&#x27;mammoth&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析docx文本内容并导出</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path .docx 路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> extractRawText = <span class="keyword">function</span> (<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> opt = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (file <span class="keyword">instanceof</span> <span class="title class_">Buffer</span>) &#123;</span><br><span class="line">    opt.<span class="property">buffer</span> = file;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> file === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    opt.<span class="property">path</span> = file;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">global</span>.<span class="property">log_debug</span>.<span class="title function_">error</span>(<span class="string">`[parseDocxScript]:<span class="subst">$&#123;file&#125;</span> 未知类型`</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`<span class="subst">$&#123;file&#125;</span> 未知类型`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    mammoth.<span class="title function_">extractRawText</span>(opt)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(result); <span class="comment">// &#123;value, message&#125;</span></span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>文档内容以String类型存在于result.value中，其中换行符会被转换成\n\n。</p>
<ul>
<li>识别并提炼信息</li>
</ul>
<p>识别就是字符串遍历和检测，利用正则表达式足以解决，其实就是使用标记法，待识别的数据有其相关的标记。</p>
<p>根据剧本格式，需要正则识别的信息有：</p>
<ul>
<li>章节：第一章<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/第(.*)章(.*)$/</span></span><br></pre></td></tr></table></figure></li>
<li>剧情编号（ID）：2. 2-1. <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/^([\d\-]+)\./</span></span><br></pre></td></tr></table></figure></li>
<li>分支：（5：回复，回。6：不理会）<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/^[（\()](.*)[）\)]$/</span></span><br></pre></td></tr></table></figure></li>
<li>分支中的剧情编号<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/([\d\-]+)/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以以<code>\n\n</code>为分隔符将内容切分成数组，遍历去逐行识别检验。</p>
<details><br><summary>code</summary><br><pre><code class="hljs"><br>/*<em>
 </em> 解析剧本，结构化信息<br> <em> 
 </em> @param &#123;String&#125; path .docx 路径<br> <em> @param &#123;Object&#125; opt 拼装数据需要的参数sceneId
 </em>/<br>const parseScript = function (file, opt = &#123;&#125;) &#123;<br>  return extractRawText(file)<br>    .then(result =&gt; &#123;<br>      var text = result.value;<br>      var aSource = text.split(‘\n\n’);<br>      var temp = aSource.filter(v =&gt; !!v);<br>      var dialog = &#123;&#125;,<br>        dialogs = [],<br>        chapters = [],<br>        currId,<br>        currChar;<br>      console.log(temp);<br>      temp.forEach(v =&gt; &#123;<br>        var matchIdReg = /^([\d-]+)./, // 2 2-1<br>          matchNextIdReg = /([\d-]+)/,<br>          matchChooseText = /^<a href=".*">（()</a>[）)]$/,<br>          matchChapText = /第(.<em>)章(.</em>)$/,<br>          res;<br>        // 解析章节<br>        res = v.trim().match(matchChapText);<br>        if (res) &#123;<br>          var chapNo = currChar = zhDigitToArabic(res[1]);<br>          var isExit = !!chapters.find(v =&gt; v.chapNo === chapNo);<br>          !isExit &amp;&amp; chapters.push(&#123;<br>            chapNo,<br>            title: res[2].trim()<br>          &#125;);<br>        &#125;<br>        // 识别节点<br>        res = v.match(matchIdReg);<br>        if (res) &#123;<br>          dialog = &#123;&#125;;<br>          currId = dialog.id = res[1];<br>          currChar &amp;&amp; (dialog.chapNo = currChar);<br>          v = v.replace(matchIdReg, ‘’);<br>        &#125;<br>        // 判断分支语句<br>        res = v.match(matchChooseText);<br>        if (res) &#123;<br>          const t = res[1];<br>          t.split(/[。；]/).forEach(v =&gt; &#123;<br>            // v =&gt; 2：xxx || 接4<br>            var item = &#123;&#125;,<br>              keyword;<br>            res = v.match(matchNextIdReg);<br>            if (res === null) return;<br>            item.nextId = res[1];<br>            keyword = v.split(‘：’)[1];<br>            keyword &amp;&amp; (item.keywords = keyword.trim().split(‘，’));<br>            !dialog.children &amp;&amp; (dialog.children = []);<br>            dialog.children.push(item);<br>          &#125;);<br>        &#125; else &#123;<br>          // 处理内容语句<br>          if (currId === dialog.id &amp;&amp; !/【全文完】/.test(v)) &#123;<br>            if (dialog.content === undefined) dialog.content = ‘’;<br>            dialog.content += <code>$&#123;v&#125;\n\n</code>;<br>          }<br>        }<br>        // 装载dialog<br>        if (dialog.id &amp;&amp; dialog.content &amp;&amp; !dialogs.includes(dialog)) dialogs.push(dialog);<br>      });<br>    return { dialogs, chapters }<br>};<br></code></pre><br></details>

<h2 id="效果和收益"><a href="#效果和收益" class="headerlink" title="效果和收益"></a>效果和收益</h2><p>当打通流程之后，只需轻轻点击上传剧本，弹指一挥间，一棵可爱的剧情树已经出现在你面前，处理时间平均200+ms，整个过程1s不到。<br><!--【图片。gif】--><br><img src="http://b264.photo.store.qq.com/psb?/V12x89qA2LlAEO/oaTG.bAfWJtIE7Y944ngY0o5RnP5gragZki3JkEbu6Y!/b/dAgBAAAAAAAA&amp;bo=xgX*AQAAAAACR14!&amp;rf=viewer_4" alt="image"></p>
<p>之前完整的配一个复杂的剧情树要配一天，目前只需要两小时不到。在效率上得到了大幅度的提升，对于运营伙伴来说简直是如获至宝，用他们的话来说就是大快人心。</p>
<center><br>    <img width="200" src="http://b190.photo.store.qq.com/psb?/V12x89qA2LlAEO/97GNFgAvlnbwg.czssmO*4312jTHJXbY6zP1lm5.Em8!/b/dL4AAAAAAAAA&bo=WgHfAAAAAAAChyc!&rf=viewer_4"></img><br></center>






]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://pic1.win4000.com/wallpaper/2017-11-08/5a029f1175340.jpg&quot; alt=&quot;我是图片&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="前端" scheme="https://laoleo.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="工作日记" scheme="https://laoleo.github.io/categories/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%97%A5%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>使用console输出网站logo彩蛋【工作日记03】</title>
    <link href="https://laoleo.github.io/2019/11/18/03-%E4%BD%BF%E7%94%A8console%E8%BE%93%E5%87%BA%E7%BD%91%E7%AB%99logo%E5%BD%A9%E8%9B%8B/"/>
    <id>https://laoleo.github.io/2019/11/18/03-使用console输出网站logo彩蛋/</id>
    <published>2019-11-17T16:00:00.000Z</published>
    <updated>2022-12-06T15:30:37.608Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://pic1.win4000.com/wallpaper/2017-11-08/5a029f187ca9f.jpg" alt="我是图片"></p>
<span id="more"></span>
<blockquote>
<p>工作日记是笔者记录在日常工作中对负责的前端项目和任务的总结和提炼，在工作中寻乐趣，在代码中找灵魂，输出工作中有价值有意思的沉淀，分享知识，娱乐自己。</p>
</blockquote>
<blockquote>
<p>下文可能存在图片未显示问题，可异步到 <a target="_blank" rel="noopener" href="https://juejin.im/post/5dca2e56518825574d2149e5">原文</a> 阅读</p>
</blockquote>
<p>相信大多数年轻人上班时都会偶尔刷下知乎，吃瓜或者提问题，一天我美若天仙的GF发了一张截图过来，说她知乎刷着刷着感觉遇到了bug，于是打开F12，看到了这个彩蛋。</p>
<p><img src="http://b131.photo.store.qq.com/psb?/V12x89qA2LlAEO/piwEkxKgLCg69fWgJGgwSe9E98LHnzpFwrP938F4ufs!/b/dIMAAAAAAAAA&amp;bo=NANnAQAAAAADB3M!&amp;rf=viewer_4" alt="zhihu-egg"></p>
<p>除了不得不敬佩她的敬业精神外（她也是前端一枚），我肯定是不能涨他人志气，灭自己威风的。我平静的回了句，这玩意太简单，我也能整出来。</p>
<p>编辑器打开，手在键盘上凝固，不知如何敲出第一个代码…</p>
<html><br><center><br>    <img src="http://b338.photo.store.qq.com/psb?/V12x89qA2LlAEO/cRggOlfoPJaxWQWwXauWV1aJi57jspW6RmKORJeW8Xk!/b/dFIBAAAAAAAA&bo=lgCWAAAAAAACFzM!&rf=viewer_4"></img><br></center><br></html>



<p>难道要一个个字符的画上去？那得画到什么何年何月？<br><!--【惊讶二级】--></p>
<html><br><center><br>    <img src="http://b182.photo.store.qq.com/psb?/V12x89qA2LlAEO/7vb2fhkTRegac9U7pv.iMHmoIf2hqE2x9ZJIYSpvsZw!/b/dLYAAAAAAAAA&bo=8ADwAAAAAAARBzA!&rf=viewer_4"></img><br></center><br></html>

<p>既然自己没那个美术天赋，那就动脑子吧，何况我本身就靠脑子吃饭的呀。</p>
<!--【恍然大悟】-->
<html><br><center><br>    <img width="200" src="http://b318.photo.store.qq.com/psb?/V12x89qA2LlAEO/sxtTcevZyQ55Zqb.olsITndQzMmw4oZwwoQmrGrn*O8!/b/dD4BAAAAAAAA&bo=LAEsAQAAAAACFzM!&rf=viewer_4"></img><br></center><br></html>

<p>既然是靠脑子吃饭的，那就得对得起我这聪明的脑子。先问问google大哥如何解决。</p>
<p>一搜，不出我所料，已经有总结文章了。站在巨人的肩膀也不失为一种小聪明。</p>
<ul>
<li><a href="hhttps://aotu.io/notes/2016/06/22/An-interesting-experience-on-console/index.html">让console充满情怀</a></li>
</ul>
<!--【得意】-->
<html><br><center><br>    <img width="200" src="http://b182.photo.store.qq.com/psb?/V12x89qA2LlAEO/jj43nXXEcKXqN2wnHhnyHnLuq6OBaIQmVrpngsNZdmw!/b/dLYAAAAAAAAA&bo=8ADwAAAAAAACJwM!&rf=viewer_4"></img><br></center><br></html>

<p>提取出有用的信息：</p>
<ol>
<li>console的方法可以填入占位符，类似c语言的print方法中的占位符。<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(<span class="keyword">object</span> [, <span class="keyword">object</span>, …])</span><br></pre></td></tr></table></figure></li>
<li>占位符</li>
</ol>
<table>
<thead>
<tr>
<th>格式占位符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>%s</td>
<td>字符串</td>
</tr>
<tr>
<td>%d or %i</td>
<td>整数</td>
</tr>
<tr>
<td>%f</td>
<td>浮点数</td>
</tr>
<tr>
<td>%o</td>
<td>可展开的DOM</td>
</tr>
<tr>
<td>%O</td>
<td>列出DOM的属性</td>
</tr>
<tr>
<td>%c</td>
<td>根据提供的css样式格式化字符串</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>字符画<br>打印出的logo图案叫字符画，是可以用软件分析图片生成。亲测下面的软件比较好用：</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="http://pan.baidu.com/share/link?shareid=3161588673&amp;uk=3509597415">ASCII Generator</a></li>
</ul>
<p>从上面第二点得知，原来console可以使用css规则格式化字符串，再结合软件将logo生成字符画，这个网站彩蛋不就搞定了吗，如此简单。</p>
<p>具体步骤：</p>
<ol>
<li>制作字符画  </li>
</ol>
<p>使用ASCII Generator上传logo图片，生成字符画，调节大小，抖动，然后选择好看的字符，调整好后可以拷贝到IDE了（粘贴到console.info(<code></code>)中，否则会出现换行符），如果不是很像可以增删一些字符微调一下。  </p>
<p>这里要注意的是，字符画在IDE里表现会有点变形，可能打印出来也会变形，这是由字体不同造成的，回到软件中将字体调为微软雅黑，再粘贴回去，即使IDE上有点变形但打印出来不会。</p>
<p>但是打印字符画有点单调，加点文字点缀点缀，会碰撞出更美的火花，加上我们团队的队名和标语。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">console.log(`</span><br><span class="line">                      <span class="number"> 7007 </span>                      </span><br><span class="line">                <span class="number"> 7000000000000007 </span>                </span><br><span class="line">           <span class="number"> 760000000000000000000000057 </span>          </span><br><span class="line">        <span class="number"> 76000008888888888888880800000005 </span>        </span><br><span class="line">      <span class="number"> 700008888868688868888880000008860006 </span>      </span><br><span class="line">     <span class="number"> 800088886888688888888800067 </span>    <span class="number"> 700002 </span>    </span><br><span class="line">   <span class="number"> 70088888888888868888880007 </span>       <span class="number"> 7088000 </span>   </span><br><span class="line">  <span class="number"> 3008868800000088868888005 </span>         <span class="number"> 70888800 </span>  </span><br><span class="line"> <span class="number"> 7008888808000080888888801 </span>     <span class="number"> 76000088888800 </span> </span><br><span class="line"> <span class="number"> 008868808 </span>    <span class="number"> 608888808 </span>    <span class="number"> 70000000888888806 </span></span><br><span class="line"><span class="number"> 7088688800 </span>    <span class="number"> 608888807 </span>   <span class="number"> 700000888888688800 </span></span><br><span class="line"><span class="number"> 3088868800 </span>    <span class="number"> 808888007 </span>           <span class="number"> 7088868880 </span>                加班熊工作室</span><br><span class="line"><span class="number"> 2088686800 </span>    <span class="number"> 608888807 </span>           <span class="number"> 70888888807 </span>         </span><br><span class="line"><span class="number"> 2088888800 </span>    <span class="number"> 808888007 </span>           <span class="number"> 70888688007 </span>         ——国内精品AI语音游戏开创者——</span><br><span class="line"><span class="number"> 1088888880 </span>    <span class="number"> 808888807 </span>   <span class="number"> 000000000888688880 </span></span><br><span class="line"> <span class="number"> 0088888007 </span>   <span class="number"> 700888007 </span>   <span class="number"> 000000000888888800 </span></span><br><span class="line"> <span class="number"> 0088888806 </span>    <span class="number"> 70000007 </span>   <span class="number"> 808888888888888007 </span></span><br><span class="line"> <span class="number"> 70086888803 </span>     <span class="number"> 758007 </span>   <span class="number"> 00888686888888005 </span> </span><br><span class="line">  <span class="number"> 70088000006 </span>               <span class="number"> 8088686868888002 </span>  </span><br><span class="line">   <span class="number"> 108057878003 </span>             <span class="number"> 808688868888007 </span>   </span><br><span class="line">   <span class="number"> 70007 </span>1 <span class="number"> 800087 </span>          <span class="number"> 6088888880006 </span>     </span><br><span class="line">   <span class="number"> 00800 </span><span class="number"> 7 </span> <span class="number"> 700000008888888608888800008 </span>       </span><br><span class="line">  <span class="number"> 8088800 </span>77<span class="number"> 7080800000000000808000004 </span>         </span><br><span class="line"> <span class="number"> 400000000000800080808000000000000047 </span>           </span><br><span class="line">700000000000000000000000000000007                `);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>加上样式<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.<span class="built_in">log</span>(<span class="string">&quot;%cHello,%cWorld&quot;</span>, <span class="string">&quot;color:red;&quot;</span>, <span class="string">&quot;color:blue;&quot;</span>);</span><br></pre></td></tr></table></figure>
%c占位符的样式会影响其字后的字符串，样式之间符合从前到后的覆盖逻辑，后面的样式会覆盖前面的样式。</li>
</ol>
<p><img src="http://b338.photo.store.qq.com/psb?/V12x89qA2LlAEO/grdHiKfwZrCevmZGh8HoFlQ7X7fVWTd4.Ekyhl2zon8!/b/dFIBAAAAAAAA&amp;bo=OQMxAAAAAAADByk!&amp;rf=viewer_4" alt="image"></p>
<p>那我们就可以在不同位置插入%c占位符，来控制不同元素字符画、队名和标语之间的样式。代码封装成函数：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">const consoleEgg = () =&gt; &#123;</span><br><span class="line">  const egg = `%c</span><br><span class="line">                      <span class="number"> 7007 </span>                      </span><br><span class="line">                <span class="number"> 7000000000000007 </span>                </span><br><span class="line">           <span class="number"> 760000000000000000000000057 </span>          </span><br><span class="line">        <span class="number"> 76000008888888888888880800000005 </span>        </span><br><span class="line">      <span class="number"> 700008888868688868888880000008860006 </span>      </span><br><span class="line">     <span class="number"> 800088886888688888888800067 </span>    <span class="number"> 700002 </span>    </span><br><span class="line">   <span class="number"> 70088888888888868888880007 </span>       <span class="number"> 7088000 </span>   </span><br><span class="line">  <span class="number"> 3008868800000088868888005 </span>         <span class="number"> 70888800 </span>  </span><br><span class="line"> <span class="number"> 7008888808000080888888801 </span>     <span class="number"> 76000088888800 </span> </span><br><span class="line"> <span class="number"> 008868808 </span>    <span class="number"> 608888808 </span>    <span class="number"> 70000000888888806 </span></span><br><span class="line"><span class="number"> 7088688800 </span>    <span class="number"> 608888807 </span>   <span class="number"> 700000888888688800 </span></span><br><span class="line"><span class="number"> 3088868800 </span>    <span class="number"> 808888007 </span>           <span class="number"> 7088868880 </span>                %c加班熊工作室%c</span><br><span class="line"><span class="number"> 2088686800 </span>    <span class="number"> 608888807 </span>           <span class="number"> 70888888807 </span>         </span><br><span class="line"><span class="number"> 2088888800 </span>    <span class="number"> 808888007 </span>           <span class="number"> 70888688007 </span>         ——%c国内精品AI语音游戏开创者%c——</span><br><span class="line"><span class="number"> 1088888880 </span>    <span class="number"> 808888807 </span>   <span class="number"> 000000000888688880 </span></span><br><span class="line"> <span class="number"> 0088888007 </span>   <span class="number"> 700888007 </span>   <span class="number"> 000000000888888800 </span></span><br><span class="line"> <span class="number"> 0088888806 </span>    <span class="number"> 70000007 </span>   <span class="number"> 808888888888888007 </span></span><br><span class="line"> <span class="number"> 70086888803 </span>     <span class="number"> 758007 </span>   <span class="number"> 00888686888888005 </span> </span><br><span class="line">  <span class="number"> 70088000006 </span>               <span class="number"> 8088686868888002 </span>  </span><br><span class="line">   <span class="number"> 108057878003 </span>             <span class="number"> 808688868888007 </span>   </span><br><span class="line">   <span class="number"> 70007 </span>1 <span class="number"> 800087 </span>          <span class="number"> 6088888880006 </span>     </span><br><span class="line">   <span class="number"> 00800 </span><span class="number"> 7 </span> <span class="number"> 700000008888888608888800008 </span>       </span><br><span class="line">  <span class="number"> 8088800 </span>77<span class="number"> 7080800000000000808000004 </span>         </span><br><span class="line"> <span class="number"> 400000000000800080808000000000000047 </span>           </span><br><span class="line">700000000000000000000000000000007                `;</span><br><span class="line">  const defaultStyle = &#x27;color: rgba(0,0,0,.7);&#x27;;</span><br><span class="line">  const titleStyle = &#x27;color: <span class="comment">#fff;background: rgba(52,55,86,1);padding: 2px 10px; border-radius: 2px;font-family: 微软雅黑;&#x27;;</span></span><br><span class="line">  const sloganStyle = &#x27;color: <span class="comment">#343756&#x27;;</span></span><br><span class="line"></span><br><span class="line">  console.log(egg, defaultStyle, titleStyle, defaultStyle, sloganStyle, defaultStyle);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>最终效果：<br><img src="http://b190.photo.store.qq.com/psb?/V12x89qA2LlAEO/MO7ODEnWcPYkDOJMM8VfeO1LROYS.5QE2NzR1qshQTQ!/b/dL4AAAAAAAAA&amp;bo=KgN8AQAAAAADB3Y!&amp;rf=viewer_4" alt="image"></p>
<p>把图片发给GF，她立马秒变迷妹，发来表情：</p>
<html><br><center><br>    <img width="200" src="http://m.qpic.cn/psb?/V12x89qA2LlAEO/nS8f7*bX*osE9cs9U2D61xGHu5goQ8pwLFaHJnJZHNU!/b/dL8AAAAAAAAA&bo=yADIAAAAAAACJwM!&rf=viewer_4"></img><br></center><br></html>

<p><br><br><br><br><br><br><br></p>
<center>————————–》》》一条华丽的结束线《《《————————–<br></center><br><br><br><br><br>await!await!!await!!!<br><center><br>    <img width="200" src="http://b190.photo.store.qq.com/psb?/V12x89qA2LlAEO/R3rpwlihgpSoxQnp92BPYp65Iryts4TmYoZemDikX1U!/b/dL4AAAAAAAAA&bo=8ADwAAAAAAARBzA!&rf=viewer_4"></img><br></center><br>好奇的小伙伴肯定注意到我们古怪的队名，下面就是我们团队和业务的简单介绍，欢迎关注：<br><br><br>&gt; 加班熊工作室，国内精品AI语音游戏开创者，打造有趣好玩多元化语音交互游戏，在各大智能音箱平台天猫精灵、小度和小度在家、小爱同学上线语音技能数量达10+，积累玩家达一千多万，部分爆款游戏有女生追求手册、约会大作战、恐怖嫌疑人、恐怖陌生人、喜剧之王…赶快上音箱上玩玩吧！<br><br><center><br>    <img src="http://b320.photo.store.qq.com/psb?/V12x89qA2LlAEO/rfwmg.Xm7*..V1vL41h84cYLFHoKAtwazaoIvnueRsI!/b/dEABAAAAAAAA&bo=UQHfAAAAAAADB60!&rf=viewer_4"></img><br></center>


<center>————————–》》》一条真正的结束线《《《————————–<br></center>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://pic1.win4000.com/wallpaper/2017-11-08/5a029f187ca9f.jpg&quot; alt=&quot;我是图片&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="前端" scheme="https://laoleo.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="工作日记" scheme="https://laoleo.github.io/categories/%E5%89%8D%E7%AB%AF/%E5%B7%A5%E4%BD%9C%E6%97%A5%E8%AE%B0/"/>
    
    
  </entry>
  
</feed>
